<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Geography Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Document parsing libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase client for direct storage uploads -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        // Supabase client for direct uploads (anon key is safe to expose)
        const SUPABASE_URL = 'https://wamzijrgngnvuzczxoqx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXppanJnbmdudnV6Y3p4b3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMDkwNTEsImV4cCI6MjA4Mzc4NTA1MX0.aURdBDJwdRhFlqm6bArvOtSlNA9IZ8AM-sdtwSu7Pc0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           THEME SYSTEM - Navy/Cream/Gold
           ============================================ */
        :root {
            /* Light mode (default) */
            --color-bg: #F5F5EB;
            --color-bg-alt: #ECEADF;
            --color-surface: #FFFFFF;
            --color-surface-hover: #FAFAF7;
            --color-primary: #1B1F5E;
            --color-primary-light: #2D3282;
            --color-accent: #D4A017;
            --color-accent-light: #E8B923;
            --color-accent-glow: rgba(212, 160, 23, 0.3);
            --color-success: #2D6A4F;
            --color-success-light: #40C9A2;
            --color-error: #C53030;
            --color-error-light: #FC8181;
            --color-text: #1B1F5E;
            --color-text-secondary: #4A5568;
            --color-text-muted: #718096;
            --color-border: #D1CFC4;
            --color-border-light: #E8E6DC;
            --shadow-sm: 0 1px 2px rgba(27, 31, 94, 0.05);
            --shadow-md: 0 4px 6px rgba(27, 31, 94, 0.07), 0 2px 4px rgba(27, 31, 94, 0.05);
            --shadow-lg: 0 10px 15px rgba(27, 31, 94, 0.1), 0 4px 6px rgba(27, 31, 94, 0.05);
            --shadow-glow: 0 0 20px rgba(212, 160, 23, 0.3);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        [data-theme="dark"] {
            --color-bg: #0C0C0F;
            --color-bg-alt: #131316;
            --color-surface: #1A1A1F;
            --color-surface-hover: #222228;
            --color-primary: #1B1F5E;
            --color-primary-light: #2D3282;
            --color-accent: #D4A017;
            --color-accent-light: #E8B923;
            --color-accent-glow: rgba(212, 160, 23, 0.35);
            --color-success: #34D399;
            --color-success-light: #6EE7B7;
            --color-error: #F87171;
            --color-error-light: #FCA5A5;
            --color-text: #F0F0F0;
            --color-text-secondary: #A0A0A0;
            --color-text-muted: #6B6B6B;
            --color-border: #2A2A30;
            --color-border-light: #38383F;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5), 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(212, 160, 23, 0.3);
            --glass-bg: rgba(26, 26, 31, 0.9);
            --glass-border: rgba(56, 56, 63, 0.6);
        }

        /* Base styles */
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Headings with Playfair Display for elegance */
        .font-display { font-family: 'Playfair Display', serif; }

        /* Theme transition for smooth switching */
        .theme-transition,
        .theme-transition *,
        .theme-transition *::before,
        .theme-transition *::after {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease !important;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg-alt); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-text-muted); }

        /* Card styles */
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }
        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--color-accent);
        }
        .card-flat {
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 20px;
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.5rem;
            font-weight: 500;
            border-radius: 9999px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        .btn-primary {
            background: var(--color-primary);
            color: var(--color-bg);
        }
        .btn-primary:hover {
            background: var(--color-primary-light);
            box-shadow: var(--shadow-md);
        }
        .btn-accent {
            background: var(--color-accent);
            color: var(--color-primary);
        }
        .btn-accent:hover {
            background: var(--color-accent-light);
            box-shadow: var(--shadow-glow);
        }
        .btn-ghost {
            background: transparent;
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        .btn-ghost:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-primary);
        }

        /* Input styles */
        .input {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 9999px;
            padding: 0.625rem 1.25rem;
            color: var(--color-text);
            transition: all 0.2s ease;
            width: 100%;
        }
        .input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px var(--color-accent-glow);
        }
        .input::placeholder {
            color: var(--color-text-muted);
        }

        /* Glass effect for modals */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        /* Line-art icon style base */
        .icon-line {
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Flip card styles */
        .flip-card { perspective: 1000px; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { backface-visibility: hidden; }
        .flip-card-back { transform: rotateY(180deg); }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px var(--color-accent-glow); }
            50% { box-shadow: 0 0 20px var(--color-accent-glow); }
        }
        @keyframes caret-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        .animate-float-up { animation: floatUp 1s ease-out forwards; }
        .animate-pulse-glow { animation: pulse-glow 1.5s ease-in-out infinite; }
        .caret-blink { animation: caret-blink 1s step-end infinite; }
        .animate-shimmer {
            background: linear-gradient(90deg, var(--color-border-light) 25%, var(--color-surface) 50%, var(--color-border-light) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Nav link active indicator */
        .nav-link-active {
            position: relative;
        }
        .nav-link-active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            background: var(--color-accent);
            border-radius: 2px;
        }

        /* Respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus visible for accessibility */
        :focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="min-h-screen" style="background-color: var(--color-bg); color: var(--color-text);">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useRef, useCallback, useMemo } = React;

        // API Base URL
        const API_URL = '/api';

        // Theme Context
        const ThemeContext = createContext({ theme: 'light', toggleTheme: () => {} });

        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => {
                const saved = localStorage.getItem('theme');
                if (saved) return saved;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            });

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                document.documentElement.classList.add('theme-transition');
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
                setTimeout(() => {
                    document.documentElement.classList.remove('theme-transition');
                }, 300);
            };

            return (
                <ThemeContext.Provider value={{ theme, toggleTheme }}>
                    {children}
                </ThemeContext.Provider>
            );
        }

        // Line-art SVG Icons
        const Icons = {
            globe: () => (
                <svg className="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <ellipse cx="12" cy="12" rx="4" ry="10"/>
                    <path d="M2 12h20"/>
                    <path d="M12 2c2.5 2.5 4 6 4 10s-1.5 7.5-4 10"/>
                    <path d="M12 2c-2.5 2.5-4 6-4 10s1.5 7.5 4 10"/>
                </svg>
            ),
            book: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    <path d="M8 7h8M8 11h6"/>
                </svg>
            ),
            document: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
            ),
            chart: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 20V10"/>
                    <path d="M12 20V4"/>
                    <path d="M6 20v-6"/>
                </svg>
            ),
            target: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="6"/>
                    <circle cx="12" cy="12" r="2"/>
                </svg>
            ),
            settings: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            ),
            sun: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            ),
            moon: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            ),
            user: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            ),
            logout: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            ),
            back: () => (
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
            ),
            mountain: () => (
                <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M8 3l4 8 5-5 7 15H0z"/>
                </svg>
            )
        };

        // Auth Context
        const AuthContext = createContext(null);

        // Typing Settings Context
        const TypingSettingsContext = createContext({
            enabled: true,
            memoryDuration: 5,
            stuckTimeout: 2,
            soundEnabled: true,
            ttsEnabled: true
        });

        // ============================================
        // AUDIO ENGINE - Synthesized sounds (no external assets)
        // ============================================
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.gainNode = null;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.ctx.createGain();
                    this.gainNode.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            playKeyClick() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'triangle';
                const baseFreq = 800 + Math.random() * 100;
                osc.frequency.setValueAtTime(baseFreq, t);
                osc.frequency.exponentialRampToValueAtTime(baseFreq / 2, t + 0.03);

                gain.gain.setValueAtTime(0.12, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.04);

                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start(t);
                osc.stop(t + 0.05);
            }

            playError() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(120, t);
                osc.frequency.linearRampToValueAtTime(80, t + 0.1);

                gain.gain.setValueAtTime(0.08, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);

                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start(t);
                osc.stop(t + 0.15);
            }

            playSuccessDing() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, t);
                osc.frequency.setValueAtTime(1046.50, t + 0.1);

                gain.gain.setValueAtTime(0.15, t);
                gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.8);

                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start(t);
                osc.stop(t + 0.8);
            }

            playPowerDing() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc1 = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc1.type = 'sine';
                osc2.type = 'triangle';

                osc1.frequency.setValueAtTime(880, t);
                osc1.frequency.linearRampToValueAtTime(1760, t + 0.1);
                osc2.frequency.setValueAtTime(1108, t);
                osc2.frequency.linearRampToValueAtTime(2217, t + 0.1);

                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.0001, t + 1);

                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(this.gainNode);

                osc1.start(t);
                osc2.start(t);
                osc1.stop(t + 1);
                osc2.stop(t + 1);
            }

            playVictory() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const notes = [523.25, 659.25, 783.99, 1046.50];

                notes.forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const noteGain = this.ctx.createGain();

                    osc.type = 'square';
                    osc.frequency.setValueAtTime(freq, t + i * 0.1);

                    noteGain.gain.setValueAtTime(0, t + i * 0.1);
                    noteGain.gain.linearRampToValueAtTime(0.08, t + i * 0.1 + 0.05);
                    noteGain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.1 + 0.4);

                    osc.connect(noteGain);
                    noteGain.connect(this.gainNode);

                    osc.start(t + i * 0.1);
                    osc.stop(t + i * 0.1 + 0.5);
                });
            }

            speak(text) {
                if (!('speechSynthesis' in window)) return;
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;

                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v =>
                    (v.name.includes('Google') || v.name.includes('Premium') || v.name.includes('Daniel') || v.name.includes('Samantha'))
                    && v.lang.startsWith('en')
                );
                if (preferredVoice) utterance.voice = preferredVoice;

                window.speechSynthesis.speak(utterance);
            }

            cancelSpeech() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            }
        }

        const audioEngine = new AudioEngine();

        // Encouragement phrases
        const ENCOURAGEMENT_PHRASES = [
            "NAILED IT!", "GEOGRAPHY MASTER!", "BRILLIANT!",
            "EXAM READY!", "LOCKED IN!", "WORD PERFECT!",
            "DEFINITION CRUSHED!", "STELLAR!", "TOP MARKS!"
        ];

        // ============================================
        // TYPING PRACTICE COMPONENT
        // ============================================
        function TypingPractice({
            text,
            onComplete,
            onCancel,
            settings = {},
            label = "Definition"
        }) {
            const { theme } = useContext(ThemeContext);
            const {
                memoryDuration = 5,
                stuckTimeout = 2,
                soundEnabled = true,
                ttsEnabled = true
            } = settings;

            const [input, setInput] = useState('');
            const [isTextVisible, setIsTextVisible] = useState(true);
            const [timeLeft, setTimeLeft] = useState(memoryDuration);
            const [hintEndIndex, setHintEndIndex] = useState(-1);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [isComplete, setIsComplete] = useState(false);

            const inputRef = useRef(null);
            const cursorRef = useRef(null);

            // TTS on mount
            useEffect(() => {
                if (ttsEnabled && text) {
                    setTimeout(() => audioEngine.speak(text), 300);
                }
                return () => audioEngine.cancelSpeech();
            }, [text, ttsEnabled]);

            // Countdown timer
            useEffect(() => {
                if (!isTextVisible || isComplete) return;

                const interval = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            setIsTextVisible(false);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(interval);
            }, [isTextVisible, isComplete]);

            // Stuck detection - reveal hint
            useEffect(() => {
                if (isComplete || input.length >= text.length) return;

                // Reset hint if user progressed past it
                if (hintEndIndex !== -1 && input.length >= hintEndIndex) {
                    setHintEndIndex(-1);
                }

                const timer = setTimeout(() => {
                    const spaceIndex = text.indexOf(' ', input.length);
                    const nextWordEnd = spaceIndex === -1 ? text.length : spaceIndex + 1;
                    setHintEndIndex(nextWordEnd);
                }, stuckTimeout * 1000);

                return () => clearTimeout(timer);
            }, [input, text, stuckTimeout, hintEndIndex, isComplete]);

            // Focus management
            useEffect(() => {
                inputRef.current?.focus();
                const interval = setInterval(() => {
                    if (inputRef.current && document.activeElement !== inputRef.current && !isComplete) {
                        inputRef.current.focus();
                    }
                }, 500);
                return () => clearInterval(interval);
            }, [isComplete]);

            const triggerFloatingText = (text) => {
                const id = Date.now();
                setFloatingTexts(prev => [...prev, { id, text }]);
                setTimeout(() => {
                    setFloatingTexts(prev => prev.filter(ft => ft.id !== id));
                }, 1000);
            };

            const handleInputChange = (e) => {
                const val = e.target.value;
                const isAdding = val.length > input.length;

                // Hide text on first keystroke
                if (isTextVisible && val.length > 0) {
                    setIsTextVisible(false);
                }

                if (isAdding) {
                    const charIndex = val.length - 1;
                    const expectedChar = text[charIndex];
                    const typedChar = val[charIndex];

                    if (expectedChar === typedChar) {
                        if (soundEnabled) audioEngine.playKeyClick();
                    } else {
                        if (soundEnabled) audioEngine.playError();
                    }
                }

                setInput(val);

                // Check completion
                if (val === text) {
                    setIsComplete(true);
                    if (soundEnabled) audioEngine.playSuccessDing();

                    triggerFloatingText(ENCOURAGEMENT_PHRASES[Math.floor(Math.random() * ENCOURAGEMENT_PHRASES.length)]);

                    // Fire confetti
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.7 },
                        colors: ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899']
                    });

                    setTimeout(() => onComplete && onComplete(), 1500);
                }
            };

            const handleReshow = () => {
                setIsTextVisible(true);
                setTimeLeft(memoryDuration);
                inputRef.current?.focus();
            };

            const renderText = () => {
                return text.split('').map((char, index) => {
                    const typedChar = input[index];
                    let className = "transition-all duration-200 ";
                    let inlineStyle = {};

                    if (typedChar == null) {
                        // Untyped
                        const isHint = index < hintEndIndex;
                        if (!isTextVisible && !isHint) {
                            className += "opacity-0 blur-sm select-none";
                            inlineStyle = { color: 'var(--color-text-muted)' };
                        } else if (isHint) {
                            className += "text-yellow-500 opacity-100 animate-pulse";
                        } else {
                            className += "opacity-60";
                            inlineStyle = { color: 'var(--color-text-muted)' };
                        }
                    } else if (typedChar === char) {
                        className += "text-green-500 font-medium";
                    } else {
                        className += "rounded";
                        inlineStyle = {
                            color: theme === 'dark' ? '#FCA5A5' : '#EF4444',
                            background: theme === 'dark' ? 'rgba(239, 68, 68, 0.2)' : '#FEE2E2'
                        };
                    }

                    const isCursor = index === input.length;

                    return (
                        <span key={index} ref={isCursor ? cursorRef : null} className={`relative ${className}`} style={inlineStyle}>
                            {isCursor && (
                                <span className="absolute -left-px top-0 w-0.5 h-full bg-green-500 caret-blink" />
                            )}
                            {char}
                        </span>
                    );
                });
            };

            return (
                <div className="relative">
                    {/* Floating encouragement texts */}
                    {floatingTexts.map(ft => (
                        <div
                            key={ft.id}
                            className="absolute left-1/2 -translate-x-1/2 top-0 z-50 pointer-events-none animate-float-up"
                        >
                            <span className="text-2xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
                                {ft.text}
                            </span>
                        </div>
                    ))}

                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">‚å®Ô∏è</span>
                            <span className="font-semibold" style={{ color: 'var(--color-text)' }}>Type to Memorize</span>
                        </div>
                        <div className="flex items-center gap-3">
                            {isTextVisible && !isComplete && (
                                <span
                                    className="text-sm font-mono px-3 py-1 rounded-full"
                                    style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text-secondary)' }}
                                >
                                    ‚è±Ô∏è {timeLeft}s
                                </span>
                            )}
                            {!isTextVisible && !isComplete && (
                                <button
                                    onClick={handleReshow}
                                    className="text-sm px-3 py-1 rounded-full transition flex items-center gap-1"
                                    style={{
                                        background: theme === 'dark' ? 'rgba(234, 179, 8, 0.2)' : '#FEF9C3',
                                        color: '#CA8A04'
                                    }}
                                >
                                    üëÅÔ∏è Peek
                                </button>
                            )}
                            <button
                                onClick={onCancel}
                                className="transition"
                                style={{ color: 'var(--color-text-muted)' }}
                            >
                                ‚úï
                            </button>
                        </div>
                    </div>

                    {/* Label */}
                    <div className="text-xs uppercase tracking-wider mb-2" style={{ color: 'var(--color-text-muted)' }}>{label}</div>

                    {/* Typing area */}
                    <div
                        className="relative rounded-xl p-6 border-2 transition-all cursor-text"
                        style={{
                            background: 'var(--color-bg-alt)',
                            borderColor: isComplete ? 'var(--color-success)' : 'var(--color-border)'
                        }}
                        onClick={() => inputRef.current?.focus()}
                    >
                        <div className="text-lg leading-relaxed font-serif min-h-[60px]" style={{ color: 'var(--color-text)' }}>
                            {renderText()}
                            {input.length === text.length && !isComplete && (
                                <span className="inline-block w-0.5 h-5 bg-green-500 caret-blink align-middle ml-0.5" />
                            )}
                        </div>

                        {/* Hidden input */}
                        <input
                            ref={inputRef}
                            type="text"
                            value={input}
                            onChange={handleInputChange}
                            className="absolute inset-0 opacity-0 cursor-text"
                            autoFocus
                            spellCheck={false}
                            autoComplete="off"
                            disabled={isComplete}
                        />
                    </div>

                    {/* Progress bar */}
                    <div className="mt-4 flex items-center gap-3">
                        <div className="flex-1 rounded-full h-2 overflow-hidden" style={{ background: 'var(--color-border)' }}>
                            <div
                                className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all duration-150"
                                style={{ width: `${(input.length / text.length) * 100}%` }}
                            />
                        </div>
                        <span className="text-sm font-mono" style={{ color: 'var(--color-text-muted)' }}>
                            {input.length}/{text.length}
                        </span>
                    </div>

                    {/* Completion message */}
                    {isComplete && (
                        <div className="mt-4 text-center animate-fade-in-up">
                            <span className="font-semibold" style={{ color: 'var(--color-success)' }}>‚úÖ Perfect! Definition memorized!</span>
                        </div>
                    )}
                </div>
            );
        }

        // API Helper
        const api = {
            token: localStorage.getItem('token'),

            async request(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json' };
                if (this.token) headers['Authorization'] = `Bearer ${this.token}`;

                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });

                if (response.status === 401) {
                    this.token = null;
                    localStorage.removeItem('token');
                    window.location.reload();
                    return null;
                }

                return response.json();
            },

            get: (endpoint) => api.request(endpoint),
            post: (endpoint, data) => api.request(endpoint, { method: 'POST', body: JSON.stringify(data) }),
            put: (endpoint, data) => api.request(endpoint, { method: 'PUT', body: JSON.stringify(data) })
        };

        // Login Component
        function Login({ onLogin }) {
            const { theme } = useContext(ThemeContext);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const result = await api.post('/auth/login', { username, password });

                if (result?.token) {
                    api.token = result.token;
                    localStorage.setItem('token', result.token);
                    onLogin(result.user);
                } else {
                    setError('Invalid username or password');
                }
                setLoading(false);
            };

            return (
                <div
                    className="min-h-screen flex items-center justify-center"
                    style={{ backgroundColor: theme === 'dark' ? '#0C0C0F' : 'var(--color-primary)' }}
                >
                    {/* Background decoration */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none opacity-10">
                        <svg className="absolute top-10 left-10 w-64 h-64" viewBox="0 0 100 100" fill="none" stroke="currentColor" strokeWidth="0.5" style={{ color: 'var(--color-bg)' }}>
                            <circle cx="50" cy="50" r="40"/>
                            <ellipse cx="50" cy="50" rx="15" ry="40"/>
                            <path d="M10 50h80"/>
                            <path d="M50 10v80"/>
                        </svg>
                        <svg className="absolute bottom-10 right-10 w-48 h-48" viewBox="0 0 100 100" fill="none" stroke="currentColor" strokeWidth="0.5" style={{ color: 'var(--color-bg)' }}>
                            <path d="M10 80 L30 40 L50 60 L70 20 L90 80 Z"/>
                        </svg>
                    </div>

                    <div
                        className="relative p-8 rounded-3xl w-full max-w-md mx-4"
                        style={{
                            backgroundColor: 'var(--color-surface)',
                            boxShadow: 'var(--shadow-lg)',
                            border: '1px solid var(--color-border-light)'
                        }}
                    >
                        <div className="text-center mb-8">
                            <div className="mb-4" style={{ color: theme === 'dark' ? '#FFFFFF' : 'var(--color-primary)' }}>
                                <Icons.globe />
                            </div>
                            <h1 className="text-2xl font-display font-bold" style={{ color: 'var(--color-text)' }}>
                                Geography Guru
                            </h1>
                            <p style={{ color: 'var(--color-text-muted)' }}>IGCSE 0460 Study Companion</p>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                placeholder="Username"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="input mb-3"
                                autoComplete="username"
                            />
                            <input
                                type="password"
                                placeholder="Password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="input mb-4"
                                autoComplete="current-password"
                            />

                            {error && (
                                <p className="text-sm mb-4" style={{ color: 'var(--color-error)' }}>{error}</p>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="btn btn-accent w-full py-3 font-semibold disabled:opacity-50"
                            >
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>

                        <p className="text-center text-sm mt-6" style={{ color: 'var(--color-text-muted)' }}>
                            Default: gary / 1234
                        </p>
                    </div>
                </div>
            );
        }

        // ============================================================================
        // RAG Query Modal - Reusable "Talk to Documents" component
        // Can be used across Sample Exam Questions, Tips, Definitions, etc.
        // ============================================================================
        function RAGQueryModal({ isOpen, onClose, context, contextType, onNavigateToDocChat }) {
            const [documents, setDocuments] = useState([]);
            const [selectedDocs, setSelectedDocs] = useState([]);
            const [userQuestion, setUserQuestion] = useState('');
            const [loading, setLoading] = useState(true);
            const [settings, setSettings] = useState(null);
            const [modalDocSearch, setModalDocSearch] = useState(''); // Search filter for modal
            const [modalDocSort, setModalDocSort] = useState('name-asc'); // Sort: name-asc (default A-Z)

            // Filter and sort documents
            const filteredModalDocs = useMemo(() => {
                let filtered = documents;
                if (modalDocSearch) {
                    filtered = documents.filter(doc =>
                        doc.original_filename.toLowerCase().includes(modalDocSearch.toLowerCase())
                    );
                }

                // Sort the filtered results
                filtered = [...filtered].sort((a, b) => {
                    switch (modalDocSort) {
                        case 'name-asc':
                            return a.original_filename.localeCompare(b.original_filename);
                        case 'name-desc':
                            return b.original_filename.localeCompare(a.original_filename);
                        case 'date-newest':
                            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                        case 'date-oldest':
                            return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                        case 'pages-most':
                            return (b.page_count || 0) - (a.page_count || 0);
                        case 'pages-least':
                            return (a.page_count || 0) - (b.page_count || 0);
                        default:
                            return 0;
                    }
                });

                return filtered;
            }, [documents, modalDocSearch, modalDocSort]);

            // Context type labels
            const contextLabels = {
                'sample_question': 'Sample Exam Question',
                'tip': 'Study Tip',
                'common_error': 'Common Error',
                'definition': 'Definition',
                'teacher_definition': 'Teacher\'s Terminology',
                'case_study': 'Case Study',
                'general': 'Content'
            };

            // Get the display text from context based on type
            const getContextDisplayText = () => {
                if (!context) return '';
                if (contextType === 'sample_question') return context.question || '';
                if (contextType === 'tip') return context.text || '';
                if (contextType === 'common_error') return context.error || '';
                if (contextType === 'definition') return `${context.term}: ${context.definition}`;
                if (contextType === 'teacher_definition') return `${context.term}: ${context.definition}`;
                return context.text || String(context);
            };

            // Load documents and settings on open (use ai_settings for API keys - same as main Settings)
            useEffect(() => {
                if (isOpen) {
                    setLoading(true);
                    // Pre-fill userQuestion with context text
                    setUserQuestion(getContextDisplayText());
                    Promise.all([
                        api.get('/pdf/documents'),
                        api.get('/ai/settings')
                    ]).then(([docs, aiSettingsData]) => {
                        const readyDocs = (docs || []).filter(d => d.status === 'ready');
                        setDocuments(readyDocs);
                        setSettings(aiSettingsData?.settings || {});
                        // Auto-select all ready documents
                        setSelectedDocs(readyDocs.map(d => d.id));
                        setLoading(false);
                    });
                }
            }, [isOpen, context, contextType]);

            const toggleDoc = (docId) => {
                setSelectedDocs(prev =>
                    prev.includes(docId)
                        ? prev.filter(id => id !== docId)
                        : [...prev, docId]
                );
            };

            const selectAll = () => setSelectedDocs(filteredModalDocs.map(d => d.id));
            const deselectAll = () => setSelectedDocs([]);
            const selectFiltered = () => {
                const filteredIds = filteredModalDocs.map(d => d.id);
                setSelectedDocs(prev => [...new Set([...prev, ...filteredIds])]);
            };

            const handleSubmit = () => {
                if (selectedDocs.length === 0) {
                    alert('Please select at least one document');
                    return;
                }

                if (!onNavigateToDocChat) {
                    alert('Navigation not available. Please go to Document Chat directly.');
                    return;
                }

                // Use the user's question directly (already pre-filled with context)
                const query = userQuestion.trim() || getContextDisplayText();

                // Navigate to Document Chat with prefilled data - auto-submits there
                onNavigateToDocChat({
                    question: query,
                    documentIds: selectedDocs
                });
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 flex items-center justify-center z-50" style={{ background: 'rgba(13, 16, 51, 0.7)', backdropFilter: 'blur(4px)' }}>
                    <div
                        className="glass w-11/12 max-w-4xl max-h-[90vh] flex flex-col rounded-3xl overflow-hidden animate-fade-in-up"
                        style={{ boxShadow: 'var(--shadow-lg)' }}
                    >
                        {/* Header */}
                        <div
                            className="p-5 flex items-center justify-between"
                            style={{ background: 'linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%)' }}
                        >
                            <div className="flex items-center gap-3">
                                <div className="p-2 rounded-full" style={{ background: 'rgba(212, 160, 23, 0.2)' }}>
                                    <Icons.document />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold font-display" style={{ color: '#F5F5EB' }}>Talk to Documents</h3>
                                    <p className="text-sm" style={{ color: 'var(--color-accent)' }}>
                                        Get more context from your study materials
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={onClose}
                                className="p-2 rounded-full transition-colors"
                                style={{ color: '#F5F5EB' }}
                                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                                onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                            >
                                <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-5" style={{ background: 'var(--color-surface)' }}>
                            {loading ? (
                                <div className="text-center py-8">
                                    <div className="inline-block w-8 h-8 border-3 border-t-transparent rounded-full animate-spin" style={{ borderColor: 'var(--color-accent)', borderTopColor: 'transparent' }}></div>
                                    <p className="mt-4" style={{ color: 'var(--color-text-muted)' }}>Loading documents...</p>
                                </div>
                            ) : documents.length === 0 ? (
                                <div className="text-center py-8">
                                    <Icons.document />
                                    <p className="mt-2" style={{ color: 'var(--color-text-muted)' }}>No documents uploaded yet.</p>
                                    <p className="text-sm mt-1" style={{ color: 'var(--color-text-muted)' }}>
                                        Go to Document Chat to upload your study guides first.
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-5">
                                    {/* Context Preview */}
                                    <div className="p-4 rounded-lg" style={{ background: 'rgba(212, 160, 23, 0.1)', border: '1px solid var(--color-accent)' }}>
                                        <p className="text-xs font-semibold uppercase tracking-wider mb-1" style={{ color: 'var(--color-accent)' }}>
                                            {contextLabels[contextType] || 'Context'}
                                        </p>
                                        <p className="text-sm line-clamp-3" style={{ color: 'var(--color-text-secondary)' }}>
                                            {contextType === 'sample_question' ? context.question :
                                             contextType === 'tip' ? context.text :
                                             contextType === 'common_error' ? context.error :
                                             contextType === 'definition' ? `${context.term}: ${context.definition}` :
                                             contextType === 'teacher_definition' ? `${context.term}: ${context.definition}` :
                                             (context.text || String(context)).substring(0, 200)}...
                                        </p>
                                    </div>

                                    {/* Document Selection */}
                                    <div>
                                        <div className="flex items-center justify-between mb-2">
                                            <p className="font-medium" style={{ color: 'var(--color-text)' }}>Select documents to search:</p>
                                            <div className="flex gap-2">
                                                <button onClick={selectAll} className="btn btn-ghost text-xs py-1 px-2">Select All</button>
                                                <button onClick={deselectAll} className="btn btn-ghost text-xs py-1 px-2">Deselect</button>
                                            </div>
                                        </div>

                                        {/* Search Filter and Sort */}
                                        <div className="flex gap-2 mb-2">
                                            {documents.length > 5 && (
                                                <div className="relative flex-1">
                                                    <svg className="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4" style={{ color: 'var(--color-text-muted)' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                    </svg>
                                                    <input
                                                        type="text"
                                                        placeholder="Filter documents..."
                                                        value={modalDocSearch}
                                                        onChange={(e) => setModalDocSearch(e.target.value)}
                                                        className="w-full pl-8 pr-8 py-1.5 text-sm rounded-lg"
                                                        style={{
                                                            background: 'var(--color-bg)',
                                                            border: '1px solid var(--color-border-light)',
                                                            color: 'var(--color-text)'
                                                        }}
                                                    />
                                                    {modalDocSearch && (
                                                        <button
                                                            onClick={() => setModalDocSearch('')}
                                                            className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 rounded"
                                                            style={{ color: 'var(--color-text-muted)' }}
                                                        >
                                                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                            </svg>
                                                        </button>
                                                    )}
                                                </div>
                                            )}
                                            <select
                                                value={modalDocSort}
                                                onChange={(e) => setModalDocSort(e.target.value)}
                                                className={`${documents.length > 5 ? 'w-40' : 'w-full'} px-2 py-1.5 text-xs rounded-lg`}
                                                style={{
                                                    background: 'var(--color-bg)',
                                                    border: '1px solid var(--color-border-light)',
                                                    color: 'var(--color-text)'
                                                }}
                                            >
                                                <option value="name-asc">Sort: Name (A‚ÜíZ)</option>
                                                <option value="name-desc">Sort: Name (Z‚ÜíA)</option>
                                                <option value="date-newest">Sort: Newest First</option>
                                                <option value="date-oldest">Sort: Oldest First</option>
                                                <option value="pages-most">Sort: Most Pages</option>
                                                <option value="pages-least">Sort: Fewest Pages</option>
                                            </select>
                                        </div>

                                        <div
                                            className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto rounded-lg p-2"
                                            style={{ background: 'var(--color-bg)', border: '1px solid var(--color-border-light)', scrollbarWidth: 'thin' }}
                                        >
                                            {filteredModalDocs.length === 0 ? (
                                                <p className="col-span-2 text-sm text-center py-3" style={{ color: 'var(--color-text-muted)' }}>
                                                    {modalDocSearch ? `No documents match "${modalDocSearch}"` : 'No documents available'}
                                                </p>
                                            ) : (
                                                filteredModalDocs.map(doc => (
                                                    <label
                                                        key={doc.id}
                                                        className="flex items-center gap-2 p-2 rounded-lg cursor-pointer transition"
                                                        style={{
                                                            background: selectedDocs.includes(doc.id) ? 'rgba(212, 160, 23, 0.15)' : 'var(--color-surface)',
                                                            border: selectedDocs.includes(doc.id) ? '1px solid var(--color-accent)' : '1px solid var(--color-border-light)'
                                                        }}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedDocs.includes(doc.id)}
                                                            onChange={() => toggleDoc(doc.id)}
                                                            className="h-4 w-4 rounded"
                                                            style={{ accentColor: 'var(--color-accent)' }}
                                                        />
                                                        <span className="text-sm truncate" style={{ color: 'var(--color-text)' }}>{doc.original_filename}</span>
                                                    </label>
                                                ))
                                            )}
                                        </div>
                                        <p className="text-xs mt-1" style={{ color: 'var(--color-text-muted)' }}>
                                            {selectedDocs.length} of {documents.length} selected
                                            {modalDocSearch && ` (showing ${filteredModalDocs.length})`}
                                        </p>
                                    </div>

                                    {/* Optional User Question */}
                                    <div>
                                        <p className="font-medium mb-2" style={{ color: 'var(--color-text)' }}>Your question (optional):</p>
                                        <textarea
                                            value={userQuestion}
                                            onChange={(e) => setUserQuestion(e.target.value)}
                                            placeholder="Enter a question to search your documents..."
                                            className="input resize-none"
                                            rows={2}
                                        />
                                    </div>

                                    {/* Submit Button */}
                                    <button
                                        onClick={handleSubmit}
                                        disabled={selectedDocs.length === 0}
                                        className="btn btn-accent w-full py-3 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                        Search in Document Chat
                                    </button>
                                    <p className="text-xs text-center" style={{ color: 'var(--color-text-muted)' }}>
                                        Opens Document Chat and automatically searches
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="p-3" style={{ background: 'var(--color-bg-alt)', borderTop: '1px solid var(--color-border-light)' }}>
                            <p className="text-xs text-center" style={{ color: 'var(--color-text-muted)' }}>
                                Powered by RAG ‚Ä¢ Searches your uploaded study materials
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // Navigation Component
        function Navigation({ user, currentView, setCurrentView, onLogout }) {
            const { theme, toggleTheme } = useContext(ThemeContext);

            const navItems = [
                { id: 'topics', label: 'Topics', icon: Icons.book },
                { id: 'pdf-chat', label: 'Documents', icon: Icons.document },
                { id: 'progress', label: 'Progress', icon: Icons.chart },
                { id: 'weak-points', label: 'Focus Areas', icon: Icons.target },
                { id: 'settings', label: 'Settings', icon: Icons.settings }
            ];

            return (
                <nav style={{
                    backgroundColor: theme === 'dark' ? '#1A1A1F' : 'var(--color-primary)',
                    boxShadow: 'var(--shadow-lg)',
                    borderBottom: theme === 'dark' ? '1px solid #2A2A30' : 'none'
                }}>
                    <div className="max-w-7xl mx-auto px-4 lg:px-8">
                        <div className="flex justify-between items-center py-3">
                            {/* Logo */}
                            <div className="flex items-center space-x-3" style={{ color: '#FFFFFF' }}>
                                <Icons.globe />
                                <div>
                                    <span className="text-xl font-display font-bold tracking-tight">Geography Guru</span>
                                    <span className="hidden sm:inline text-xs ml-2 opacity-80">IGCSE</span>
                                </div>
                            </div>

                            {/* Nav Items */}
                            <div className="flex items-center space-x-1 lg:space-x-2">
                                {navItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setCurrentView(item.id)}
                                        className={`flex items-center space-x-2 px-3 lg:px-4 py-2 rounded-full transition-all duration-200 ${
                                            currentView === item.id ? 'nav-link-active' : ''
                                        }`}
                                        style={{
                                            color: currentView === item.id ? 'var(--color-accent)' : '#FFFFFF',
                                            backgroundColor: currentView === item.id ? 'rgba(212, 160, 23, 0.15)' : 'transparent',
                                            opacity: currentView === item.id ? 1 : 0.9
                                        }}
                                    >
                                        <item.icon />
                                        <span className="hidden lg:inline text-sm font-medium">{item.label}</span>
                                    </button>
                                ))}

                                {/* Divider */}
                                <div className="w-px h-8 mx-2" style={{ backgroundColor: 'rgba(245, 245, 235, 0.2)' }} />

                                {/* Theme Toggle */}
                                <button
                                    onClick={toggleTheme}
                                    className="p-2 rounded-full transition-all duration-200 hover:opacity-100"
                                    style={{ color: '#FFFFFF', opacity: 0.9 }}
                                    title={theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode'}
                                >
                                    {theme === 'light' ? <Icons.moon /> : <Icons.sun />}
                                </button>

                                {/* User Menu */}
                                <div className="flex items-center space-x-2 ml-2" style={{ color: '#FFFFFF' }}>
                                    <div className="hidden sm:flex items-center space-x-2 opacity-90">
                                        <Icons.user />
                                        <span className="text-sm">{user.display_name}</span>
                                    </div>
                                    <button
                                        onClick={onLogout}
                                        className="p-2 rounded-full transition-all duration-200 hover:opacity-100"
                                        style={{ color: 'var(--color-accent)', opacity: 0.85 }}
                                        title="Logout"
                                    >
                                        <Icons.logout />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        }

        // Topics List Component
        function TopicsList({ onSelectTopic }) {
            const { theme } = useContext(ThemeContext);
            const [themes, setThemes] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/topics').then(data => {
                    setThemes(data || []);
                    setLoading(false);
                });
            }, []);

            if (loading) return (
                <div className="text-center py-12" style={{ color: 'var(--color-text-secondary)' }}>
                    <div className="animate-shimmer h-8 w-48 mx-auto rounded mb-4"></div>
                    <p>Loading topics...</p>
                </div>
            );

            // Theme colors - charcoal in dark mode, navy in light mode
            const themeAccents = theme === 'dark' ? {
                1: { bg: '#1A1A1F', accent: '#D4A017' },  // Charcoal + Gold
                2: { bg: '#222228', accent: '#40C9A2' },  // Dark Charcoal + Teal
                3: { bg: '#1A1A1F', accent: '#E8B923' },  // Charcoal + Bright Gold
                4: { bg: '#151518', accent: '#D4A017' }   // Darker Charcoal + Gold
            } : {
                1: { bg: '#1B1F5E', accent: '#D4A017' },  // Navy + Gold
                2: { bg: '#2D3282', accent: '#40C9A2' },  // Deep Blue + Teal
                3: { bg: '#1B1F5E', accent: '#E8B923' },  // Navy + Bright Gold
                4: { bg: '#141850', accent: '#D4A017' }   // Darker Navy + Gold
            };

            return (
                <div className="max-w-6xl mx-auto p-6 lg:p-8">
                    {/* Page Header */}
                    <div className="mb-8">
                        <h2 className="text-3xl font-display font-bold mb-2" style={{ color: 'var(--color-text)' }}>
                            Study Topics
                        </h2>
                        <p style={{ color: 'var(--color-text-secondary)' }}>
                            Select a topic to begin your revision
                        </p>
                    </div>

                    <div className="grid gap-6">
                        {themes.map(theme => {
                            const colors = themeAccents[theme.theme_number] || themeAccents[1];
                            return (
                                <div key={theme.theme_number} className="card overflow-hidden">
                                    {/* Theme Header */}
                                    <div
                                        className="p-4 lg:p-5"
                                        style={{
                                            backgroundColor: colors.bg,
                                            borderBottom: `3px solid ${colors.accent}`
                                        }}
                                    >
                                        <div className="flex items-center gap-3">
                                            <span
                                                className="text-sm font-bold px-3 py-1 rounded-full"
                                                style={{ backgroundColor: colors.accent, color: colors.bg }}
                                            >
                                                {theme.theme_number}
                                            </span>
                                            <h3 className="text-lg lg:text-xl font-semibold text-white">
                                                {theme.theme_name}
                                            </h3>
                                        </div>
                                    </div>

                                    {/* Topics Grid */}
                                    <div
                                        className="p-4 lg:p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"
                                        style={{ backgroundColor: 'var(--color-surface)' }}
                                    >
                                        {theme.topics.map(topic => (
                                            <button
                                                key={topic.id}
                                                onClick={() => onSelectTopic(topic)}
                                                className="p-4 rounded-lg text-left transition-all duration-200 group"
                                                style={{
                                                    backgroundColor: 'var(--color-bg)',
                                                    border: '1px solid var(--color-border-light)'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.currentTarget.style.borderColor = 'var(--color-accent)';
                                                    e.currentTarget.style.boxShadow = 'var(--shadow-md)';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.currentTarget.style.borderColor = 'var(--color-border-light)';
                                                    e.currentTarget.style.boxShadow = 'none';
                                                }}
                                            >
                                                <span
                                                    className="font-semibold text-sm"
                                                    style={{ color: 'var(--color-accent)' }}
                                                >
                                                    {topic.topic_number}
                                                </span>
                                                <span
                                                    className="ml-2 text-sm"
                                                    style={{ color: 'var(--color-text)' }}
                                                >
                                                    {topic.topic_name}
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Topic Detail Component
        function TopicDetail({ topic, onBack, typingSettings, onNavigateToDocChat }) {
            const { theme } = useContext(ThemeContext);
            const [data, setData] = useState(null);
            const [teacherDefs, setTeacherDefs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('learn');
            const [startIndex, setStartIndex] = useState(0);
            // RAG modal state
            const [ragModalOpen, setRagModalOpen] = useState(false);
            const [ragContext, setRagContext] = useState(null);
            const [ragContextType, setRagContextType] = useState('general');

            useEffect(() => {
                Promise.all([
                    api.get(`/topics/${topic.id}`),
                    api.get(`/teacher-definitions/${topic.topic_number}`)
                ]).then(([topicResult, teacherResult]) => {
                    setData(topicResult);
                    setTeacherDefs(teacherResult || []);
                    setLoading(false);
                });
            }, [topic.id, topic.topic_number]);

            // Navigation helper to jump to a specific item in a tab
            const navigateTo = (tabId, index = 0) => {
                setStartIndex(index);
                setActiveTab(tabId);
            };

            // RAG modal helper
            const openRAGModal = (context, contextType) => {
                setRagContext(context);
                setRagContextType(contextType);
                setRagModalOpen(true);
            };

            if (loading) return (
                <div className="text-center py-12">
                    <div className="inline-block w-8 h-8 border-3 border-t-transparent rounded-full animate-spin" style={{ borderColor: 'var(--color-accent)', borderTopColor: 'transparent' }}></div>
                    <p className="mt-4" style={{ color: 'var(--color-text-muted)' }}>Loading topic...</p>
                </div>
            );

            const tabs = [
                { id: 'learn', label: 'Learn', icon: Icons.book },
                { id: 'flashcards', label: 'Flashcards', icon: () => (
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M12 8v8M8 12h8"/>
                    </svg>
                )},
                { id: 'test-yourself', label: 'Test', icon: () => (
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                )},
                { id: 'exam-practice', label: 'Exam', icon: Icons.document },
                { id: 'study-tips', label: 'Tips', icon: () => (
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        <circle cx="12" cy="12" r="4"/>
                    </svg>
                )},
                { id: 'quiz', label: 'Quiz', icon: () => (
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                        <path d="M2 2l7.586 7.586"/>
                        <circle cx="11" cy="11" r="2"/>
                    </svg>
                )}
            ];

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <button
                        onClick={onBack}
                        className="mb-4 flex items-center gap-2 font-medium transition-colors"
                        style={{ color: 'var(--color-accent)' }}
                        onMouseEnter={(e) => e.currentTarget.style.color = 'var(--color-accent-light)'}
                        onMouseLeave={(e) => e.currentTarget.style.color = 'var(--color-accent)'}
                    >
                        <Icons.back /> Back to Topics
                    </button>

                    <div className="card overflow-hidden">
                        {/* Topic Header */}
                        <div className="p-6" style={{ background: theme === 'dark' ? 'linear-gradient(135deg, #1A1A1F 0%, #222228 100%)' : 'linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%)' }}>
                            <div className="flex items-center gap-4">
                                <div className="p-3 rounded-full" style={{ background: 'rgba(212, 160, 23, 0.2)' }}>
                                    <Icons.globe />
                                </div>
                                <div>
                                    <span className="text-sm font-semibold uppercase tracking-wider" style={{ color: 'var(--color-accent)' }}>
                                        {topic.topic_number}
                                    </span>
                                    <h2 className="text-2xl font-bold font-display" style={{ color: '#F5F5EB' }}>
                                        {topic.topic_name}
                                    </h2>
                                </div>
                            </div>
                        </div>

                        {/* Tab Navigation */}
                        <div style={{ borderBottom: '1px solid var(--color-border-light)', background: 'var(--color-surface)' }}>
                            <div className="flex overflow-x-auto">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => { setStartIndex(0); setActiveTab(tab.id); }}
                                        className={`px-5 py-4 flex items-center gap-2 font-medium transition-all whitespace-nowrap relative ${
                                            activeTab === tab.id ? 'nav-link-active' : ''
                                        }`}
                                        style={{
                                            color: activeTab === tab.id ? 'var(--color-accent)' : 'var(--color-text-muted)',
                                            background: activeTab === tab.id ? 'var(--color-bg)' : 'transparent'
                                        }}
                                        onMouseEnter={(e) => {
                                            if (activeTab !== tab.id) e.currentTarget.style.color = 'var(--color-text)';
                                        }}
                                        onMouseLeave={(e) => {
                                            if (activeTab !== tab.id) e.currentTarget.style.color = 'var(--color-text-muted)';
                                        }}
                                    >
                                        <tab.icon />
                                        <span>{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-6" style={{ background: 'var(--color-bg)' }}>
                            {activeTab === 'learn' && <LearnTab data={data} teacherDefinitions={teacherDefs} onNavigate={navigateTo} onOpenRAG={openRAGModal} />}
                            {activeTab === 'flashcards' && <FlashcardsTab definitions={data?.definitions || []} teacherDefinitions={teacherDefs} topicId={topic.id} typingSettings={typingSettings} startIndex={startIndex} onStartIndexUsed={() => setStartIndex(0)} />}
                            {activeTab === 'test-yourself' && <TestYourselfTab topicCode={topic.topic_number} topicName={topic.topic_name} typingSettings={typingSettings} startIndex={startIndex} onStartIndexUsed={() => setStartIndex(0)} />}
                            {activeTab === 'exam-practice' && <ExamPracticeTab topicId={topic.id} topicName={topic.topic_name} onNavigateToDocChat={onNavigateToDocChat} />}
                            {activeTab === 'study-tips' && <StudyTipsTab topicId={topic.id} onNavigateToDocChat={onNavigateToDocChat} />}
                            {activeTab === 'quiz' && <QuizTab questions={data?.questions || []} topicId={topic.id} typingSettings={typingSettings} startIndex={startIndex} onStartIndexUsed={() => setStartIndex(0)} />}
                        </div>
                    </div>

                    {/* RAG Query Modal */}
                    {ragModalOpen && (
                        <RAGQueryModal
                            isOpen={ragModalOpen}
                            onClose={() => setRagModalOpen(false)}
                            context={ragContext}
                            contextType={ragContextType}
                            onNavigateToDocChat={onNavigateToDocChat}
                        />
                    )}
                </div>
            );
        }

        // Learn Tab Component
        function LearnTab({ data, teacherDefinitions = [], onNavigate, onOpenRAG }) {
            const { theme } = useContext(ThemeContext);
            const content = data?.content || {};
            const [activeSource, setActiveSource] = useState('study-guide'); // 'study-guide' or 'teacher'

            // Action button component for consistent styling
            const ActionButton = ({ onClick, title, children, variant = 'primary' }) => {
                const variants = {
                    primary: { bg: 'var(--color-primary)', color: '#F5F5EB', hoverBg: 'var(--color-primary-light)' },
                    accent: { bg: 'var(--color-accent)', color: 'var(--color-primary)', hoverBg: 'var(--color-accent-light)' },
                    success: { bg: 'var(--color-success)', color: '#F5F5EB', hoverBg: 'var(--color-success-light)' },
                    ghost: { bg: 'var(--color-bg-alt)', color: 'var(--color-text)', hoverBg: 'var(--color-border-light)' },
                    teacher: { bg: theme === 'dark' ? 'rgba(168, 85, 247, 0.2)' : '#F3E8FF', color: theme === 'dark' ? '#C4B5FD' : '#7C3AED', hoverBg: theme === 'dark' ? 'rgba(168, 85, 247, 0.3)' : '#EDE9FE' }
                };
                const v = variants[variant];
                return (
                    <button
                        onClick={onClick}
                        title={title}
                        className="px-2 py-1 text-xs rounded-md transition-all font-medium"
                        style={{ background: v.bg, color: v.color }}
                        onMouseEnter={(e) => e.currentTarget.style.background = v.hoverBg}
                        onMouseLeave={(e) => e.currentTarget.style.background = v.bg}
                    >
                        {children}
                    </button>
                );
            };

            const studyGuideDefs = data?.definitions || [];
            const hasTeacherDefs = teacherDefinitions.length > 0;
            const hasStudyGuideDefs = studyGuideDefs.length > 0;

            return (
                <div className="space-y-8">
                    {/* Source Toggle - Only show if both sources have content */}
                    {hasStudyGuideDefs && hasTeacherDefs && (
                        <div className="flex items-center justify-center gap-2 p-1 rounded-xl" style={{ background: 'var(--color-bg-alt)' }}>
                            <button
                                onClick={() => setActiveSource('study-guide')}
                                className="flex-1 px-4 py-2.5 rounded-lg font-medium transition-all flex items-center justify-center gap-2"
                                style={{
                                    background: activeSource === 'study-guide' ? 'var(--color-surface)' : 'transparent',
                                    color: activeSource === 'study-guide' ? 'var(--color-accent)' : 'var(--color-text-muted)',
                                    boxShadow: activeSource === 'study-guide' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
                                }}
                            >
                                <Icons.book />
                                <span>Study Guide ({studyGuideDefs.length})</span>
                            </button>
                            <button
                                onClick={() => setActiveSource('teacher')}
                                className="flex-1 px-4 py-2.5 rounded-lg font-medium transition-all flex items-center justify-center gap-2"
                                style={{
                                    background: activeSource === 'teacher' ? 'var(--color-surface)' : 'transparent',
                                    color: activeSource === 'teacher' ? (theme === 'dark' ? '#C4B5FD' : '#7C3AED') : 'var(--color-text-muted)',
                                    boxShadow: activeSource === 'teacher' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
                                }}
                            >
                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <span>Teacher's List ({teacherDefinitions.length})</span>
                            </button>
                        </div>
                    )}

                    {/* Key Definitions Section - Study Guide */}
                    {activeSource === 'study-guide' && hasStudyGuideDefs && (
                        <section>
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 rounded-lg" style={{ background: 'var(--color-primary)', color: 'var(--color-accent)' }}>
                                    <Icons.book />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold font-display" style={{ color: 'var(--color-text)' }}>Key Definitions</h3>
                                    <p className="text-sm" style={{ color: 'var(--color-text-muted)' }}>From Cambridge Study & Revision Guide</p>
                                </div>
                            </div>
                            <div className="grid gap-3">
                                {studyGuideDefs.map((def, i) => (
                                    <div
                                        key={i}
                                        className="p-4 rounded-lg transition-all"
                                        style={{ background: 'var(--color-surface)', border: '1px solid var(--color-border-light)' }}
                                    >
                                        <div className="flex justify-between items-start gap-4">
                                            <div className="flex-1">
                                                <span className="font-semibold" style={{ color: 'var(--color-accent)' }}>{def.term}:</span>
                                                <span className="ml-2" style={{ color: 'var(--color-text-secondary)' }}>{def.definition}</span>
                                                {def.textbook_page && (
                                                    <span className="ml-2 text-sm" style={{ color: 'var(--color-text-muted)' }}>(p.{def.textbook_page})</span>
                                                )}
                                            </div>
                                            <div className="flex gap-1.5 flex-shrink-0">
                                                <ActionButton onClick={() => onNavigate('flashcards', i)} title="Practice with Flashcard" variant="ghost">
                                                    Flashcard
                                                </ActionButton>
                                                <ActionButton onClick={() => onNavigate('test-yourself', i)} title="Test Yourself" variant="primary">
                                                    Test
                                                </ActionButton>
                                                <ActionButton onClick={() => onNavigate('quiz', i)} title="Take Quiz" variant="accent">
                                                    Quiz
                                                </ActionButton>
                                                <ActionButton onClick={() => onOpenRAG({ term: def.term, definition: def.definition }, 'definition')} title="Search in documents" variant="success">
                                                    Docs
                                                </ActionButton>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    {/* Teacher's Terminology Section */}
                    {activeSource === 'teacher' && hasTeacherDefs && (
                        <section>
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 rounded-lg" style={{ background: theme === 'dark' ? 'rgba(168, 85, 247, 0.2)' : '#F3E8FF', color: theme === 'dark' ? '#C4B5FD' : '#7C3AED' }}>
                                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold font-display" style={{ color: 'var(--color-text)' }}>Teacher's Terminology</h3>
                                    <p className="text-sm" style={{ color: 'var(--color-text-muted)' }}>Curated definitions from your teacher</p>
                                </div>
                            </div>
                            <div className="grid gap-3">
                                {teacherDefinitions.map((def, i) => (
                                    <div
                                        key={def.id || i}
                                        className="p-4 rounded-lg transition-all"
                                        style={{
                                            background: 'var(--color-surface)',
                                            border: `1px solid ${theme === 'dark' ? 'rgba(168, 85, 247, 0.2)' : '#E9D5FF'}`
                                        }}
                                    >
                                        <div className="flex justify-between items-start gap-4">
                                            <div className="flex-1">
                                                <span className="font-semibold" style={{ color: theme === 'dark' ? '#C4B5FD' : '#7C3AED' }}>{def.term}:</span>
                                                <span className="ml-2" style={{ color: 'var(--color-text-secondary)' }}>{def.definition}</span>
                                            </div>
                                            <div className="flex gap-1.5 flex-shrink-0">
                                                <ActionButton onClick={() => onNavigate('flashcards', i)} title="Practice with Flashcard" variant="ghost">
                                                    Flashcard
                                                </ActionButton>
                                                <ActionButton onClick={() => onOpenRAG({ term: def.term, definition: def.definition }, 'teacher_definition')} title="Search in documents" variant="success">
                                                    Docs
                                                </ActionButton>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    {/* Show message if only one source available */}
                    {!hasStudyGuideDefs && !hasTeacherDefs && (
                        <div className="text-center py-8" style={{ color: 'var(--color-text-muted)' }}>
                            No definitions available for this topic yet.
                        </div>
                    )}

                    {/* Exam Tips Section */}
                    {content.tips?.length > 0 && (
                        <section>
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 rounded-lg" style={{ background: 'var(--color-accent)', color: 'var(--color-primary)' }}>
                                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                                        <circle cx="12" cy="12" r="4"/>
                                    </svg>
                                </div>
                                <h3 className="text-xl font-bold font-display" style={{ color: 'var(--color-text)' }}>Exam Tips</h3>
                            </div>
                            <div className="space-y-2">
                                {content.tips.map((tip, i) => (
                                    <div
                                        key={i}
                                        className="flex items-start gap-3 p-3 rounded-lg"
                                        style={{ background: 'var(--color-surface)', border: '1px solid var(--color-border-light)' }}
                                    >
                                        <span style={{ color: 'var(--color-accent)' }}>‚Ä¢</span>
                                        <span className="flex-1" style={{ color: 'var(--color-text-secondary)' }}>{tip}</span>
                                        <ActionButton onClick={() => onOpenRAG({ text: tip }, 'tip')} title="Search in documents" variant="success">
                                            Docs
                                        </ActionButton>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    {/* Common Errors Section */}
                    {content.common_errors?.length > 0 && (
                        <section>
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 rounded-lg" style={{ background: 'var(--color-error)', color: '#FFF' }}>
                                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </div>
                                <h3 className="text-xl font-bold font-display" style={{ color: 'var(--color-text)' }}>Common Errors</h3>
                            </div>
                            <div className="space-y-2">
                                {content.common_errors.map((error, i) => (
                                    <div
                                        key={i}
                                        className="flex items-start gap-3 p-3 rounded-lg"
                                        style={{ background: 'rgba(197, 48, 48, 0.1)', border: '1px solid var(--color-error)' }}
                                    >
                                        <span style={{ color: 'var(--color-error)' }}>‚Ä¢</span>
                                        <span className="flex-1" style={{ color: 'var(--color-error)' }}>{error}</span>
                                        <ActionButton onClick={() => onOpenRAG({ error: error, explanation: '' }, 'common_error')} title="Search in documents" variant="success">
                                            Docs
                                        </ActionButton>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}
                </div>
            );
        }

        // Flashcards Tab Component - ENHANCED with Type to Learn and Teacher's Terminology
        function FlashcardsTab({ definitions, teacherDefinitions = [], topicId, typingSettings, startIndex = 0, onStartIndexUsed }) {
            const { theme } = useContext(ThemeContext);
            const [activeSource, setActiveSource] = useState('study-guide'); // 'study-guide' or 'teacher'
            const [currentIndex, setCurrentIndex] = useState(startIndex);
            const [flipped, setFlipped] = useState(false);
            const [stats, setStats] = useState({ knew: 0, didnt: 0 });
            const [mode, setMode] = useState('flip'); // 'flip' or 'type'
            const [isTyping, setIsTyping] = useState(false);

            const hasTeacherDefs = teacherDefinitions.length > 0;
            const hasStudyGuideDefs = definitions.length > 0;
            const activeDefinitions = activeSource === 'teacher' ? teacherDefinitions : definitions;

            // Handle startIndex from navigation
            useEffect(() => {
                if (startIndex > 0 && startIndex < activeDefinitions.length) {
                    setCurrentIndex(startIndex);
                    setFlipped(false);
                    setIsTyping(false);
                    if (onStartIndexUsed) onStartIndexUsed();
                }
            }, [startIndex, activeDefinitions.length, onStartIndexUsed]);

            // Reset index when switching sources
            useEffect(() => {
                setCurrentIndex(0);
                setFlipped(false);
                // Keep typing mode active if in Type Mode
                if (mode !== 'type') setIsTyping(false);
                setStats({ knew: 0, didnt: 0 });
            }, [activeSource]);

            const current = activeDefinitions[currentIndex];

            // Navigation functions
            const goToNext = () => {
                if (currentIndex < activeDefinitions.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                    setFlipped(false);
                    // Keep typing mode active if in Type Mode
                    if (mode !== 'type') setIsTyping(false);
                }
            };

            const goToPrevious = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                    setFlipped(false);
                    // Keep typing mode active if in Type Mode
                    if (mode !== 'type') setIsTyping(false);
                }
            };

            const handleResponse = async (knewIt) => {
                // Only track for study guide definitions that have IDs
                if (activeSource === 'study-guide' && current.id) {
                    await api.post(`/flashcards/${current.id}/attempt`, { knew_it: knewIt });
                }

                setStats(prev => ({
                    knew: knewIt ? prev.knew + 1 : prev.knew,
                    didnt: !knewIt ? prev.didnt + 1 : prev.didnt
                }));

                setFlipped(false);
                // Keep typing mode active if in Type Mode
                if (mode !== 'type') setIsTyping(false);
                if (currentIndex < activeDefinitions.length - 1) {
                    setTimeout(() => setCurrentIndex(currentIndex + 1), 300);
                }
            };

            const handleTypeComplete = () => {
                // Auto-mark as knew it if typed correctly
                handleResponse(true);
            };

            const startTyping = () => {
                setIsTyping(true);
            };

            if (!activeDefinitions.length) {
                return (
                    <div className="text-center py-8" style={{ color: 'var(--color-text-muted)' }}>
                        No flashcards available for this topic.
                    </div>
                );
            }

            if (currentIndex >= activeDefinitions.length) {
                const percentage = Math.round((stats.knew / (stats.knew + stats.didnt)) * 100);
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">
                            <svg className="w-16 h-16 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" style={{ color: 'var(--color-accent)' }}>
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <h3 className="text-2xl font-bold font-display mb-2" style={{ color: 'var(--color-text)' }}>All done!</h3>
                        <p className="mb-4" style={{ color: 'var(--color-text-secondary)' }}>
                            You knew <strong style={{ color: 'var(--color-success)' }}>{stats.knew}</strong> out of {stats.knew + stats.didnt} definitions ({percentage}%)
                        </p>
                        <button
                            onClick={() => { setCurrentIndex(0); setStats({ knew: 0, didnt: 0 }); setIsTyping(false); }}
                            className="btn btn-accent"
                        >
                            Start Again
                        </button>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center">
                    {/* Source Toggle - Only show if both sources have content */}
                    {hasStudyGuideDefs && hasTeacherDefs && (
                        <div className="mb-4 w-full max-w-md flex items-center justify-center gap-2 p-1 rounded-xl" style={{ background: 'var(--color-bg-alt)' }}>
                            <button
                                onClick={() => setActiveSource('study-guide')}
                                className="flex-1 px-3 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 text-sm"
                                style={{
                                    background: activeSource === 'study-guide' ? 'var(--color-surface)' : 'transparent',
                                    color: activeSource === 'study-guide' ? 'var(--color-accent)' : 'var(--color-text-muted)',
                                    boxShadow: activeSource === 'study-guide' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
                                }}
                            >
                                <Icons.book />
                                Study Guide ({definitions.length})
                            </button>
                            <button
                                onClick={() => setActiveSource('teacher')}
                                className="flex-1 px-3 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 text-sm"
                                style={{
                                    background: activeSource === 'teacher' ? 'var(--color-surface)' : 'transparent',
                                    color: activeSource === 'teacher' ? (theme === 'dark' ? '#C4B5FD' : '#7C3AED') : 'var(--color-text-muted)',
                                    boxShadow: activeSource === 'teacher' ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
                                }}
                            >
                                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                </svg>
                                Teacher's ({teacherDefinitions.length})
                            </button>
                        </div>
                    )}

                    {/* Mode Toggle */}
                    <div className="mb-4 flex items-center gap-2 p-1 rounded-full" style={{ background: 'var(--color-bg-alt)' }}>
                        <button
                            onClick={() => { setMode('flip'); setIsTyping(false); setFlipped(false); }}
                            className="px-4 py-2 rounded-full text-sm font-medium transition"
                            style={{
                                background: mode === 'flip' ? 'var(--color-surface)' : 'transparent',
                                color: mode === 'flip' ? 'var(--color-accent)' : 'var(--color-text-muted)',
                                boxShadow: mode === 'flip' ? 'var(--shadow-sm)' : 'none'
                            }}
                        >
                            Flip Mode
                        </button>
                        <button
                            onClick={() => { setMode('type'); setFlipped(false); setIsTyping(true); }}
                            className="px-4 py-2 rounded-full text-sm font-medium transition"
                            style={{
                                background: mode === 'type' ? 'var(--color-surface)' : 'transparent',
                                color: mode === 'type' ? 'var(--color-accent)' : 'var(--color-text-muted)',
                                boxShadow: mode === 'type' ? 'var(--shadow-sm)' : 'none'
                            }}
                        >
                            Type Mode
                        </button>
                    </div>

                    {/* Navigation Controls */}
                    <div className="mb-4 flex items-center gap-4">
                        <button
                            onClick={goToPrevious}
                            disabled={currentIndex === 0}
                            className="px-3 py-1 rounded-lg transition disabled:opacity-40 disabled:cursor-not-allowed"
                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                        >
                            <Icons.back />
                        </button>
                        <span style={{ color: 'var(--color-text-muted)' }}>
                            Card <strong style={{ color: activeSource === 'teacher' ? (theme === 'dark' ? '#C4B5FD' : '#7C3AED') : 'var(--color-accent)' }}>{currentIndex + 1}</strong> of {activeDefinitions.length}
                        </span>
                        <button
                            onClick={goToNext}
                            disabled={currentIndex >= activeDefinitions.length - 1}
                            className="px-3 py-1 rounded-lg transition disabled:opacity-40 disabled:cursor-not-allowed"
                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)', transform: 'rotate(180deg)' }}
                        >
                            <Icons.back />
                        </button>
                    </div>

                    {mode === 'flip' ? (
                        <>
                            <div
                                className={`flip-card w-full max-w-lg h-64 cursor-pointer ${flipped ? 'flipped' : ''}`}
                                onClick={() => setFlipped(!flipped)}
                            >
                                <div className="flip-card-inner relative w-full h-full">
                                    <div
                                        className="flip-card-front absolute w-full h-full rounded-2xl flex items-center justify-center p-8"
                                        style={{ background: theme === 'dark' ? 'linear-gradient(135deg, #1A1A1F 0%, #2A2A30 100%)' : 'linear-gradient(135deg, #1B1F5E 0%, #2D3282 100%)' }}
                                    >
                                        <h3 className="text-2xl font-bold font-display text-center" style={{ color: '#F5F5EB' }}>{current.term}</h3>
                                    </div>
                                    <div
                                        className="flip-card-back absolute w-full h-full rounded-2xl flex items-center justify-center p-8"
                                        style={{ background: '#F5F5EB', border: '2px solid var(--color-accent)' }}
                                    >
                                        <p className="text-lg text-center" style={{ color: '#1B1F5E' }}>{current.definition}</p>
                                    </div>
                                </div>
                            </div>

                            <p className="text-sm mt-4 mb-6" style={{ color: 'var(--color-text-muted)' }}>Click to flip</p>

                            <div className="flex space-x-4">
                                <button
                                    onClick={() => handleResponse(false)}
                                    className="btn px-8 py-3"
                                    style={{ background: 'var(--color-error)', color: '#FFF' }}
                                >
                                    Didn't Know
                                </button>
                                <button
                                    onClick={() => handleResponse(true)}
                                    className="btn btn-accent px-8 py-3"
                                >
                                    Knew It!
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="w-full max-w-lg">
                            {/* Term card */}
                            <div
                                className="rounded-2xl p-6 mb-6"
                                style={{ background: theme === 'dark' ? 'linear-gradient(135deg, #1A1A1F 0%, #2A2A30 100%)' : 'linear-gradient(135deg, #1B1F5E 0%, #2D3282 100%)' }}
                            >
                                <h3 className="text-2xl font-bold font-display text-center" style={{ color: '#F5F5EB' }}>{current.term}</h3>
                            </div>

                            {!isTyping ? (
                                <div className="text-center">
                                    <p className="mb-4" style={{ color: 'var(--color-text-secondary)' }}>
                                        Read the definition, then type it from memory to reinforce learning
                                    </p>

                                    {/* Show definition preview */}
                                    <div
                                        className="rounded-xl p-6 mb-6 text-left"
                                        style={{ background: 'var(--color-surface)', border: '1px solid var(--color-border-light)' }}
                                    >
                                        <p className="text-lg" style={{ color: 'var(--color-text-secondary)' }}>{current.definition}</p>
                                    </div>

                                    <button onClick={startTyping} className="btn btn-accent flex items-center gap-2 mx-auto">
                                        Type to Memorize
                                    </button>

                                    <button
                                        onClick={() => handleResponse(true)}
                                        className="mt-3 text-sm transition"
                                        style={{ color: 'var(--color-text-muted)' }}
                                        onMouseEnter={(e) => e.currentTarget.style.color = 'var(--color-text)'}
                                        onMouseLeave={(e) => e.currentTarget.style.color = 'var(--color-text-muted)'}
                                    >
                                        Skip (I already know this)
                                    </button>
                                </div>
                            ) : (
                                <TypingPractice
                                    text={current.definition}
                                    onComplete={handleTypeComplete}
                                    onCancel={() => setIsTyping(false)}
                                    settings={typingSettings}
                                    label={`Definition of "${current.term}"`}
                                />
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Test Yourself Tab Component (Study Guide Questions p.125-127) - ENHANCED
        function TestYourselfTab({ topicCode, topicName, typingSettings, startIndex = 0, onStartIndexUsed }) {
            const { theme } = useContext(ThemeContext);
            const [questions, setQuestions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [revealedAnswers, setRevealedAnswers] = useState({});
            const [userScores, setUserScores] = useState({});
            const [completed, setCompleted] = useState(false);
            const [typingIndex, setTypingIndex] = useState(null);
            const [focusedIndex, setFocusedIndex] = useState(null); // For single-question view
            const questionRefs = React.useRef([]);

            useEffect(() => {
                api.get(`/test-yourself/${topicCode}`).then(data => {
                    setQuestions(data || []);
                    setLoading(false);
                });
            }, [topicCode]);

            // Handle startIndex from navigation - focus on that question
            useEffect(() => {
                if (startIndex > 0 && questions.length > 0 && startIndex < questions.length) {
                    setFocusedIndex(startIndex);
                    if (onStartIndexUsed) onStartIndexUsed();
                }
            }, [startIndex, questions.length, onStartIndexUsed]);

            // Navigation for focused view
            const goToNext = () => {
                if (focusedIndex !== null && focusedIndex < questions.length - 1) {
                    setFocusedIndex(focusedIndex + 1);
                    setTypingIndex(null);
                }
            };

            const goToPrevious = () => {
                if (focusedIndex !== null && focusedIndex > 0) {
                    setFocusedIndex(focusedIndex - 1);
                    setTypingIndex(null);
                }
            };

            const exitFocusMode = () => {
                setFocusedIndex(null);
                setTypingIndex(null);
            };

            const toggleAnswer = (index) => {
                setRevealedAnswers(prev => ({
                    ...prev,
                    [index]: !prev[index]
                }));
            };

            const markScore = async (index, knewIt) => {
                setUserScores(prev => ({
                    ...prev,
                    [index]: knewIt
                }));
                setTypingIndex(null);

                await api.post(`/test-yourself/${topicCode}/attempt`, {
                    question_number: index + 1,
                    knew_it: knewIt
                });

                const newScores = { ...userScores, [index]: knewIt };
                if (Object.keys(newScores).length === questions.length) {
                    setCompleted(true);
                }
            };

            const startTyping = (index) => {
                setTypingIndex(index);
            };

            const handleTypingComplete = (index) => {
                markScore(index, true);
            };

            const resetQuiz = () => {
                setRevealedAnswers({});
                setUserScores({});
                setCompleted(false);
                setTypingIndex(null);
            };

            if (loading) {
                return <div className="text-center py-8">Loading Test Yourself questions...</div>;
            }

            if (!questions.length) {
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">üìù</div>
                        <p style={{ color: 'var(--color-text-muted)' }}>No Test Yourself questions available for this topic yet.</p>
                    </div>
                );
            }

            const totalScore = Object.values(userScores).filter(v => v === true).length;
            const totalAnswered = Object.keys(userScores).length;

            if (completed) {
                const percentage = Math.round(totalScore / questions.length * 100);
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">{percentage >= 70 ? 'üåü' : percentage >= 50 ? 'üëç' : 'üìö'}</div>
                        <h3 className="text-2xl font-bold mb-2" style={{ color: 'var(--color-text)' }}>Test Yourself Complete!</h3>
                        <p className="text-xl mb-4" style={{ color: 'var(--color-text-secondary)' }}>
                            You knew {totalScore} out of {questions.length} answers ({percentage}%)
                        </p>
                        <p className="mb-6" style={{ color: 'var(--color-text-muted)' }}>
                            {percentage >= 70 ? 'Excellent work! You have a strong understanding.' :
                             percentage >= 50 ? 'Good effort! Review the answers you missed.' :
                             'Keep studying! Review the definitions and try again.'}
                        </p>
                        <button
                            onClick={resetQuiz}
                            className="px-6 py-3 rounded-lg font-semibold transition"
                            style={{ background: 'var(--color-success)', color: '#FFFFFF' }}
                        >
                            Try Again
                        </button>
                    </div>
                );
            }

            // Focused single-question view with navigation
            if (focusedIndex !== null && questions[focusedIndex]) {
                const q = questions[focusedIndex];
                const index = focusedIndex;
                return (
                    <div className="space-y-6">
                        <div className="flex items-center justify-between">
                            <button
                                onClick={exitFocusMode}
                                className="flex items-center gap-1 transition"
                                style={{ color: 'var(--color-text-muted)' }}
                            >
                                ‚Üê Back to All Questions
                            </button>
                        </div>

                        {/* Navigation Controls */}
                        <div className="flex items-center justify-center gap-4">
                            <button
                                onClick={goToPrevious}
                                disabled={focusedIndex === 0}
                                className="px-4 py-2 rounded-lg disabled:opacity-40 disabled:cursor-not-allowed transition"
                                style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                            >
                                ‚Üê Previous
                            </button>
                            <span className="font-medium" style={{ color: 'var(--color-text-muted)' }}>
                                Question {focusedIndex + 1} of {questions.length}
                            </span>
                            <button
                                onClick={goToNext}
                                disabled={focusedIndex >= questions.length - 1}
                                className="px-4 py-2 rounded-lg disabled:opacity-40 disabled:cursor-not-allowed transition"
                                style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                            >
                                Next ‚Üí
                            </button>
                        </div>

                        {/* Single Question Card */}
                        <div
                            className="border-2 rounded-xl overflow-hidden"
                            style={{
                                borderColor: userScores[index] !== undefined
                                    ? (userScores[index] ? 'var(--color-success)' : 'var(--color-error)')
                                    : 'var(--color-border)',
                                background: userScores[index] !== undefined
                                    ? (userScores[index] ? 'rgba(45, 106, 79, 0.1)' : 'rgba(197, 48, 48, 0.1)')
                                    : 'var(--color-surface)'
                            }}
                        >
                            <div className="p-6">
                                <div className="flex items-start space-x-4">
                                    <span className="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl" style={{ background: 'var(--color-success)', color: '#FFFFFF' }}>
                                        {q.number}
                                    </span>
                                    <div className="flex-grow">
                                        <p className="font-medium text-lg" style={{ color: 'var(--color-text)' }}>{q.question}</p>
                                    </div>
                                </div>

                                {!revealedAnswers[index] && userScores[index] === undefined && (
                                    <button
                                        onClick={() => toggleAnswer(index)}
                                        className="mt-6 ml-16 font-medium flex items-center space-x-1 text-lg transition"
                                        style={{ color: 'var(--color-success)' }}
                                    >
                                        <span>üëÅÔ∏è Reveal Answer</span>
                                    </button>
                                )}

                                {revealedAnswers[index] && userScores[index] === undefined && (
                                    <div className="mt-6 ml-16">
                                        {typingIndex === index ? (
                                            <TypingPractice
                                                text={q.answer}
                                                onComplete={() => handleTypingComplete(index)}
                                                onCancel={() => setTypingIndex(null)}
                                                settings={typingSettings}
                                                label="Answer"
                                            />
                                        ) : (
                                            <>
                                                <div className="p-6 rounded-lg border" style={{ background: 'var(--color-surface)', borderColor: 'var(--color-success)' }}>
                                                    <p className="text-lg" style={{ color: 'var(--color-text)' }}>{q.answer}</p>
                                                </div>
                                                <div className="mt-4 flex flex-wrap gap-3">
                                                    <button
                                                        onClick={() => startTyping(index)}
                                                        className="px-6 py-3 rounded-lg font-medium transition flex items-center gap-2"
                                                        style={{ background: 'var(--color-primary)', color: '#FFFFFF' }}
                                                    >
                                                        ‚å®Ô∏è Type to Memorize
                                                    </button>
                                                    <button
                                                        onClick={() => markScore(index, true)}
                                                        className="px-6 py-3 rounded-lg font-medium transition"
                                                        style={{ background: 'var(--color-success)', color: '#FFFFFF' }}
                                                    >
                                                        ‚úÖ I knew this
                                                    </button>
                                                    <button
                                                        onClick={() => markScore(index, false)}
                                                        className="px-6 py-3 rounded-lg font-medium transition"
                                                        style={{ background: 'var(--color-error)', color: '#FFFFFF' }}
                                                    >
                                                        ‚ùå Didn't know
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}

                                {userScores[index] !== undefined && (
                                    <div className="mt-6 ml-16">
                                        <div className="p-4 rounded-lg border" style={{ background: 'var(--color-surface)', borderColor: 'var(--color-success)' }}>
                                            <p style={{ color: 'var(--color-text)' }}>{q.answer}</p>
                                        </div>
                                        <p className="mt-2 font-medium" style={{ color: userScores[index] ? 'var(--color-success)' : 'var(--color-error)' }}>
                                            {userScores[index] ? '‚úÖ You knew this!' : '‚ùå Keep practicing!'}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="border-l-4 p-4 rounded-r-lg" style={{ background: 'rgba(212, 160, 23, 0.1)', borderColor: 'var(--color-accent)' }}>
                        <h3 className="text-lg font-bold mb-2" style={{ color: 'var(--color-accent)' }}>üìñ Test Yourself</h3>
                        <p style={{ color: 'var(--color-text-secondary)' }}>
                            These questions are from the Cambridge IGCSE Geography Study and Revision Guide (p.125-127).
                            Try to answer each question, then reveal and <b>type the answer to memorize it</b>!
                        </p>
                    </div>

                    {totalAnswered > 0 && (
                        <div className="p-4 rounded-lg" style={{ background: 'var(--color-bg-alt)' }}>
                            <div className="flex justify-between items-center">
                                <span style={{ color: 'var(--color-text-secondary)' }}>Progress: {totalAnswered}/{questions.length}</span>
                                <span className="font-semibold" style={{ color: 'var(--color-success)' }}>Score: {totalScore}/{totalAnswered}</span>
                            </div>
                            <div className="mt-2 rounded-full h-2" style={{ background: 'var(--color-border)' }}>
                                <div
                                    className="h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${(totalAnswered / questions.length) * 100}%`, background: 'var(--color-success)' }}
                                ></div>
                            </div>
                        </div>
                    )}

                    <div className="space-y-4">
                        {questions.map((q, index) => (
                            <div
                                key={index}
                                className="border rounded-lg overflow-hidden"
                                style={{
                                    borderColor: userScores[index] !== undefined
                                        ? (userScores[index] ? 'var(--color-success)' : 'var(--color-error)')
                                        : 'var(--color-border)',
                                    background: userScores[index] !== undefined
                                        ? (userScores[index] ? 'rgba(45, 106, 79, 0.1)' : 'rgba(197, 48, 48, 0.1)')
                                        : 'var(--color-surface)'
                                }}
                            >
                                <div className="p-4">
                                    <div className="flex items-start space-x-3">
                                        <span className="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold" style={{ background: 'var(--color-success)', color: '#FFFFFF' }}>
                                            {q.number}
                                        </span>
                                        <div className="flex-grow">
                                            <p className="font-medium" style={{ color: 'var(--color-text)' }}>{q.question}</p>
                                        </div>
                                        <button
                                            onClick={() => setFocusedIndex(index)}
                                            className="flex-shrink-0 px-2 py-1 text-xs rounded transition"
                                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text-secondary)' }}
                                            title="Focus on this question"
                                        >
                                            Focus ‚Üí
                                        </button>
                                    </div>

                                    {!revealedAnswers[index] && userScores[index] === undefined && (
                                        <button
                                            onClick={() => toggleAnswer(index)}
                                            className="mt-4 ml-11 font-medium flex items-center space-x-1 transition"
                                            style={{ color: 'var(--color-success)' }}
                                        >
                                            <span>üëÅÔ∏è Reveal Answer</span>
                                        </button>
                                    )}

                                    {revealedAnswers[index] && userScores[index] === undefined && (
                                        <div className="mt-4 ml-11">
                                            {typingIndex === index ? (
                                                <TypingPractice
                                                    text={q.answer}
                                                    onComplete={() => handleTypingComplete(index)}
                                                    onCancel={() => setTypingIndex(null)}
                                                    settings={typingSettings}
                                                    label="Answer"
                                                />
                                            ) : (
                                                <>
                                                    <div className="p-4 rounded-lg border" style={{ background: 'var(--color-surface)', borderColor: 'var(--color-success)' }}>
                                                        <p style={{ color: 'var(--color-text)' }}>{q.answer}</p>
                                                    </div>

                                                    <div className="mt-3 flex flex-wrap gap-3">
                                                        <button
                                                            onClick={() => startTyping(index)}
                                                            className="px-4 py-2 rounded-lg font-medium transition flex items-center gap-2"
                                                            style={{ background: 'var(--color-primary)', color: '#FFFFFF' }}
                                                        >
                                                            ‚å®Ô∏è Type to Memorize
                                                        </button>
                                                        <button
                                                            onClick={() => markScore(index, true)}
                                                            className="px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2"
                                                            style={{ background: 'var(--color-success)', color: '#FFFFFF' }}
                                                        >
                                                            <span>‚úÖ</span>
                                                            <span>I knew this</span>
                                                        </button>
                                                        <button
                                                            onClick={() => markScore(index, false)}
                                                            className="px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2"
                                                            style={{ background: 'var(--color-error)', color: '#FFFFFF' }}
                                                        >
                                                            <span>‚ùå</span>
                                                            <span>Need to review</span>
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {userScores[index] !== undefined && (
                                        <div className="mt-4 ml-11">
                                            <div className="p-4 rounded-lg border mb-2" style={{ background: 'var(--color-surface)', borderColor: 'var(--color-success)' }}>
                                                <p style={{ color: 'var(--color-text)' }}>{q.answer}</p>
                                            </div>
                                            <div
                                                className="inline-block px-3 py-1 rounded-full text-sm font-medium"
                                                style={{
                                                    background: userScores[index] ? 'rgba(45, 106, 79, 0.2)' : 'rgba(197, 48, 48, 0.2)',
                                                    color: userScores[index] ? 'var(--color-success)' : 'var(--color-error)'
                                                }}
                                            >
                                                {userScores[index] ? '‚úÖ Correct!' : '‚ùå Review this'}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="text-center text-sm" style={{ color: 'var(--color-text-muted)' }}>
                        Source: Cambridge IGCSE and O Level Geography Study and Revision Guide (p.125-127)
                    </div>
                </div>
            );
        }

        // Exam Practice Tab Component - Shows exam questions with model answers for this topic
        function ExamPracticeTab({ topicId, topicName, onNavigateToDocChat }) {
            const { theme } = useContext(ThemeContext);
            const [questions, setQuestions] = useState([]);
            const [sampleAnswers, setSampleAnswers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expandedId, setExpandedId] = useState(null);
            const [expandedSampleId, setExpandedSampleId] = useState(null);
            // RAG Modal state
            const [ragModalOpen, setRagModalOpen] = useState(false);
            const [ragContext, setRagContext] = useState(null);
            const [ragContextType, setRagContextType] = useState('general');

            const openRAGModal = (context, type) => {
                setRagContext(context);
                setRagContextType(type);
                setRagModalOpen(true);
            };

            useEffect(() => {
                Promise.all([
                    api.get(`/exam-questions/${topicId}`),
                    api.get(`/sample-answers/${topicId}`)
                ]).then(([questionsData, sampleData]) => {
                    setQuestions(questionsData || []);
                    setSampleAnswers(sampleData || []);
                    setLoading(false);
                });
            }, [topicId]);

            if (loading) return <div className="text-center py-8">Loading exam questions...</div>;

            if (questions.length === 0 && sampleAnswers.length === 0) {
                return (
                    <div className="text-center py-12">
                        <span className="text-6xl">üìù</span>
                        <p className="mt-4" style={{ color: 'var(--color-text-muted)' }}>No exam questions available for this topic yet.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-8">
                    {/* Exam-Style Questions Section */}
                    {questions.length > 0 && (
                        <div className="space-y-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold" style={{ color: 'var(--color-text)' }}>
                                    üìù Exam-Style Questions ({questions.length})
                                </h3>
                            </div>

                            {questions.map((q, index) => (
                                <div
                                    key={q.id}
                                    className="border rounded-xl overflow-hidden shadow-sm"
                                    style={{ background: 'var(--color-surface)', borderColor: 'var(--color-border)' }}
                                >
                                    <div
                                        className="p-4 cursor-pointer transition"
                                        onClick={() => setExpandedId(expandedId === q.id ? null : q.id)}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex-grow">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span
                                                        className="px-2 py-1 rounded text-sm font-medium"
                                                        style={{
                                                            background: theme === 'dark' ? 'rgba(59, 130, 246, 0.2)' : '#DBEAFE',
                                                            color: theme === 'dark' ? '#93C5FD' : '#1D4ED8'
                                                        }}
                                                    >
                                                        {q.marks} marks
                                                    </span>
                                                    {q.command_word && (
                                                        <span
                                                            className="px-2 py-1 rounded text-sm"
                                                            style={{
                                                                background: theme === 'dark' ? 'rgba(139, 92, 246, 0.2)' : '#EDE9FE',
                                                                color: theme === 'dark' ? '#A78BFA' : '#6D28D9'
                                                            }}
                                                        >
                                                            {q.command_word}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="font-medium" style={{ color: 'var(--color-text)' }}>{q.question_text}</p>
                                            </div>
                                            <span className="text-xl ml-4" style={{ color: 'var(--color-text-muted)' }}>
                                                {expandedId === q.id ? '‚ñº' : '‚ñ∂'}
                                            </span>
                                        </div>
                                    </div>

                                    {expandedId === q.id && (
                                        <div
                                            className="border-t p-4"
                                            style={{
                                                background: theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4',
                                                borderColor: theme === 'dark' ? 'var(--color-border)' : '#BBF7D0'
                                            }}
                                        >
                                            <h4 className="font-semibold mb-2" style={{ color: 'var(--color-success)' }}>‚úÖ Model Answer:</h4>
                                            <p className="whitespace-pre-line" style={{ color: 'var(--color-text)' }}>{q.model_answer}</p>
                                            <div className="mt-3 pt-3 border-t border-green-200 flex justify-end">
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        openRAGModal({
                                                            question: q.question_text,
                                                            answer: q.model_answer,
                                                            comments: ''
                                                        }, 'sample_question');
                                                    }}
                                                    className="p-2 bg-teal-100 text-teal-700 rounded-lg hover:bg-teal-200 transition"
                                                    title="Search in study materials"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Sample Exam Questions with Student Answers Section */}
                    {sampleAnswers.length > 0 && (
                        <div className="space-y-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold" style={{ color: 'var(--color-text)' }}>
                                    üìã Sample Exam Questions with Student Answers ({sampleAnswers.length})
                                </h3>
                            </div>
                            <p className="text-sm mb-4" style={{ color: 'var(--color-text-secondary)' }}>
                                Learn from real student answers and teacher feedback to understand how marks are awarded.
                            </p>

                            {sampleAnswers.map((sa, index) => (
                                <div
                                    key={sa.id}
                                    className="border-2 rounded-xl overflow-hidden shadow-sm"
                                    style={{
                                        borderColor: theme === 'dark' ? 'rgba(245, 158, 11, 0.3)' : '#FDE68A',
                                        background: theme === 'dark' ? 'rgba(245, 158, 11, 0.08)' : '#FFFBEB'
                                    }}
                                >
                                    <div
                                        className="p-4 cursor-pointer transition"
                                        style={{ ':hover': { background: theme === 'dark' ? 'rgba(245, 158, 11, 0.12)' : '#FEF3C7' } }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = theme === 'dark' ? 'rgba(245, 158, 11, 0.12)' : '#FEF3C7'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                        onClick={() => setExpandedSampleId(expandedSampleId === sa.id ? null : sa.id)}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex-grow">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span
                                                        className="px-2 py-1 rounded text-sm font-medium"
                                                        style={{
                                                            background: theme === 'dark' ? 'rgba(245, 158, 11, 0.2)' : '#FDE68A',
                                                            color: theme === 'dark' ? '#FCD34D' : '#92400E'
                                                        }}
                                                    >
                                                        {sa.marks} marks available
                                                    </span>
                                                    <span
                                                        className="px-2 py-1 rounded text-sm font-medium"
                                                        style={{
                                                            background: theme === 'dark' ? 'rgba(45, 106, 79, 0.2)' : '#BBF7D0',
                                                            color: theme === 'dark' ? '#86EFAC' : '#166534'
                                                        }}
                                                    >
                                                        {sa.marks_awarded}/{sa.marks} awarded
                                                    </span>
                                                    {sa.source_page && (
                                                        <span
                                                            className="px-2 py-1 rounded text-xs"
                                                            style={{
                                                                background: 'var(--color-bg-alt)',
                                                                color: 'var(--color-text-secondary)'
                                                            }}
                                                        >
                                                            {sa.source_page}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="font-medium" style={{ color: 'var(--color-text)' }}>{sa.question_text}</p>
                                            </div>
                                            <span className="text-amber-600 text-xl ml-4">
                                                {expandedSampleId === sa.id ? '‚ñº' : '‚ñ∂'}
                                            </span>
                                        </div>
                                    </div>

                                    {expandedSampleId === sa.id && (
                                        <div
                                            className="border-t"
                                            style={{ borderColor: theme === 'dark' ? 'rgba(245, 158, 11, 0.3)' : '#FCD34D' }}
                                        >
                                            {/* Student Answer */}
                                            <div
                                                className="p-4 border-b"
                                                style={{
                                                    background: theme === 'dark' ? 'rgba(59, 130, 246, 0.1)' : '#EFF6FF',
                                                    borderColor: theme === 'dark' ? 'rgba(245, 158, 11, 0.2)' : '#FDE68A'
                                                }}
                                            >
                                                <h4
                                                    className="font-semibold mb-2"
                                                    style={{ color: theme === 'dark' ? '#93C5FD' : '#1E40AF' }}
                                                >üë§ Student's Answer:</h4>
                                                <p className="whitespace-pre-line" style={{ color: 'var(--color-text)' }}>{sa.student_answer}</p>
                                            </div>

                                            {/* Teacher Comments */}
                                            <div
                                                className="p-4"
                                                style={{ background: theme === 'dark' ? 'rgba(45, 106, 79, 0.1)' : '#F0FDF4' }}
                                            >
                                                <h4
                                                    className="font-semibold mb-2"
                                                    style={{ color: theme === 'dark' ? '#86EFAC' : '#166534' }}
                                                >üë®‚Äçüè´ Teacher's Comments:</h4>
                                                <p className="whitespace-pre-line" style={{ color: 'var(--color-text)' }}>{sa.teacher_comments}</p>
                                                <div
                                                    className="mt-3 pt-3 border-t flex items-center justify-between"
                                                    style={{ borderColor: theme === 'dark' ? 'rgba(45, 106, 79, 0.3)' : '#BBF7D0' }}
                                                >
                                                    <span
                                                        className="text-sm font-medium"
                                                        style={{ color: theme === 'dark' ? '#86EFAC' : '#15803D' }}
                                                    >
                                                        Marks Awarded: {sa.marks_awarded} out of {sa.marks}
                                                    </span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            openRAGModal({
                                                                question: sa.question_text,
                                                                answer: sa.student_answer,
                                                                comments: sa.teacher_comments
                                                            }, 'sample_question');
                                                        }}
                                                        className="p-2 rounded-lg transition"
                                                        style={{
                                                            background: theme === 'dark' ? 'rgba(20, 184, 166, 0.15)' : '#CCFBF1',
                                                            color: theme === 'dark' ? '#5EEAD4' : '#0F766E'
                                                        }}
                                                        title="Search in study materials"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="text-center text-sm mt-6" style={{ color: 'var(--color-text-muted)' }}>
                        Practice these questions to prepare for your exam
                    </div>

                    {/* RAG Query Modal */}
                    <RAGQueryModal
                        isOpen={ragModalOpen}
                        onClose={() => setRagModalOpen(false)}
                        context={ragContext}
                        contextType={ragContextType}
                        onNavigateToDocChat={onNavigateToDocChat}
                    />
                </div>
            );
        }

        // Study Tips Tab Component - Shows tips and common errors for this topic
        function StudyTipsTab({ topicId, onNavigateToDocChat }) {
            const { theme } = useContext(ThemeContext);
            const [tips, setTips] = useState([]);
            const [errors, setErrors] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeSection, setActiveSection] = useState('tips');
            // RAG Modal state
            const [ragModalOpen, setRagModalOpen] = useState(false);
            const [ragContext, setRagContext] = useState(null);
            const [ragContextType, setRagContextType] = useState('general');

            const openRAGModal = (context, type) => {
                setRagContext(context);
                setRagContextType(type);
                setRagModalOpen(true);
            };

            useEffect(() => {
                Promise.all([
                    api.get(`/tips/${topicId}`),
                    api.get(`/common-errors/${topicId}`)
                ]).then(([tipsData, errorsData]) => {
                    setTips(tipsData || []);
                    setErrors(errorsData || []);
                    setLoading(false);
                });
            }, [topicId]);

            if (loading) return <div className="text-center py-8">Loading study tips...</div>;

            const hasTips = tips.length > 0;
            const hasErrors = errors.length > 0;

            if (!hasTips && !hasErrors) {
                return (
                    <div className="text-center py-12">
                        <span className="text-6xl">üí°</span>
                        <p className="mt-4" style={{ color: 'var(--color-text-muted)' }}>No tips or common errors available for this topic yet.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* Section Tabs */}
                    <div className="flex gap-4 border-b" style={{ borderColor: 'var(--color-border)' }}>
                        <button
                            onClick={() => setActiveSection('tips')}
                            className="pb-2 px-4 font-medium transition"
                            style={{
                                borderBottom: activeSection === 'tips' ? '2px solid var(--color-success)' : 'none',
                                color: activeSection === 'tips' ? 'var(--color-success)' : 'var(--color-text-muted)'
                            }}
                        >
                            üí° Tips ({tips.length})
                        </button>
                        <button
                            onClick={() => setActiveSection('errors')}
                            className="pb-2 px-4 font-medium transition"
                            style={{
                                borderBottom: activeSection === 'errors' ? '2px solid #EF4444' : 'none',
                                color: activeSection === 'errors' ? '#EF4444' : 'var(--color-text-muted)'
                            }}
                        >
                            ‚ö†Ô∏è Common Errors ({errors.length})
                        </button>
                    </div>

                    {/* Tips Section */}
                    {activeSection === 'tips' && (
                        <div className="space-y-3">
                            {tips.length === 0 ? (
                                <p className="text-center py-4" style={{ color: 'var(--color-text-muted)' }}>No tips available for this topic.</p>
                            ) : (
                                tips.map((tip, index) => (
                                    <div
                                        key={tip.id}
                                        className="flex items-start gap-3 p-4 rounded-lg border"
                                        style={{
                                            background: theme === 'dark' ? 'rgba(45, 106, 79, 0.1)' : '#F0FDF4',
                                            borderColor: theme === 'dark' ? 'rgba(45, 106, 79, 0.3)' : '#BBF7D0'
                                        }}
                                    >
                                        <span className="text-2xl">üí°</span>
                                        <div className="flex-1">
                                            <div className="flex items-center justify-between mb-1">
                                                <span
                                                    className="inline-block px-2 py-0.5 rounded text-xs"
                                                    style={{
                                                        background: theme === 'dark' ? 'rgba(45, 106, 79, 0.3)' : '#BBF7D0',
                                                        color: 'var(--color-success)'
                                                    }}
                                                >
                                                    {tip.tip_type === 'exam' ? 'Exam Tip' : 'Study Tip'}
                                                </span>
                                                <button
                                                    onClick={() => openRAGModal({ text: tip.tip_text }, 'tip')}
                                                    className="p-1.5 rounded transition"
                                                    style={{
                                                        background: theme === 'dark' ? 'rgba(20, 184, 166, 0.2)' : '#CCFBF1',
                                                        color: '#14B8A6'
                                                    }}
                                                    title="Search in study materials"
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <p style={{ color: 'var(--color-text)' }}>{tip.tip_text}</p>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* Common Errors Section */}
                    {activeSection === 'errors' && (
                        <div className="space-y-3">
                            {errors.length === 0 ? (
                                <p className="text-center py-4" style={{ color: 'var(--color-text-muted)' }}>No common errors listed for this topic.</p>
                            ) : (
                                errors.map((error, index) => (
                                    <div
                                        key={error.id}
                                        className="p-4 rounded-lg border"
                                        style={{
                                            background: theme === 'dark' ? 'rgba(239, 68, 68, 0.1)' : '#FEF2F2',
                                            borderColor: theme === 'dark' ? 'rgba(239, 68, 68, 0.3)' : '#FECACA'
                                        }}
                                    >
                                        <div className="flex items-start gap-3">
                                            <span className="text-2xl">‚ö†Ô∏è</span>
                                            <div className="flex-1">
                                                <div className="flex items-start justify-between">
                                                    <p className="text-red-500 font-medium">{error.error_description}</p>
                                                    <button
                                                        onClick={() => openRAGModal({
                                                            error: error.error_description,
                                                            explanation: error.why_wrong
                                                        }, 'common_error')}
                                                        className="ml-2 p-1.5 rounded transition flex-shrink-0"
                                                        style={{
                                                            background: theme === 'dark' ? 'rgba(20, 184, 166, 0.2)' : '#CCFBF1',
                                                            color: '#14B8A6'
                                                        }}
                                                        title="Search in study materials"
                                                    >
                                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                {error.why_wrong && (
                                                    <p className="mt-2 text-sm" style={{ color: 'var(--color-text-secondary)' }}>
                                                        <span className="font-medium">Why it's wrong:</span> {error.why_wrong}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* RAG Query Modal */}
                    <RAGQueryModal
                        isOpen={ragModalOpen}
                        onClose={() => setRagModalOpen(false)}
                        context={ragContext}
                        contextType={ragContextType}
                        onNavigateToDocChat={onNavigateToDocChat}
                    />
                </div>
            );
        }

        // Quiz Tab Component - ENHANCED with Type to Review
        function QuizTab({ questions, topicId, typingSettings, startIndex = 0, onStartIndexUsed }) {
            const { theme } = useContext(ThemeContext);
            const [currentIndex, setCurrentIndex] = useState(startIndex);
            const [answer, setAnswer] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [hintLevel, setHintLevel] = useState(0);
            const [hint, setHint] = useState('');
            const [stats, setStats] = useState({ correct: 0, total: 0, marks: 0, maxMarks: 0 });
            const [isTypingReview, setIsTypingReview] = useState(false);
            const [quizMode, setQuizMode] = useState('quiz'); // 'quiz' or 'type'

            // Handle startIndex from navigation
            useEffect(() => {
                if (startIndex > 0 && startIndex < questions.length) {
                    setCurrentIndex(startIndex);
                    setAnswer('');
                    setResult(null);
                    setHint('');
                    setHintLevel(0);
                    setIsTypingReview(false);
                    if (onStartIndexUsed) onStartIndexUsed();
                }
            }, [startIndex, questions.length, onStartIndexUsed]);

            const current = questions[currentIndex];

            const submitAnswer = async () => {
                setLoading(true);
                const res = await api.post(`/questions/${current.id}/submit`, {
                    answer,
                    use_ai_marking: true
                });
                setResult(res);
                setStats(prev => ({
                    correct: res?.is_correct ? prev.correct + 1 : prev.correct,
                    total: prev.total + 1,
                    marks: prev.marks + (res?.marks_awarded || 0),
                    maxMarks: prev.maxMarks + (res?.marks_possible || current.marks)
                }));
                setLoading(false);
            };

            const getHint = async () => {
                const newLevel = Math.min(hintLevel + 1, 3);
                setHintLevel(newLevel);
                const res = await api.post('/ai/hint', {
                    question_id: current.id,
                    hint_level: newLevel
                });
                setHint(res?.hint || 'Think about the key terms for this topic.');
            };

            const nextQuestion = () => {
                setCurrentIndex(currentIndex + 1);
                setAnswer('');
                setResult(null);
                setHint('');
                setHintLevel(0);
                setIsTypingReview(false);
            };

            const previousQuestion = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                    setAnswer('');
                    setResult(null);
                    setHint('');
                    setHintLevel(0);
                    setIsTypingReview(false);
                }
            };

            const generateSimilar = async () => {
                setLoading(true);
                const res = await api.post('/ai/generate-questions', {
                    question_id: current.id,
                    num_questions: 3
                });
                if (res?.questions?.length) {
                    alert(`Generated ${res.questions.length} new questions! They'll appear in your next quiz.`);
                } else if (res?.error) {
                    alert(res.error);
                }
                setLoading(false);
            };

            const handleTypingComplete = () => {
                setIsTypingReview(false);
                // Show celebration
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { y: 0.7 },
                    colors: ['#22c55e', '#3b82f6', '#f59e0b']
                });
            };

            if (!questions.length) {
                return <div className="text-center py-8" style={{ color: 'var(--color-text-muted)' }}>No questions available for this topic.</div>;
            }

            // Type Mode - shows question and model answer for typing practice
            if (quizMode === 'type') {
                return (
                    <div className="max-w-2xl mx-auto">
                        {/* Mode Toggle */}
                        <div className="flex justify-center gap-2 mb-6">
                            <button
                                onClick={() => setQuizMode('quiz')}
                                className="px-4 py-2 rounded-lg font-medium transition"
                                style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text-secondary)' }}
                            >
                                Quiz Mode
                            </button>
                            <button
                                onClick={() => setQuizMode('type')}
                                className="px-4 py-2 rounded-lg font-medium transition bg-green-500 text-white"
                            >
                                Type Mode
                            </button>
                        </div>

                        {/* Navigation */}
                        <div className="flex items-center justify-center gap-4 mb-4">
                            <button
                                onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))}
                                disabled={currentIndex === 0}
                                className="px-3 py-1 rounded-lg disabled:opacity-40 disabled:cursor-not-allowed transition"
                                style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                            >
                                ‚Üê Prev
                            </button>
                            <span style={{ color: 'var(--color-text-muted)' }}>
                                Question {currentIndex + 1} of {questions.length}
                            </span>
                            <button
                                onClick={() => setCurrentIndex(Math.min(questions.length - 1, currentIndex + 1))}
                                disabled={currentIndex >= questions.length - 1}
                                className="px-3 py-1 rounded-lg disabled:opacity-40 disabled:cursor-not-allowed transition"
                                style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                            >
                                Next ‚Üí
                            </button>
                        </div>

                        <div className="flex justify-end mb-4">
                            <span
                                className="px-3 py-1 rounded-full text-sm font-medium"
                                style={{
                                    background: theme === 'dark' ? 'rgba(45, 106, 79, 0.2)' : '#DCFCE7',
                                    color: 'var(--color-success)'
                                }}
                            >
                                {current.assessment_objective || 'AO1'} ‚Ä¢ {current.marks} mark{current.marks > 1 ? 's' : ''}
                            </span>
                        </div>

                        {/* Question */}
                        <div className="p-6 rounded-lg mb-6" style={{ background: 'var(--color-bg-alt)' }}>
                            <h3 className="text-lg font-medium" style={{ color: 'var(--color-text)' }}>{current.question_text}</h3>
                        </div>

                        {/* Model Answer for Typing */}
                        <div
                            className="p-4 rounded-lg mb-4 border"
                            style={{
                                background: theme === 'dark' ? 'rgba(59, 130, 246, 0.1)' : '#EFF6FF',
                                borderColor: theme === 'dark' ? 'rgba(59, 130, 246, 0.3)' : '#BFDBFE'
                            }}
                        >
                            <div className="text-sm text-blue-500 font-medium mb-2">Model Answer to Practice:</div>
                            <div style={{ color: 'var(--color-text)' }}>{current.mark_scheme || current.model_answer || 'No model answer available.'}</div>
                        </div>

                        {/* Typing Practice */}
                        {typingSettings?.enabled ? (
                            <TypingPractice
                                text={current.mark_scheme || current.model_answer || 'No model answer available'}
                                onComplete={() => {
                                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                                    if (currentIndex < questions.length - 1) {
                                        setTimeout(() => setCurrentIndex(currentIndex + 1), 500);
                                    }
                                }}
                                settings={typingSettings}
                                label="Model Answer"
                            />
                        ) : (
                            <div
                                className="p-4 rounded-lg"
                                style={{
                                    background: theme === 'dark' ? 'rgba(234, 179, 8, 0.1)' : '#FEFCE8',
                                    color: '#CA8A04'
                                }}
                            >
                                Enable Typing Practice in Settings to practice typing answers.
                            </div>
                        )}
                    </div>
                );
            }

            if (currentIndex >= questions.length) {
                const percentage = stats.maxMarks > 0 ? Math.round(stats.marks / stats.maxMarks * 100) : 0;
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">{percentage >= 70 ? 'üåü' : percentage >= 50 ? 'üëç' : 'üìö'}</div>
                        <h3 className="text-2xl font-bold mb-2" style={{ color: 'var(--color-text)' }}>Quiz Complete!</h3>
                        <p className="text-xl mb-2" style={{ color: 'var(--color-text-secondary)' }}>
                            Score: {stats.marks}/{stats.maxMarks} marks ({percentage}%)
                        </p>
                        <p className="mb-6" style={{ color: 'var(--color-text-muted)' }}>
                            {stats.correct} of {stats.total} questions correct
                        </p>
                        <button
                            onClick={() => { setCurrentIndex(0); setStats({ correct: 0, total: 0, marks: 0, maxMarks: 0 }); }}
                            className="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600"
                        >
                            Try Again
                        </button>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto">
                    {/* Mode Toggle */}
                    <div className="flex justify-center gap-2 mb-6">
                        <button
                            onClick={() => setQuizMode('quiz')}
                            className="px-4 py-2 rounded-lg font-medium transition bg-green-500 text-white"
                        >
                            Quiz Mode
                        </button>
                        <button
                            onClick={() => setQuizMode('type')}
                            className="px-4 py-2 rounded-lg font-medium transition"
                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text-secondary)' }}
                        >
                            Type Mode
                        </button>
                    </div>

                    {/* Navigation Controls */}
                    <div className="flex items-center justify-center gap-4 mb-4">
                        <button
                            onClick={previousQuestion}
                            disabled={currentIndex === 0}
                            className="px-3 py-1 rounded-lg disabled:opacity-40 disabled:cursor-not-allowed transition"
                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                        >
                            ‚Üê Prev
                        </button>
                        <span style={{ color: 'var(--color-text-muted)' }}>
                            Question {currentIndex + 1} of {questions.length}
                        </span>
                        <button
                            onClick={nextQuestion}
                            disabled={currentIndex >= questions.length - 1 || !result}
                            className="px-3 py-1 rounded-lg disabled:opacity-40 disabled:cursor-not-allowed transition"
                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                        >
                            Next ‚Üí
                        </button>
                    </div>

                    <div className="flex justify-end mb-4">
                        <span
                            className="px-3 py-1 rounded-full text-sm font-medium"
                            style={{
                                background: theme === 'dark' ? 'rgba(45, 106, 79, 0.2)' : '#DCFCE7',
                                color: 'var(--color-success)'
                            }}
                        >
                            {current.assessment_objective || 'AO1'} ‚Ä¢ {current.marks} mark{current.marks > 1 ? 's' : ''}
                        </span>
                    </div>

                    <div className="p-6 rounded-lg mb-6" style={{ background: 'var(--color-bg-alt)' }}>
                        <h3 className="text-lg font-medium" style={{ color: 'var(--color-text)' }}>{current.question_text}</h3>
                    </div>

                    {!result ? (
                        <>
                            <textarea
                                value={answer}
                                onChange={(e) => setAnswer(e.target.value)}
                                placeholder="Type your answer here..."
                                className="w-full p-4 border rounded-lg mb-4 h-32 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                style={{
                                    background: 'var(--color-surface)',
                                    color: 'var(--color-text)',
                                    borderColor: 'var(--color-border)'
                                }}
                            />

                            {hint && (
                                <div
                                    className="p-4 rounded-lg mb-4 border"
                                    style={{
                                        background: theme === 'dark' ? 'rgba(234, 179, 8, 0.1)' : '#FEFCE8',
                                        borderColor: theme === 'dark' ? 'rgba(234, 179, 8, 0.3)' : '#FDE68A'
                                    }}
                                >
                                    <span className="text-yellow-500">üí° Hint: {hint}</span>
                                </div>
                            )}

                            <div className="flex justify-between">
                                <button
                                    onClick={getHint}
                                    disabled={hintLevel >= 3}
                                    className="text-yellow-500 hover:text-yellow-400 disabled:opacity-50"
                                >
                                    {hintLevel === 0 ? 'üí° Get Hint' : `üí° More Hints (${3 - hintLevel} left)`}
                                </button>

                                <button
                                    onClick={submitAnswer}
                                    disabled={loading || !answer.trim()}
                                    className="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600 disabled:opacity-50"
                                >
                                    {loading ? 'Checking...' : 'Submit Answer'}
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="space-y-4">
                            <div
                                className="p-4 rounded-lg border"
                                style={{
                                    background: result.is_correct
                                        ? (theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4')
                                        : (theme === 'dark' ? 'rgba(239, 68, 68, 0.1)' : '#FEF2F2'),
                                    borderColor: result.is_correct
                                        ? (theme === 'dark' ? 'rgba(45, 106, 79, 0.3)' : '#BBF7D0')
                                        : (theme === 'dark' ? 'rgba(239, 68, 68, 0.3)' : '#FECACA')
                                }}
                            >
                                <div className="flex items-center mb-2">
                                    <span className="text-2xl mr-2">{result.is_correct ? '‚úÖ' : '‚ùå'}</span>
                                    <span className="font-bold text-lg" style={{ color: 'var(--color-text)' }}>
                                        {result.marks_awarded}/{result.marks_possible} marks
                                    </span>
                                </div>
                                <p style={{ color: 'var(--color-text)' }}>{result.feedback}</p>
                            </div>

                            {result.correct_points?.length > 0 && (
                                <div
                                    className="p-4 rounded-lg"
                                    style={{ background: theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4' }}
                                >
                                    <h4 className="font-semibold mb-2" style={{ color: 'var(--color-success)' }}>‚úì Correct Points:</h4>
                                    <ul className="list-disc list-inside" style={{ color: 'var(--color-success)' }}>
                                        {result.correct_points.map((p, i) => <li key={i}>{p}</li>)}
                                    </ul>
                                </div>
                            )}

                            {result.missing_points?.length > 0 && (
                                <div
                                    className="p-4 rounded-lg"
                                    style={{ background: theme === 'dark' ? 'rgba(239, 68, 68, 0.1)' : '#FEF2F2' }}
                                >
                                    <h4 className="font-semibold text-red-500 mb-2">‚úó Missing Points:</h4>
                                    <ul className="list-disc list-inside text-red-400">
                                        {result.missing_points.map((p, i) => <li key={i}>{p}</li>)}
                                    </ul>
                                </div>
                            )}

                            {/* Model Answer with Type to Memorize */}
                            <div
                                className="p-4 rounded-lg"
                                style={{ background: theme === 'dark' ? 'rgba(59, 130, 246, 0.1)' : '#EFF6FF' }}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className="font-semibold text-blue-500">üìù Model Answer:</h4>
                                    {!isTypingReview && (
                                        <button
                                            onClick={() => setIsTypingReview(true)}
                                            className="text-sm bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition flex items-center gap-1"
                                        >
                                            ‚å®Ô∏è Type to Memorize
                                        </button>
                                    )}
                                </div>

                                {isTypingReview ? (
                                    <TypingPractice
                                        text={result.model_answer}
                                        onComplete={handleTypingComplete}
                                        onCancel={() => setIsTypingReview(false)}
                                        settings={typingSettings}
                                        label="Model Answer"
                                    />
                                ) : (
                                    <p style={{ color: 'var(--color-text)' }}>{result.model_answer}</p>
                                )}
                            </div>

                            {result.teacher_comment && (
                                <div
                                    className="p-4 rounded-lg"
                                    style={{ background: theme === 'dark' ? 'rgba(139, 92, 246, 0.1)' : '#FAF5FF' }}
                                >
                                    <h4 className="font-semibold text-purple-500 mb-2">üë©‚Äçüè´ Teacher Comment:</h4>
                                    <p style={{ color: 'var(--color-text)' }}>{result.teacher_comment}</p>
                                </div>
                            )}

                            <div className="flex justify-between pt-4">
                                <button
                                    onClick={generateSimilar}
                                    disabled={loading}
                                    className="text-blue-600 hover:text-blue-800 disabled:opacity-50"
                                >
                                    üîÑ Generate Similar Questions
                                </button>

                                <button
                                    onClick={nextQuestion}
                                    className="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600"
                                >
                                    Next Question ‚Üí
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Progress View Component
        function ProgressView() {
            const { theme } = useContext(ThemeContext);
            const [progress, setProgress] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/progress').then(data => {
                    setProgress(data);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading progress...</div>;

            const overall = progress?.overall || {};

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--color-text)' }}>üìä Your Progress</h2>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="p-6 rounded-xl shadow-lg" style={{ background: 'var(--color-surface)' }}>
                            <div className="text-4xl mb-2">üìù</div>
                            <div className="text-3xl font-bold" style={{ color: 'var(--color-text)' }}>{overall.questions_attempted || 0}</div>
                            <div style={{ color: 'var(--color-text-muted)' }}>Questions Attempted</div>
                        </div>

                        <div className="p-6 rounded-xl shadow-lg" style={{ background: 'var(--color-surface)' }}>
                            <div className="text-4xl mb-2">‚úÖ</div>
                            <div className="text-3xl font-bold" style={{ color: 'var(--color-success)' }}>{overall.questions_correct || 0}</div>
                            <div style={{ color: 'var(--color-text-muted)' }}>Correct Answers</div>
                        </div>

                        <div className="p-6 rounded-xl shadow-lg" style={{ background: 'var(--color-surface)' }}>
                            <div className="text-4xl mb-2">üéØ</div>
                            <div className="text-3xl font-bold" style={{ color: 'var(--color-primary)' }}>{overall.accuracy || 0}%</div>
                            <div style={{ color: 'var(--color-text-muted)' }}>Accuracy Rate</div>
                        </div>

                        <div className="p-6 rounded-xl shadow-lg" style={{ background: 'var(--color-surface)' }}>
                            <div className="text-4xl mb-2">üÉè</div>
                            <div className="text-3xl font-bold" style={{ color: 'var(--color-accent)' }}>{overall.definitions_studied || 0}</div>
                            <div style={{ color: 'var(--color-text-muted)' }}>Definitions Studied</div>
                        </div>
                    </div>

                    {progress?.weak_points_count > 0 && (
                        <div className="p-4 rounded-lg mb-6" style={{ background: 'rgba(212, 160, 23, 0.15)', border: '1px solid var(--color-accent)' }}>
                            <span style={{ color: 'var(--color-accent)' }}>
                                ‚ö†Ô∏è You have {progress.weak_points_count} weak point{progress.weak_points_count > 1 ? 's' : ''} to work on.
                                Check the Weak Points section!
                            </span>
                        </div>
                    )}

                    <div className="rounded-xl shadow-lg overflow-hidden" style={{ background: 'var(--color-surface)' }}>
                        <h3 className="text-xl font-bold p-6" style={{ color: 'var(--color-text)', borderBottom: '1px solid var(--color-border)' }}>Progress by Topic</h3>

                        <div style={{ borderColor: 'var(--color-border)' }}>
                            {progress?.by_topic?.map((item, i) => (
                                <div key={i} className="p-4 flex items-center justify-between" style={{ borderBottom: '1px solid var(--color-border)' }}>
                                    <div>
                                        <span className="font-semibold" style={{ color: 'var(--color-success)' }}>{item.topic_number}</span>
                                        <span className="ml-2" style={{ color: 'var(--color-text)' }}>{item.topic_name}</span>
                                    </div>
                                    <div className="flex items-center space-x-6">
                                        <div className="text-sm" style={{ color: 'var(--color-text-muted)' }}>
                                            {item.questions_correct}/{item.questions_attempted} correct
                                        </div>
                                        <div className="w-32 rounded-full h-2" style={{ background: 'var(--color-border)' }}>
                                            <div
                                                className="h-2 rounded-full"
                                                style={{ width: `${item.questions_attempted > 0 ? (item.questions_correct / item.questions_attempted * 100) : 0}%`, background: 'var(--color-success)' }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            ))}

                            {(!progress?.by_topic || progress.by_topic.length === 0) && (
                                <div className="p-8 text-center" style={{ color: 'var(--color-text-muted)' }}>
                                    No progress yet. Start studying to track your learning!
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Weak Points View Component
        function WeakPointsView() {
            const { theme } = useContext(ThemeContext);
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/weak-points').then(result => {
                    setData(result);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading weak points...</div>;

            const weakPoints = data?.weak_points || [];

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--color-text)' }}>üéØ Weak Points</h2>

                    {data?.analysis && (
                        <div className="p-6 rounded-xl mb-6" style={{ background: 'rgba(212, 160, 23, 0.1)', border: '1px solid var(--color-accent)' }}>
                            <h3 className="font-bold mb-2" style={{ color: 'var(--color-accent)' }}>ü§ñ AI Analysis</h3>
                            <p className="whitespace-pre-line" style={{ color: 'var(--color-text)' }}>{data.analysis}</p>
                        </div>
                    )}

                    {weakPoints.length === 0 ? (
                        <div className="p-8 rounded-xl text-center" style={{ background: 'rgba(45, 106, 79, 0.1)' }}>
                            <div className="text-6xl mb-4">üåü</div>
                            <h3 className="text-xl font-bold" style={{ color: 'var(--color-text)' }}>No weak points!</h3>
                            <p style={{ color: 'var(--color-text-secondary)' }}>Keep up the great work!</p>
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {weakPoints.map((wp, i) => (
                                <div key={i} className="p-4 rounded-xl shadow-lg border-l-4" style={{ background: 'var(--color-surface)', borderColor: 'var(--color-error)' }}>
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="px-2 py-1 rounded text-sm" style={{ background: 'rgba(197, 48, 48, 0.15)', color: 'var(--color-error)' }}>
                                            {wp.failure_count}x incorrect
                                        </span>
                                        <span className="text-sm" style={{ color: 'var(--color-text-muted)' }}>{wp.topic}</span>
                                    </div>

                                    {wp.type === 'definition' && (
                                        <div>
                                            <p className="font-semibold" style={{ color: 'var(--color-text)' }}>{wp.term}</p>
                                            <p style={{ color: 'var(--color-text-secondary)' }}>{wp.definition}</p>
                                        </div>
                                    )}

                                    {wp.type === 'question' && (
                                        <div>
                                            <p className="font-semibold" style={{ color: 'var(--color-text)' }}>{wp.question}</p>
                                            <details className="mt-2">
                                                <summary className="cursor-pointer" style={{ color: 'var(--color-success)' }}>Show model answer</summary>
                                                <p className="mt-2" style={{ color: 'var(--color-text-secondary)' }}>{wp.model_answer}</p>
                                            </details>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Settings View Component - ENHANCED with Typing Settings
        function SettingsView({ typingSettings, onTypingSettingsChange }) {
            const { theme } = useContext(ThemeContext);
            const [settings, setSettings] = useState(null);
            const [models, setModels] = useState({});
            const [loading, setLoading] = useState(true);
            const [validating, setValidating] = useState({});
            const [saveStatus, setSaveStatus] = useState({});
            const [activeSection, setActiveSection] = useState('ai'); // 'ai' or 'typing'

            const [formData, setFormData] = useState({
                default_provider: 'claude',
                claude_model: 'claude-haiku-4-5-20251001',
                claude_api_key: '',
                claude_validated: false,
                gemini_model: 'gemini-2.0-flash',
                gemini_api_key: '',
                gemini_validated: false,
                openai_model: 'gpt-4o-mini',
                openai_api_key: '',
                openai_validated: false
            });

            useEffect(() => {
                api.get('/ai/settings').then(data => {
                    if (data?.settings) {
                        setSettings(data.settings);
                        setFormData({
                            default_provider: data.settings.default_provider || 'claude',
                            claude_model: data.settings.claude_model || 'claude-haiku-4-5-20251001',
                            claude_api_key: data.settings.claude_api_key || '',
                            claude_validated: data.settings.claude_validated || false,
                            gemini_model: data.settings.gemini_model || 'gemini-2.0-flash',
                            gemini_api_key: data.settings.gemini_api_key || '',
                            gemini_validated: data.settings.gemini_validated || false,
                            openai_model: data.settings.openai_model || 'gpt-4o-mini',
                            openai_api_key: data.settings.openai_api_key || '',
                            openai_validated: data.settings.openai_validated || false
                        });
                    }
                    if (data?.models) setModels(data.models);
                    setLoading(false);
                });
            }, []);

            const autoSave = async (field, value) => {
                setSaveStatus(prev => ({ ...prev, [field]: 'saving' }));
                await api.put('/ai/settings', { [field]: value });
                setSaveStatus(prev => ({ ...prev, [field]: 'saved' }));
                setTimeout(() => setSaveStatus(prev => ({ ...prev, [field]: null })), 2000);
            };

            const handleModelChange = async (provider, modelId) => {
                setFormData(prev => ({ ...prev, [`${provider}_model`]: modelId }));
                await autoSave(`${provider}_model`, modelId);
            };

            const handleSetDefault = async (provider) => {
                setFormData(prev => ({ ...prev, default_provider: provider }));
                await autoSave('default_provider', provider);
            };

            const handleValidate = async (provider) => {
                setValidating(prev => ({ ...prev, [provider]: true }));

                const keyField = `${provider}_api_key`;
                const apiKey = formData[keyField];

                if (!apiKey || apiKey.startsWith('‚Ä¢')) {
                    alert('Please enter an API key first');
                    setValidating(prev => ({ ...prev, [provider]: false }));
                    return;
                }

                const result = await api.post('/ai/validate-key', { provider, api_key: apiKey });

                if (result?.valid) {
                    setFormData(prev => ({
                        ...prev,
                        [`${provider}_validated`]: true,
                        [`${provider}_api_key`]: '‚Ä¢'.repeat(20) + apiKey.slice(-4)
                    }));
                    if (result.models) {
                        console.log(`[AI Settings] ${provider} models received:`, result.models.length, 'models');
                        console.log(`[AI Settings] ${provider} model list:`, result.models.map(m => m.id).join(', '));
                        setModels(prev => ({ ...prev, [provider]: result.models }));
                    }
                    alert(`‚úÖ ${provider.charAt(0).toUpperCase() + provider.slice(1)} API key validated and saved!`);
                } else {
                    alert(`‚ùå Invalid API key: ${result?.error || 'Unknown error'}`);
                }

                setValidating(prev => ({ ...prev, [provider]: false }));
            };

            const handleKeyChange = (provider, value) => {
                setFormData(prev => ({
                    ...prev,
                    [`${provider}_api_key`]: value,
                    [`${provider}_validated`]: value.startsWith('‚Ä¢') ? prev[`${provider}_validated`] : false
                }));
            };

            const [reloading, setReloading] = useState({});

            const handleReloadModels = async (provider) => {
                setReloading(prev => ({ ...prev, [provider]: true }));
                try {
                    // Call the dynamic models endpoint
                    const data = await api.get(`/ai/models/${provider}`);
                    console.log(`[AI Settings] Reload ${provider} models response:`, data);
                    if (data?.models?.length > 0) {
                        console.log(`[AI Settings] Reload ${provider} - ${data.models.length} models:`, data.models.map(m => m.id).join(', '));
                        setModels(prev => ({ ...prev, [provider]: data.models }));
                    } else {
                        console.log(`[AI Settings] Reload ${provider} - no models returned, keeping current list`);
                    }
                } catch (err) {
                    console.error('[AI Settings] Failed to reload models:', err);
                }
                setReloading(prev => ({ ...prev, [provider]: false }));
            };

            if (loading) return <div className="text-center py-8">Loading settings...</div>;

            const providers = [
                { id: 'claude', name: 'Claude', company: 'Anthropic', icon: 'üîÆ', color: 'purple', url: 'https://console.anthropic.com' },
                { id: 'gemini', name: 'Gemini', company: 'Google', icon: 'üíé', color: 'blue', url: 'https://aistudio.google.com/apikey' },
                { id: 'openai', name: 'OpenAI', company: 'OpenAI', icon: 'ü§ñ', color: 'green', url: 'https://platform.openai.com/api-keys' }
            ];

            return (
                <div className="max-w-5xl mx-auto p-6">
                    <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--color-text)' }}>‚öôÔ∏è Settings</h2>

                    {/* Section Tabs */}
                    <div className="flex gap-2 mb-6">
                        <button
                            onClick={() => setActiveSection('ai')}
                            className="px-4 py-2 rounded-lg font-medium transition"
                            style={{
                                background: activeSection === 'ai' ? 'var(--color-success)' : 'var(--color-bg-alt)',
                                color: activeSection === 'ai' ? '#FFFFFF' : 'var(--color-text-secondary)'
                            }}
                        >
                            ü§ñ AI Providers
                        </button>
                        <button
                            onClick={() => setActiveSection('typing')}
                            className="px-4 py-2 rounded-lg font-medium transition"
                            style={{
                                background: activeSection === 'typing' ? 'var(--color-success)' : 'var(--color-bg-alt)',
                                color: activeSection === 'typing' ? '#FFFFFF' : 'var(--color-text-secondary)'
                            }}
                        >
                            ‚å®Ô∏è Typing Practice
                        </button>
                    </div>

                    {activeSection === 'ai' ? (
                        <div className="grid gap-6">
                            {providers.map(provider => {
                                const isDefault = formData.default_provider === provider.id;
                                const isValidated = formData[`${provider.id}_validated`];
                                const currentModel = formData[`${provider.id}_model`];
                                const providerModels = models[provider.id] || [];

                                return (
                                    <div
                                        key={provider.id}
                                        className="rounded-xl shadow-lg p-6 border-2"
                                        style={{
                                            background: 'var(--color-surface)',
                                            borderColor: isDefault ? 'var(--color-success)' : 'transparent'
                                        }}
                                    >
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center space-x-3">
                                                <span className="text-3xl">{provider.icon}</span>
                                                <div>
                                                    <h3 className="text-xl font-bold" style={{ color: 'var(--color-text)' }}>{provider.name}</h3>
                                                    <span className="text-sm" style={{ color: 'var(--color-text-muted)' }}>{provider.company}</span>
                                                </div>
                                                {isValidated && <span className="px-2 py-1 rounded text-sm" style={{ background: 'rgba(45, 106, 79, 0.15)', color: 'var(--color-success)' }}>‚úì Connected</span>}
                                            </div>
                                            <button
                                                onClick={() => handleSetDefault(provider.id)}
                                                className="px-4 py-2 rounded-lg font-medium transition"
                                                style={{
                                                    background: isDefault ? 'var(--color-success)' : 'var(--color-bg-alt)',
                                                    color: isDefault ? '#FFFFFF' : 'var(--color-text-secondary)'
                                                }}
                                            >
                                                {isDefault ? '‚òÖ Default' : 'Set as Default'}
                                            </button>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block font-medium mb-2" style={{ color: 'var(--color-text)' }}>API Key</label>
                                                <div className="flex space-x-2">
                                                    <input
                                                        type="password"
                                                        value={formData[`${provider.id}_api_key`]}
                                                        onChange={(e) => handleKeyChange(provider.id, e.target.value)}
                                                        placeholder={`Enter ${provider.name} API key`}
                                                        className="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        style={{ background: 'var(--color-bg)', color: 'var(--color-text)', borderColor: 'var(--color-border)' }}
                                                    />
                                                    <button
                                                        onClick={() => handleValidate(provider.id)}
                                                        disabled={validating[provider.id]}
                                                        className="px-4 py-2 rounded-lg font-medium transition disabled:opacity-50"
                                                        style={{
                                                            background: isValidated ? 'rgba(45, 106, 79, 0.15)' : 'var(--color-primary)',
                                                            color: isValidated ? 'var(--color-success)' : '#FFFFFF'
                                                        }}
                                                    >
                                                        {validating[provider.id] ? '...' : isValidated ? 'Re-validate' : 'Validate'}
                                                    </button>
                                                </div>
                                                <a href={provider.url} target="_blank" rel="noopener" className="text-xs hover:underline mt-1 inline-block" style={{ color: 'var(--color-accent)' }}>
                                                    Get API key ‚Üí
                                                </a>
                                            </div>

                                            <div>
                                                <label className="block font-medium mb-2" style={{ color: 'var(--color-text)' }}>
                                                    Model
                                                    {saveStatus[`${provider.id}_model`] === 'saving' && <span className="ml-2 text-sm" style={{ color: 'var(--color-text-muted)' }}>Saving...</span>}
                                                    {saveStatus[`${provider.id}_model`] === 'saved' && <span className="ml-2 text-sm" style={{ color: 'var(--color-success)' }}>‚úì Saved</span>}
                                                </label>
                                                <div className="flex space-x-2">
                                                    <select
                                                        value={currentModel}
                                                        onChange={(e) => handleModelChange(provider.id, e.target.value)}
                                                        disabled={!isValidated && providerModels.length === 0}
                                                        className="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        style={{
                                                            background: !isValidated && providerModels.length === 0 ? 'var(--color-bg-alt)' : 'var(--color-bg)',
                                                            color: !isValidated && providerModels.length === 0 ? 'var(--color-text-muted)' : 'var(--color-text)',
                                                            borderColor: 'var(--color-border)'
                                                        }}
                                                    >
                                                        {providerModels.length > 0 ? (
                                                            providerModels.map(model => (
                                                                <option key={model.id} value={model.id}>
                                                                    {model.name} {model.description ? `- ${model.description}` : ''}
                                                                </option>
                                                            ))
                                                        ) : (
                                                            <option value={currentModel}>Validate API key to see models</option>
                                                        )}
                                                    </select>
                                                    <button
                                                        onClick={() => handleReloadModels(provider.id)}
                                                        disabled={reloading[provider.id]}
                                                        title="Reload model list"
                                                        className="px-3 py-2 rounded-lg transition disabled:opacity-50"
                                                        style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text-secondary)' }}
                                                    >
                                                        {reloading[provider.id] ? '...' : '‚Üª'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}

                            <div className="p-4 rounded-lg" style={{ background: 'rgba(212, 160, 23, 0.1)' }}>
                                <h4 className="font-semibold mb-2" style={{ color: 'var(--color-accent)' }}>üí° Tips:</h4>
                                <ul className="text-sm space-y-1" style={{ color: 'var(--color-text-secondary)' }}>
                                    <li>‚Ä¢ The <b>default provider</b> will be used for AI marking and question generation</li>
                                    <li>‚Ä¢ <b>Claude Haiku</b> is recommended for fast, cost-effective responses</li>
                                    <li>‚Ä¢ <b>Gemini Flash</b> is a good free alternative</li>
                                    <li>‚Ä¢ Settings are auto-saved when you change the model or default provider</li>
                                </ul>
                            </div>
                        </div>
                    ) : (
                        <div className="rounded-xl shadow-lg p-6" style={{ background: 'var(--color-surface)' }}>
                            <h3 className="text-xl font-bold mb-6 flex items-center gap-2" style={{ color: 'var(--color-text)' }}>
                                ‚å®Ô∏è Typing Practice Settings
                            </h3>

                            <div className="space-y-6">
                                {/* Enable/Disable */}
                                <div className="flex items-center justify-between p-4 rounded-lg" style={{ background: 'var(--color-bg-alt)' }}>
                                    <div>
                                        <div className="font-medium" style={{ color: 'var(--color-text)' }}>Enable Typing Mode</div>
                                        <div className="text-sm" style={{ color: 'var(--color-text-muted)' }}>Practice definitions and answers by typing them</div>
                                    </div>
                                    <button
                                        onClick={() => onTypingSettingsChange({ ...typingSettings, enabled: !typingSettings.enabled })}
                                        className="w-14 h-8 rounded-full transition-colors relative"
                                        style={{ background: typingSettings.enabled ? 'var(--color-success)' : 'var(--color-border)' }}
                                    >
                                        <div className={`absolute w-6 h-6 bg-white rounded-full top-1 transition-transform ${
                                            typingSettings.enabled ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>

                                {/* Memory Duration */}
                                <div className="p-4 rounded-lg" style={{ background: 'var(--color-bg-alt)' }}>
                                    <div className="flex items-center justify-between mb-3">
                                        <div>
                                            <div className="font-medium" style={{ color: 'var(--color-text)' }}>Memory Timer</div>
                                            <div className="text-sm" style={{ color: 'var(--color-text-muted)' }}>How long to show text before hiding it</div>
                                        </div>
                                        <span className="text-lg font-mono font-bold" style={{ color: 'var(--color-success)' }}>{typingSettings.memoryDuration}s</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="3"
                                        max="30"
                                        step="1"
                                        value={typingSettings.memoryDuration}
                                        onChange={(e) => onTypingSettingsChange({ ...typingSettings, memoryDuration: parseInt(e.target.value) })}
                                        className="w-full accent-green-500"
                                    />
                                    <div className="flex justify-between text-xs mt-1" style={{ color: 'var(--color-text-muted)' }}>
                                        <span>3s (Hard)</span>
                                        <span>30s (Easy)</span>
                                    </div>
                                </div>

                                {/* Stuck Timeout */}
                                <div className="p-4 rounded-lg" style={{ background: 'var(--color-bg-alt)' }}>
                                    <div className="flex items-center justify-between mb-3">
                                        <div>
                                            <div className="font-medium" style={{ color: 'var(--color-text)' }}>Hint Delay</div>
                                            <div className="text-sm" style={{ color: 'var(--color-text-muted)' }}>How long before showing a hint when stuck</div>
                                        </div>
                                        <span className="text-lg font-mono font-bold" style={{ color: 'var(--color-accent)' }}>{typingSettings.stuckTimeout}s</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="1"
                                        max="10"
                                        step="1"
                                        value={typingSettings.stuckTimeout}
                                        onChange={(e) => onTypingSettingsChange({ ...typingSettings, stuckTimeout: parseInt(e.target.value) })}
                                        className="w-full accent-yellow-500"
                                    />
                                    <div className="flex justify-between text-xs mt-1" style={{ color: 'var(--color-text-muted)' }}>
                                        <span>1s (Quick hints)</span>
                                        <span>10s (Challenge mode)</span>
                                    </div>
                                </div>

                                {/* Sound Effects */}
                                <div className="flex items-center justify-between p-4 rounded-lg" style={{ background: 'var(--color-bg-alt)' }}>
                                    <div>
                                        <div className="font-medium" style={{ color: 'var(--color-text)' }}>üîä Sound Effects</div>
                                        <div className="text-sm" style={{ color: 'var(--color-text-muted)' }}>Key clicks, dings, and celebration sounds</div>
                                    </div>
                                    <button
                                        onClick={() => onTypingSettingsChange({ ...typingSettings, soundEnabled: !typingSettings.soundEnabled })}
                                        className="w-14 h-8 rounded-full transition-colors relative"
                                        style={{ background: typingSettings.soundEnabled ? 'var(--color-success)' : 'var(--color-border)' }}
                                    >
                                        <div className={`absolute w-6 h-6 bg-white rounded-full top-1 transition-transform ${
                                            typingSettings.soundEnabled ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>

                                {/* TTS */}
                                <div className="flex items-center justify-between p-4 rounded-lg" style={{ background: 'var(--color-bg-alt)' }}>
                                    <div>
                                        <div className="font-medium" style={{ color: 'var(--color-text)' }}>üó£Ô∏è Text-to-Speech</div>
                                        <div className="text-sm" style={{ color: 'var(--color-text-muted)' }}>Read definitions aloud before typing</div>
                                    </div>
                                    <button
                                        onClick={() => onTypingSettingsChange({ ...typingSettings, ttsEnabled: !typingSettings.ttsEnabled })}
                                        className="w-14 h-8 rounded-full transition-colors relative"
                                        style={{ background: typingSettings.ttsEnabled ? 'var(--color-success)' : 'var(--color-border)' }}
                                    >
                                        <div className={`absolute w-6 h-6 bg-white rounded-full top-1 transition-transform ${
                                            typingSettings.ttsEnabled ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>
                            </div>

                            <div className="mt-6 p-4 rounded-lg" style={{ background: 'rgba(45, 106, 79, 0.1)' }}>
                                <h4 className="font-semibold mb-2" style={{ color: 'var(--color-success)' }}>üí° How Typing Practice Works:</h4>
                                <ul className="text-sm space-y-1" style={{ color: 'var(--color-text-secondary)' }}>
                                    <li>1. <b>Show</b> - Read and memorize the definition</li>
                                    <li>2. <b>Dim</b> - Text fades after the timer (or first keystroke)</li>
                                    <li>3. <b>Type</b> - Reproduce from memory</li>
                                    <li>4. <b>Hint</b> - If stuck, the next word appears</li>
                                    <li>5. <b>Celebrate</b> - Confetti when you nail it! üéâ</li>
                                </ul>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================
        // NEW FEATURE COMPONENTS
        // ============================================

        // Exam Practice View - Practice with real exam questions
        function ExamPracticeView() {
            const { theme } = useContext(ThemeContext);
            const [questions, setQuestions] = useState([]);
            const [topics, setTopics] = useState([]);
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/topics').then(data => {
                    const allTopics = [];
                    (data || []).forEach(theme => {
                        theme.topics.forEach(t => allTopics.push({...t, theme_name: theme.theme_name}));
                    });
                    setTopics(allTopics);
                    setLoading(false);
                });
            }, []);

            const loadQuestions = async (topicId) => {
                setLoading(true);
                const data = await api.get(`/exam-questions/${topicId}`);
                setQuestions(data || []);
                setCurrentQuestion(0);
                setShowAnswer(false);
                setSelectedTopic(topicId);
                setLoading(false);
            };

            if (loading) return <div className="text-center py-8">Loading...</div>;

            if (!selectedTopic) {
                return (
                    <div className="max-w-6xl mx-auto p-6">
                        <h2 className="text-3xl font-bold mb-2" style={{ color: 'var(--color-text)' }}>üìù Exam Practice</h2>
                        <p className="mb-6" style={{ color: 'var(--color-text-secondary)' }}>Practice with real IGCSE exam-style questions and model answers</p>

                        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            {topics.map(topic => (
                                <button
                                    key={topic.id}
                                    onClick={() => loadQuestions(topic.id)}
                                    className="p-4 rounded-lg shadow hover:shadow-lg transition border-l-4 border-blue-500 text-left"
                                    style={{ background: 'var(--color-surface)' }}
                                >
                                    <span className="font-bold text-blue-600">{topic.topic_number}</span>
                                    <span className="ml-2" style={{ color: 'var(--color-text)' }}>{topic.topic_name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (questions.length === 0) {
                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <button onClick={() => setSelectedTopic(null)} className="mb-4 text-blue-600 hover:text-blue-800">
                            ‚Üê Back to topics
                        </button>
                        <div className="text-center py-12 rounded-lg" style={{ background: 'var(--color-surface)' }}>
                            <p style={{ color: 'var(--color-text-muted)' }}>No exam questions available for this topic yet.</p>
                        </div>
                    </div>
                );
            }

            const q = questions[currentQuestion];

            return (
                <div className="max-w-4xl mx-auto p-6">
                    <button onClick={() => setSelectedTopic(null)} className="mb-4 text-blue-600 hover:text-blue-800">
                        ‚Üê Back to topics
                    </button>

                    <div className="rounded-xl shadow-lg overflow-hidden" style={{ background: 'var(--color-surface)' }}>
                        <div className="bg-gradient-to-r from-blue-500 to-indigo-500 p-4 flex justify-between items-center">
                            <h3 className="text-white font-bold">Question {currentQuestion + 1} of {questions.length}</h3>
                            <span className="bg-white/20 text-white px-3 py-1 rounded-full text-sm">
                                [{q.marks} marks]
                            </span>
                        </div>

                        <div className="p-6">
                            <p className="text-lg mb-6" style={{ color: 'var(--color-text)' }}>{q.question}</p>

                            {q.command_word && (
                                <div
                                    className="mb-4 inline-block px-3 py-1 rounded text-sm"
                                    style={{
                                        background: theme === 'dark' ? 'rgba(59, 130, 246, 0.2)' : '#DBEAFE',
                                        color: theme === 'dark' ? '#93C5FD' : '#1E40AF'
                                    }}
                                >
                                    Command word: <strong>{q.command_word}</strong>
                                </div>
                            )}

                            {!showAnswer ? (
                                <button
                                    onClick={() => setShowAnswer(true)}
                                    className="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                                >
                                    Show Model Answer
                                </button>
                            ) : (
                                <div className="mt-4">
                                    <h4 className="font-bold mb-2" style={{ color: 'var(--color-success)' }}>‚úì Model Answer:</h4>
                                    <div
                                        className="rounded-lg p-4 border"
                                        style={{
                                            background: theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4',
                                            borderColor: theme === 'dark' ? 'rgba(45, 106, 79, 0.3)' : '#BBF7D0'
                                        }}
                                    >
                                        <p className="whitespace-pre-line" style={{ color: 'var(--color-text)' }}>{q.model_answer}</p>
                                    </div>
                                </div>
                            )}

                            <div className="flex justify-between mt-6">
                                <button
                                    onClick={() => { setCurrentQuestion(Math.max(0, currentQuestion - 1)); setShowAnswer(false); }}
                                    disabled={currentQuestion === 0}
                                    className="px-4 py-2 rounded disabled:opacity-50"
                                    style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                                >
                                    ‚Üê Previous
                                </button>
                                <button
                                    onClick={() => { setCurrentQuestion(Math.min(questions.length - 1, currentQuestion + 1)); setShowAnswer(false); }}
                                    disabled={currentQuestion === questions.length - 1}
                                    className="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
                                >
                                    Next ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Case Studies View - Browse all case studies
        function CaseStudiesView() {
            const { theme } = useContext(ThemeContext);
            const [caseStudies, setCaseStudies] = useState([]);
            const [topics, setTopics] = useState({});
            const [selectedCase, setSelectedCase] = useState(null);
            const [filter, setFilter] = useState('all');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api.get('/case-studies'),
                    api.get('/topics')
                ]).then(([cases, topicsData]) => {
                    setCaseStudies(cases || []);
                    const topicMap = {};
                    (topicsData || []).forEach(theme => {
                        theme.topics.forEach(t => topicMap[t.id] = t);
                    });
                    setTopics(topicMap);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading case studies...</div>;

            const categories = [...new Set(caseStudies.map(c => c.category).filter(Boolean))];
            const filtered = filter === 'all' ? caseStudies : caseStudies.filter(c => c.category === filter);

            if (selectedCase) {
                const c = selectedCase;
                const keyFacts = c.key_facts ? (typeof c.key_facts === 'string' ? JSON.parse(c.key_facts) : c.key_facts) : [];

                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <button onClick={() => setSelectedCase(null)} className="mb-4 text-green-600 hover:text-green-800">
                            ‚Üê Back to case studies
                        </button>

                        <div className="rounded-xl shadow-lg overflow-hidden" style={{ background: 'var(--color-surface)' }}>
                            <div className="bg-gradient-to-r from-green-500 to-teal-500 p-6">
                                <h2 className="text-2xl font-bold text-white">{c.name}</h2>
                                <p className="text-white/80 mt-1">üìç {c.location}</p>
                            </div>

                            <div className="p-6 space-y-6">
                                {c.overview && (
                                    <div>
                                        <h3 className="font-bold mb-2" style={{ color: 'var(--color-text)' }}>üìã Overview</h3>
                                        <p style={{ color: 'var(--color-text-secondary)' }}>{c.overview}</p>
                                    </div>
                                )}

                                {c.causes && (
                                    <div>
                                        <h3 className="font-bold text-red-500 mb-2">‚ö†Ô∏è Causes</h3>
                                        <p
                                            className="p-3 rounded"
                                            style={{
                                                background: theme === 'dark' ? 'rgba(239, 68, 68, 0.1)' : '#FEF2F2',
                                                color: 'var(--color-text)'
                                            }}
                                        >{c.causes}</p>
                                    </div>
                                )}

                                {c.effects && (
                                    <div>
                                        <h3 className="font-bold text-orange-500 mb-2">üí• Effects</h3>
                                        <p
                                            className="p-3 rounded"
                                            style={{
                                                background: theme === 'dark' ? 'rgba(249, 115, 22, 0.1)' : '#FFF7ED',
                                                color: 'var(--color-text)'
                                            }}
                                        >{c.effects}</p>
                                    </div>
                                )}

                                {c.solutions && (
                                    <div>
                                        <h3 className="font-bold mb-2" style={{ color: 'var(--color-success)' }}>‚úÖ Solutions/Responses</h3>
                                        <p
                                            className="p-3 rounded"
                                            style={{
                                                background: theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4',
                                                color: 'var(--color-text)'
                                            }}
                                        >{c.solutions}</p>
                                    </div>
                                )}

                                {keyFacts.length > 0 && (
                                    <div>
                                        <h3 className="font-bold text-blue-500 mb-2">üìä Key Facts (Exam Ready)</h3>
                                        <ul
                                            className="p-4 rounded space-y-2"
                                            style={{ background: theme === 'dark' ? 'rgba(59, 130, 246, 0.1)' : '#EFF6FF' }}
                                        >
                                            {keyFacts.map((fact, i) => (
                                                <li key={i} className="flex items-start">
                                                    <span className="text-blue-500 mr-2">‚Ä¢</span>
                                                    <span style={{ color: 'var(--color-text)' }}>{fact}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {c.exam_relevance && (
                                    <div
                                        className="p-4 rounded border"
                                        style={{
                                            background: theme === 'dark' ? 'rgba(139, 92, 246, 0.1)' : '#FAF5FF',
                                            borderColor: theme === 'dark' ? 'rgba(139, 92, 246, 0.3)' : '#E9D5FF'
                                        }}
                                    >
                                        <h3 className="font-bold text-purple-500 mb-1">üéØ Exam Relevance</h3>
                                        <p style={{ color: 'var(--color-text)' }}>{c.exam_relevance}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold mb-2" style={{ color: 'var(--color-text)' }}>üåç Case Studies</h2>
                    <p className="mb-6" style={{ color: 'var(--color-text-secondary)' }}>Essential case studies for your IGCSE Geography exam</p>

                    <div className="mb-6 flex flex-wrap gap-2">
                        <button
                            onClick={() => setFilter('all')}
                            className="px-4 py-2 rounded-full transition"
                            style={{
                                background: filter === 'all' ? 'var(--color-success)' : 'var(--color-bg-alt)',
                                color: filter === 'all' ? '#FFFFFF' : 'var(--color-text)'
                            }}
                        >
                            All ({caseStudies.length})
                        </button>
                        {categories.map(cat => (
                            <button
                                key={cat}
                                onClick={() => setFilter(cat)}
                                className="px-4 py-2 rounded-full transition capitalize"
                                style={{
                                    background: filter === cat ? 'var(--color-success)' : 'var(--color-bg-alt)',
                                    color: filter === cat ? '#FFFFFF' : 'var(--color-text)'
                                }}
                            >
                                {cat}
                            </button>
                        ))}
                    </div>

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {filtered.map(c => (
                            <button
                                key={c.id}
                                onClick={() => setSelectedCase(c)}
                                className="p-4 rounded-lg shadow hover:shadow-lg transition text-left border-l-4 border-green-500"
                                style={{ background: 'var(--color-surface)' }}
                            >
                                <h3 className="font-bold" style={{ color: 'var(--color-text)' }}>{c.name}</h3>
                                <p className="text-sm" style={{ color: 'var(--color-text-muted)' }}>üìç {c.location}</p>
                                {c.category && (
                                    <span
                                        className="inline-block mt-2 text-xs px-2 py-1 rounded capitalize"
                                        style={{
                                            background: theme === 'dark' ? 'rgba(45, 106, 79, 0.2)' : '#DCFCE7',
                                            color: 'var(--color-success)'
                                        }}
                                    >
                                        {c.category}
                                    </span>
                                )}
                                {topics[c.topic_id] && (
                                    <p className="text-xs mt-1" style={{ color: 'var(--color-text-muted)' }}>
                                        Topic {topics[c.topic_id].topic_number}
                                    </p>
                                )}
                            </button>
                        ))}
                    </div>

                    {filtered.length === 0 && (
                        <div className="text-center py-12" style={{ color: 'var(--color-text-muted)' }}>
                            No case studies found for this category.
                        </div>
                    )}
                </div>
            );
        }

        // Study Guide View - Tips and Common Errors
        function StudyGuideView() {
            const { theme } = useContext(ThemeContext);
            const [tips, setTips] = useState([]);
            const [errors, setErrors] = useState([]);
            const [topics, setTopics] = useState({});
            const [activeTab, setActiveTab] = useState('tips');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api.get('/tips'),
                    api.get('/common-errors'),
                    api.get('/topics')
                ]).then(([tipsData, errorsData, topicsData]) => {
                    setTips(tipsData || []);
                    setErrors(errorsData || []);
                    const topicMap = {};
                    (topicsData || []).forEach(theme => {
                        theme.topics.forEach(t => topicMap[t.id] = t);
                    });
                    setTopics(topicMap);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading study guide...</div>;

            // Group tips by type
            const examTips = tips.filter(t => t.tip_type === 'exam');
            const studyTips = tips.filter(t => t.tip_type === 'study');

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold mb-2" style={{ color: 'var(--color-text)' }}>üí° Study Guide</h2>
                    <p className="mb-6" style={{ color: 'var(--color-text-secondary)' }}>Expert tips and common mistakes to avoid</p>

                    <div className="flex gap-4 mb-6">
                        <button
                            onClick={() => setActiveTab('tips')}
                            className="px-6 py-3 rounded-lg font-semibold transition"
                            style={{
                                background: activeTab === 'tips' ? '#EAB308' : 'var(--color-bg-alt)',
                                color: activeTab === 'tips' ? '#FFFFFF' : 'var(--color-text)'
                            }}
                        >
                            üí° Tips ({tips.length})
                        </button>
                        <button
                            onClick={() => setActiveTab('errors')}
                            className="px-6 py-3 rounded-lg font-semibold transition"
                            style={{
                                background: activeTab === 'errors' ? '#EF4444' : 'var(--color-bg-alt)',
                                color: activeTab === 'errors' ? '#FFFFFF' : 'var(--color-text)'
                            }}
                        >
                            ‚ö†Ô∏è Common Errors ({errors.length})
                        </button>
                    </div>

                    {activeTab === 'tips' && (
                        <div className="space-y-6">
                            {examTips.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-blue-500 mb-4">üìù Exam Tips</h3>
                                    <div className="grid gap-4 md:grid-cols-2">
                                        {examTips.map(tip => (
                                            <div
                                                key={tip.id}
                                                className="p-4 rounded-lg border"
                                                style={{
                                                    background: theme === 'dark' ? 'rgba(59, 130, 246, 0.1)' : '#EFF6FF',
                                                    borderColor: theme === 'dark' ? 'rgba(59, 130, 246, 0.3)' : '#BFDBFE'
                                                }}
                                            >
                                                <p style={{ color: 'var(--color-text)' }}>{tip.tip_text}</p>
                                                {topics[tip.topic_id] && (
                                                    <p className="text-xs text-blue-500 mt-2">
                                                        Topic {topics[tip.topic_id].topic_number}: {topics[tip.topic_id].topic_name}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {studyTips.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-yellow-500 mb-4">üìö Study Tips</h3>
                                    <div className="grid gap-4 md:grid-cols-2">
                                        {studyTips.map(tip => (
                                            <div
                                                key={tip.id}
                                                className="p-4 rounded-lg border"
                                                style={{
                                                    background: theme === 'dark' ? 'rgba(234, 179, 8, 0.1)' : '#FEFCE8',
                                                    borderColor: theme === 'dark' ? 'rgba(234, 179, 8, 0.3)' : '#FDE68A'
                                                }}
                                            >
                                                <p style={{ color: 'var(--color-text)' }}>{tip.tip_text}</p>
                                                {topics[tip.topic_id] && (
                                                    <p className="text-xs text-yellow-500 mt-2">
                                                        Topic {topics[tip.topic_id].topic_number}: {topics[tip.topic_id].topic_name}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'errors' && (
                        <div className="space-y-4">
                            {errors.map(error => (
                                <div key={error.id} className="rounded-lg shadow overflow-hidden" style={{ background: 'var(--color-surface)' }}>
                                    <div
                                        className="p-4 border-l-4 border-red-500"
                                        style={{ background: theme === 'dark' ? 'rgba(239, 68, 68, 0.15)' : '#FEE2E2' }}
                                    >
                                        <h4 className="font-bold text-red-500">‚ùå Common Error:</h4>
                                        <p className="text-red-400 italic">"{error.error_statement}"</p>
                                    </div>
                                    <div
                                        className="p-4 border-l-4 border-green-500"
                                        style={{ background: theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4' }}
                                    >
                                        <h4 className="font-bold" style={{ color: 'var(--color-success)' }}>‚úÖ Why it's wrong:</h4>
                                        <p style={{ color: 'var(--color-text)' }}>{error.explanation}</p>
                                    </div>
                                    {topics[error.topic_id] && (
                                        <div className="px-4 py-2 text-xs" style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text-muted)' }}>
                                            Topic {topics[error.topic_id].topic_number}: {topics[error.topic_id].topic_name}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Sample Answers View - Learn from example answers
        function SampleAnswersView() {
            const { theme } = useContext(ThemeContext);
            const [answers, setAnswers] = useState([]);
            const [topics, setTopics] = useState({});
            const [currentIndex, setCurrentIndex] = useState(0);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api.get('/sample-answers'),
                    api.get('/topics')
                ]).then(([answersData, topicsData]) => {
                    setAnswers(answersData || []);
                    const topicMap = {};
                    (topicsData || []).forEach(theme => {
                        theme.topics.forEach(t => topicMap[t.id] = t);
                    });
                    setTopics(topicMap);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading sample answers...</div>;

            if (answers.length === 0) {
                return (
                    <div className="max-w-4xl mx-auto p-6 text-center">
                        <h2 className="text-3xl font-bold mb-4" style={{ color: 'var(--color-text)' }}>üìä Sample Answers</h2>
                        <p style={{ color: 'var(--color-text-muted)' }}>No sample answers available yet.</p>
                    </div>
                );
            }

            const a = answers[currentIndex];

            return (
                <div className="max-w-4xl mx-auto p-6">
                    <h2 className="text-3xl font-bold mb-2" style={{ color: 'var(--color-text)' }}>üìä Sample Answers Analysis</h2>
                    <p className="mb-6" style={{ color: 'var(--color-text-secondary)' }}>Learn from real student answers and teacher feedback</p>

                    <div className="rounded-xl shadow-lg overflow-hidden" style={{ background: 'var(--color-surface)' }}>
                        <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-4 flex justify-between items-center">
                            <span className="text-white font-bold">Example {currentIndex + 1} of {answers.length}</span>
                            {a.marks_awarded && a.marks_available && (
                                <span className="bg-white/20 text-white px-3 py-1 rounded-full">
                                    Score: {a.marks_awarded}/{a.marks_available}
                                </span>
                            )}
                        </div>

                        <div className="p-6 space-y-4">
                            <div
                                className="p-4 rounded-lg"
                                style={{ background: 'var(--color-bg-alt)' }}
                            >
                                <h4 className="font-bold mb-2" style={{ color: 'var(--color-text-secondary)' }}>üìù Question:</h4>
                                <p style={{ color: 'var(--color-text)' }}>{a.question_context}</p>
                            </div>

                            <div
                                className="p-4 rounded-lg border"
                                style={{
                                    background: theme === 'dark' ? 'rgba(59, 130, 246, 0.1)' : '#EFF6FF',
                                    borderColor: theme === 'dark' ? 'rgba(59, 130, 246, 0.3)' : '#BFDBFE'
                                }}
                            >
                                <h4 className="font-bold text-blue-500 mb-2">‚úçÔ∏è Student's Answer:</h4>
                                <p className="whitespace-pre-line" style={{ color: 'var(--color-text)' }}>{a.student_answer}</p>
                            </div>

                            <div
                                className="p-4 rounded-lg border"
                                style={{
                                    background: theme === 'dark' ? 'rgba(139, 92, 246, 0.1)' : '#FAF5FF',
                                    borderColor: theme === 'dark' ? 'rgba(139, 92, 246, 0.3)' : '#E9D5FF'
                                }}
                            >
                                <h4 className="font-bold text-purple-500 mb-2">üë®‚Äçüè´ Teacher's Comments:</h4>
                                <p style={{ color: 'var(--color-text)' }}>{a.teacher_comments}</p>
                            </div>

                            {a.strengths && (
                                <div
                                    className="p-4 rounded-lg"
                                    style={{ background: theme === 'dark' ? 'rgba(45, 106, 79, 0.15)' : '#F0FDF4' }}
                                >
                                    <h4 className="font-bold mb-2" style={{ color: 'var(--color-success)' }}>‚úÖ Strengths:</h4>
                                    <p style={{ color: 'var(--color-text)' }}>{a.strengths}</p>
                                </div>
                            )}

                            {a.improvements && (
                                <div
                                    className="p-4 rounded-lg"
                                    style={{ background: theme === 'dark' ? 'rgba(249, 115, 22, 0.1)' : '#FFF7ED' }}
                                >
                                    <h4 className="font-bold text-orange-500 mb-2">üìà To Improve:</h4>
                                    <p style={{ color: 'var(--color-text)' }}>{a.improvements}</p>
                                </div>
                            )}
                        </div>

                        <div className="flex justify-between p-4" style={{ background: 'var(--color-bg-alt)' }}>
                            <button
                                onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))}
                                disabled={currentIndex === 0}
                                className="px-4 py-2 rounded disabled:opacity-50"
                                style={{ background: 'var(--color-surface)', color: 'var(--color-text)' }}
                            >
                                ‚Üê Previous
                            </button>
                            <button
                                onClick={() => setCurrentIndex(Math.min(answers.length - 1, currentIndex + 1))}
                                disabled={currentIndex === answers.length - 1}
                                className="px-4 py-2 bg-purple-500 text-white rounded disabled:opacity-50"
                            >
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [currentView, setCurrentView] = useState('topics');
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [loading, setLoading] = useState(true);
            // Pre-filled data for Document Chat (from RAG modal)
            const [docChatPrefill, setDocChatPrefill] = useState(null);

            // Typing settings state
            const [typingSettings, setTypingSettings] = useState(() => {
                const saved = localStorage.getItem('typingSettings');
                return saved ? JSON.parse(saved) : {
                    enabled: true,
                    memoryDuration: 5,
                    stuckTimeout: 2,
                    soundEnabled: true,
                    ttsEnabled: true
                };
            });

            // Save typing settings to localStorage
            useEffect(() => {
                localStorage.setItem('typingSettings', JSON.stringify(typingSettings));
            }, [typingSettings]);

            useEffect(() => {
                // Check for existing session
                const token = localStorage.getItem('token');
                if (token) {
                    api.token = token;
                    api.get('/auth/me').then(userData => {
                        if (userData && !userData.error) {
                            setUser(userData);
                        }
                        setLoading(false);
                    });
                } else {
                    setLoading(false);
                }
            }, []);

            const handleLogout = async () => {
                await api.post('/auth/logout');
                api.token = null;
                localStorage.removeItem('token');
                setUser(null);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: 'var(--color-bg)' }}>
                        <div className="text-center">
                            <div className="animate-pulse" style={{ color: 'var(--color-primary)' }}>
                                <Icons.globe />
                            </div>
                            <p className="mt-4 font-medium" style={{ color: 'var(--color-text-secondary)' }}>Loading Geography Guru...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <Login onLogin={setUser} />;
            }

            const handleViewChange = (view) => {
                setSelectedTopic(null);
                setCurrentView(view);
            };

            return (
                <div className="min-h-screen flex flex-col" style={{ backgroundColor: 'var(--color-bg)' }}>
                    <Navigation
                        user={user}
                        currentView={currentView}
                        setCurrentView={handleViewChange}
                        onLogout={handleLogout}
                    />

                    <main className="flex-1">
                        {currentView === 'topics' && !selectedTopic && (
                            <TopicsList onSelectTopic={setSelectedTopic} />
                        )}

                        {currentView === 'topics' && selectedTopic && (
                            <TopicDetail
                                topic={selectedTopic}
                                onBack={() => setSelectedTopic(null)}
                                typingSettings={typingSettings}
                                onNavigateToDocChat={(prefillData) => {
                                    setDocChatPrefill(prefillData);
                                    setCurrentView('pdf-chat');
                                }}
                            />
                        )}

                        {currentView === 'pdf-chat' && <PDFChatView prefill={docChatPrefill} onPrefillUsed={() => setDocChatPrefill(null)} />}
                        {currentView === 'progress' && <ProgressView />}
                        {currentView === 'weak-points' && <WeakPointsView />}
                        {currentView === 'settings' && (
                            <SettingsView
                                typingSettings={typingSettings}
                                onTypingSettingsChange={setTypingSettings}
                            />
                        )}
                    </main>

                    <footer className="text-center py-6 text-sm" style={{ color: 'var(--color-text-muted)', borderTop: '1px solid var(--color-border-light)' }}>
                        <p>IGCSE Geography Guru ‚Ä¢ Built for exam success</p>
                    </footer>
                </div>
            );
        }

        // Document Chat View Component - RAG-powered chat with study guide documents
        function PDFChatView({ prefill, onPrefillUsed }) {
            const { theme } = useContext(ThemeContext);
            const [documents, setDocuments] = useState([]);
            const [selectedDocs, setSelectedDocs] = useState([]); // Multi-doc selection (array of IDs)
            const [prefillProcessed, setPrefillProcessed] = useState(false); // Track if prefill was processed
            const [pendingAutoSubmit, setPendingAutoSubmit] = useState(false); // Track pending auto-submit
            const [viewingDoc, setViewingDoc] = useState(null); // For PDF viewer
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(true);
            const [uploading, setUploading] = useState(false);
            const [processing, setProcessing] = useState(false);
            const [chatLoading, setChatLoading] = useState(false);
            const [settings, setSettings] = useState(null);
            const [apiKey, setApiKey] = useState(''); // Holds '__USE_STORED_KEY__' or actual key
            const [uploadStatus, setUploadStatus] = useState(''); // Detailed upload status
            const [pdfViewerPage, setPdfViewerPage] = useState(1);
            const [showPdfViewer, setShowPdfViewer] = useState(false);
            const [pdfViewerZoom, setPdfViewerZoom] = useState(100);
            const [pdfViewerFullscreen, setPdfViewerFullscreen] = useState(false);
            const [pdfTotalPages, setPdfTotalPages] = useState(0);
            const [pdfPageLoading, setPdfPageLoading] = useState(false);
            const [docSearch, setDocSearch] = useState(''); // Search filter for documents
            const [docSort, setDocSort] = useState('name-asc'); // Sort: name-asc, name-desc, date-newest, date-oldest, pages-most, pages-least
            const messagesEndRef = useRef(null);
            const pdfDocRef = useRef(null); // Cache loaded PDF for total pages
            const pdfCanvasRef = useRef(null); // Canvas for rendering PDF pages

            // Filter and sort documents
            const filteredDocs = useMemo(() => {
                let filtered = documents.filter(doc =>
                    doc.original_filename.toLowerCase().includes(docSearch.toLowerCase())
                );

                filtered.sort((a, b) => {
                    switch (docSort) {
                        case 'name-asc':
                            return a.original_filename.localeCompare(b.original_filename);
                        case 'name-desc':
                            return b.original_filename.localeCompare(a.original_filename);
                        case 'date-newest':
                            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                        case 'date-oldest':
                            return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                        case 'pages-most':
                            return (b.page_count || 0) - (a.page_count || 0);
                        case 'pages-least':
                            return (a.page_count || 0) - (b.page_count || 0);
                        default:
                            return 0;
                    }
                });

                return filtered;
            }, [documents, docSearch, docSort]);

            // Load documents and settings (use ai_settings for API keys - same as main Settings)
            useEffect(() => {
                Promise.all([
                    api.get('/pdf/documents'),
                    api.get('/ai/settings')
                ]).then(([docs, aiSettingsData]) => {
                    setDocuments(docs || []);
                    const settingsObj = aiSettingsData?.settings || {};
                    setSettings(settingsObj);
                    // Check if OpenAI key is validated (has masked format with dots)
                    if (settingsObj?.openai_api_key && settingsObj.openai_validated) {
                        // Key is validated in main Settings - we'll use it via server-side
                        setApiKey('__USE_STORED_KEY__');
                    }
                    setLoading(false);
                });
            }, []);

            // Auto-scroll to bottom of messages
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Clear chat when document selection changes (but not when prefill sets docs)
            useEffect(() => {
                // Only clear messages if not during prefill processing
                if (!prefillProcessed) return;
                setMessages([]);
            }, [selectedDocs]);

            // Handle prefill data from RAG modal navigation
            useEffect(() => {
                if (!prefill || !documents.length || !apiKey || prefillProcessed) return;

                // Set the selected documents from prefill
                let hasValidDocs = false;
                if (prefill.documentIds && prefill.documentIds.length > 0) {
                    // Filter to only include documents that exist and are ready
                    const validDocIds = prefill.documentIds.filter(id =>
                        documents.some(d => d.id === id && d.status === 'ready')
                    );
                    if (validDocIds.length > 0) {
                        setSelectedDocs(validDocIds);
                        hasValidDocs = true;
                    }
                }

                // Set the question in the input and flag for auto-submit
                if (prefill.question) {
                    setInput(prefill.question);
                    if (hasValidDocs) {
                        setPendingAutoSubmit(true);
                    }
                }

                // Mark prefill as processed
                setPrefillProcessed(true);

                // Clear prefill data in parent
                if (onPrefillUsed) {
                    onPrefillUsed();
                }
            }, [prefill, documents, apiKey, prefillProcessed, onPrefillUsed]);

            // Helper functions for document selection
            const toggleDocSelection = (docId) => {
                setSelectedDocs(prev =>
                    prev.includes(docId)
                        ? prev.filter(id => id !== docId)
                        : [...prev, docId]
                );
            };

            const selectAllDocs = () => {
                const readyDocs = documents.filter(d => d.status === 'ready').map(d => d.id);
                setSelectedDocs(readyDocs);
            };

            const deselectAllDocs = () => {
                setSelectedDocs([]);
            };

            const getSelectedDocsInfo = () => {
                return documents.filter(d => selectedDocs.includes(d.id));
            };

            // Supported file extensions
            const SUPPORTED_FORMATS = {
                // Documents
                'pdf': 'application/pdf',
                'txt': 'text/plain',
                'md': 'text/markdown',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'doc': 'application/msword',
                'rtf': 'application/rtf',
                'odt': 'application/vnd.oasis.opendocument.text',
                // Spreadsheets
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'xls': 'application/vnd.ms-excel',
                'csv': 'text/csv',
                'ods': 'application/vnd.oasis.opendocument.spreadsheet',
                // Presentations
                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'ppt': 'application/vnd.ms-powerpoint',
                'odp': 'application/vnd.oasis.opendocument.presentation',
                // Other
                'epub': 'application/epub+zip',
                'html': 'text/html',
                'htm': 'text/html',
                'json': 'application/json',
                'xml': 'application/xml'
            };

            const getFileExtension = (filename) => {
                return filename.split('.').pop().toLowerCase();
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const ext = getFileExtension(file.name);
                const supportedExts = Object.keys(SUPPORTED_FORMATS);

                if (!supportedExts.includes(ext)) {
                    alert(`Unsupported file format. Supported: ${supportedExts.join(', ')}`);
                    return;
                }

                if (!apiKey) {
                    alert('Please configure your OpenAI API key in the main Settings page first (go to Settings > AI Providers > OpenAI)');
                    return;
                }

                setUploading(true);
                setUploadStatus('Preparing upload...');

                try {
                    // Generate unique document ID and storage path
                    const docId = crypto.randomUUID();
                    const safeFilename = file.name.replace(/[^\w\-_.]/g, '_');
                    const storagePath = `${docId}/${safeFilename}`;

                    // Upload directly to Supabase Storage (bypasses Vercel payload limits)
                    setUploadStatus('Uploading to storage...');
                    console.log('Starting direct Supabase upload, size:', Math.round(file.size / 1024), 'KB');

                    let storageSuccess = false;
                    let storageError = null;

                    try {
                        const { data: uploadData, error: uploadError } = await supabaseClient.storage
                            .from('documents')
                            .upload(storagePath, file, {
                                cacheControl: '3600',
                                upsert: true
                            });

                        if (uploadError) {
                            console.log('Storage upload failed (non-blocking):', uploadError.message);
                            storageError = uploadError.message;
                        } else {
                            storageSuccess = true;
                            console.log('Storage upload success:', uploadData);
                        }
                    } catch (storageErr) {
                        console.log('Storage upload exception (non-blocking):', storageErr);
                        storageError = storageErr.message;
                    }

                    // Create document record via API (just metadata, no file data)
                    setUploadStatus('Creating document record...');
                    let uploadResult;
                    try {
                        uploadResult = await api.post('/pdf/create-record', {
                            id: docId,
                            filename: safeFilename,
                            original_filename: file.name,
                            storage_path: storageSuccess ? storagePath : '',
                            file_size: file.size
                        });
                        console.log('Document record created:', uploadResult);
                    } catch (recordErr) {
                        console.error('Failed to create document record:', recordErr);
                        alert('Failed to create document record: ' + (recordErr.message || 'Unknown error'));
                        setUploading(false);
                        setUploadStatus('');
                        return;
                    }

                    // Note if there was a storage warning (file storage optional)
                    if (storageError) {
                        console.log('Storage warning (non-blocking):', storageError);
                    }

                    // Extract text based on file type
                    setProcessing(true);
                    setUploadStatus('Extracting text...');
                    let pagesText = [];

                    try {
                        switch (ext) {
                            case 'pdf':
                                pagesText = await extractPdfText(file);
                                break;
                            case 'txt':
                            case 'md':
                                pagesText = await extractTxtText(file);
                                break;
                            case 'docx':
                                pagesText = await extractDocxText(file);
                                break;
                            case 'doc':
                                alert('Old .doc format may not extract perfectly. Consider converting to .docx for best results.');
                                pagesText = await extractTxtText(file);
                                break;
                            case 'rtf':
                                pagesText = await extractRtfText(file);
                                break;
                            case 'odt':
                                pagesText = await extractOdtText(file);
                                break;
                            case 'xlsx':
                            case 'xls':
                            case 'ods':
                                pagesText = await extractXlsxText(file);
                                break;
                            case 'csv':
                                pagesText = await extractCsvText(file);
                                break;
                            case 'pptx':
                                pagesText = await extractPptxText(file);
                                break;
                            case 'ppt':
                                alert('Old .ppt format may not extract perfectly. Consider converting to .pptx for best results.');
                                pagesText = await extractTxtText(file);
                                break;
                            case 'odp':
                                pagesText = await extractOdpText(file);
                                break;
                            case 'epub':
                                pagesText = await extractEpubText(file);
                                break;
                            case 'html':
                            case 'htm':
                                pagesText = await extractHtmlText(file);
                                break;
                            case 'json':
                                pagesText = await extractJsonText(file);
                                break;
                            case 'xml':
                                pagesText = await extractXmlText(file);
                                break;
                            default:
                                throw new Error('Unsupported format');
                        }
                    } catch (extractErr) {
                        alert('Error extracting text: ' + extractErr.message);
                        setUploading(false);
                        setProcessing(false);
                        setUploadStatus('');
                        return;
                    }

                    // Send to server for embedding
                    setUploadStatus(`Creating embeddings (${pagesText.length} sections)...`);
                    const processResult = await api.post('/pdf/process', {
                        document_id: docId,
                        openai_api_key: apiKey === '__USE_STORED_KEY__' ? null : apiKey,
                        use_stored_key: apiKey === '__USE_STORED_KEY__',
                        pages_text: pagesText
                    });

                    if (processResult?.success) {
                        // Refresh documents list
                        const docs = await api.get('/pdf/documents');
                        setDocuments(docs || []);
                        // Auto-select the new document
                        setSelectedDocs(prev => [...prev, docId]);
                        let successMsg = `Document processed successfully! ${processResult.chunks_created} chunks created from ${processResult.pages_processed} sections.`;
                        if (storageError) {
                            successMsg += `\n\nNote: File storage failed (${storageError}). PDF preview disabled, but RAG chat works normally.`;
                        }
                        alert(successMsg);
                    } else {
                        alert('Failed to process document: ' + (processResult?.error || 'Unknown error'));
                    }

                } catch (err) {
                    console.error('Upload error:', err);
                    alert('Error: ' + err.message);
                } finally {
                    setUploading(false);
                    setProcessing(false);
                    setUploadStatus('');
                }
            };

            // Extract text from PDF using PDF.js
            const extractPdfText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const pagesText = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const text = textContent.items.map(item => item.str).join(' ');
                    pagesText.push({ page_number: i, text });
                }

                return pagesText;
            };

            // Extract text from TXT file
            const extractTxtText = async (file) => {
                const text = await file.text();
                // Split into chunks of ~2000 chars to simulate pages
                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from DOCX using Mammoth.js
            const extractDocxText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                const text = result.value;
                // Split into chunks to simulate pages
                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from XLSX using SheetJS
            const extractXlsxText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const pagesText = [];

                workbook.SheetNames.forEach((sheetName, index) => {
                    const sheet = workbook.Sheets[sheetName];
                    const text = XLSX.utils.sheet_to_txt(sheet);
                    pagesText.push({
                        page_number: index + 1,
                        text: `Sheet: ${sheetName}\n${text}`
                    });
                });

                return pagesText;
            };

            // Extract text from PPTX using JSZip
            const extractPptxText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                // PPTX stores slides in ppt/slides/slide{n}.xml
                const slideFiles = Object.keys(zip.files)
                    .filter(name => name.match(/ppt\/slides\/slide\d+\.xml/))
                    .sort((a, b) => {
                        const numA = parseInt(a.match(/slide(\d+)/)[1]);
                        const numB = parseInt(b.match(/slide(\d+)/)[1]);
                        return numA - numB;
                    });

                for (let i = 0; i < slideFiles.length; i++) {
                    const slideXml = await zip.files[slideFiles[i]].async('text');
                    // Extract text from XML (simple regex approach)
                    const textMatches = slideXml.match(/<a:t>([^<]*)<\/a:t>/g) || [];
                    const text = textMatches
                        .map(match => match.replace(/<\/?a:t>/g, ''))
                        .join(' ');
                    pagesText.push({
                        page_number: i + 1,
                        text: `Slide ${i + 1}: ${text}`
                    });
                }

                return pagesText;
            };

            // Extract text from EPUB using JSZip
            const extractEpubText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                // Find content files (HTML/XHTML)
                const contentFiles = Object.keys(zip.files)
                    .filter(name => name.match(/\.(html|xhtml|htm)$/i))
                    .sort();

                for (let i = 0; i < contentFiles.length; i++) {
                    const html = await zip.files[contentFiles[i]].async('text');
                    // Strip HTML tags to get plain text
                    const text = html
                        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                        .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                        .replace(/<[^>]+>/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();

                    if (text.length > 50) { // Only include substantial content
                        pagesText.push({
                            page_number: pagesText.length + 1,
                            text: text
                        });
                    }
                }

                return pagesText;
            };

            // Extract text from RTF file
            const extractRtfText = async (file) => {
                const text = await file.text();
                // Basic RTF to text conversion - strip RTF control words
                const plainText = text
                    .replace(/\{\\[^{}]+\}/g, '') // Remove groups with control words
                    .replace(/\\[a-z]+\d*\s?/gi, '') // Remove control words
                    .replace(/[{}]/g, '') // Remove remaining braces
                    .replace(/\s+/g, ' ')
                    .trim();

                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < plainText.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: plainText.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from ODT (OpenDocument Text) using JSZip
            const extractOdtText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                // ODT stores content in content.xml
                if (zip.files['content.xml']) {
                    const xml = await zip.files['content.xml'].async('text');
                    // Extract text from XML
                    const text = xml
                        .replace(/<text:p[^>]*>/gi, '\n')
                        .replace(/<[^>]+>/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();

                    const chunkSize = 2000;
                    for (let i = 0; i < text.length; i += chunkSize) {
                        pagesText.push({
                            page_number: Math.floor(i / chunkSize) + 1,
                            text: text.slice(i, i + chunkSize)
                        });
                    }
                }

                return pagesText;
            };

            // Extract text from CSV file
            const extractCsvText = async (file) => {
                const text = await file.text();
                // Convert CSV to readable format
                const lines = text.split('\n');
                const pagesText = [];

                // Group lines into chunks for "pages"
                const linesPerPage = 50;
                for (let i = 0; i < lines.length; i += linesPerPage) {
                    const pageLines = lines.slice(i, i + linesPerPage);
                    pagesText.push({
                        page_number: Math.floor(i / linesPerPage) + 1,
                        text: pageLines.join('\n')
                    });
                }

                return pagesText;
            };

            // Extract text from ODP (OpenDocument Presentation) using JSZip
            const extractOdpText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                if (zip.files['content.xml']) {
                    const xml = await zip.files['content.xml'].async('text');
                    // Extract text from draw:frame elements
                    const textMatches = xml.match(/<text:p[^>]*>([^<]*)<\/text:p>/g) || [];
                    const allText = textMatches
                        .map(match => match.replace(/<[^>]+>/g, ''))
                        .join(' ');

                    const chunkSize = 2000;
                    for (let i = 0; i < allText.length; i += chunkSize) {
                        pagesText.push({
                            page_number: Math.floor(i / chunkSize) + 1,
                            text: allText.slice(i, i + chunkSize)
                        });
                    }
                }

                return pagesText;
            };

            // Extract text from HTML file
            const extractHtmlText = async (file) => {
                const html = await file.text();
                const text = html
                    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                    .replace(/<[^>]+>/g, ' ')
                    .replace(/&nbsp;/g, ' ')
                    .replace(/&amp;/g, '&')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/\s+/g, ' ')
                    .trim();

                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from JSON file
            const extractJsonText = async (file) => {
                const text = await file.text();
                try {
                    const json = JSON.parse(text);
                    // Convert JSON to readable string
                    const readable = JSON.stringify(json, null, 2);

                    const chunkSize = 2000;
                    const pagesText = [];
                    for (let i = 0; i < readable.length; i += chunkSize) {
                        pagesText.push({
                            page_number: Math.floor(i / chunkSize) + 1,
                            text: readable.slice(i, i + chunkSize)
                        });
                    }
                    return pagesText;
                } catch {
                    // If not valid JSON, treat as plain text
                    return extractTxtText(file);
                }
            };

            // Extract text from XML file
            const extractXmlText = async (file) => {
                const xml = await file.text();
                // Strip XML tags to get content
                const text = xml
                    .replace(/<[^>]+>/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            const handleSendMessage = async () => {
                if (!input.trim() || chatLoading) return;

                if (!apiKey) {
                    alert('Please configure your OpenAI API key in the main Settings page first (go to Settings > AI Providers > OpenAI)');
                    return;
                }

                if (selectedDocs.length === 0) {
                    alert('Please select at least one document to chat with');
                    return;
                }

                const question = input.trim();
                setInput('');
                setChatLoading(true);

                // Add user message immediately
                setMessages(prev => [...prev, { role: 'user', content: question }]);

                try {
                    // Use stored key from main Settings if available
                    const useStoredKey = apiKey === '__USE_STORED_KEY__';
                    const defaultProvider = settings?.default_provider || 'openai';

                    const result = await api.post('/rag/chat', {
                        question,
                        document_ids: selectedDocs, // Multi-doc support
                        openai_api_key: useStoredKey ? null : apiKey,
                        use_stored_key: useStoredKey,
                        llm_provider: defaultProvider,
                        llm_model: settings?.[`${defaultProvider}_model`] || 'gpt-4o-mini'
                    });

                    if (result?.answer) {
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: result.answer,
                            sources: result.sources
                        }]);
                    } else {
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: 'Sorry, I encountered an error: ' + (result?.error || 'Unknown error')
                        }]);
                    }
                } catch (err) {
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Error: ' + err.message
                    }]);
                }
                setChatLoading(false);
            };

            // Auto-submit when pendingAutoSubmit flag is set (after prefill)
            useEffect(() => {
                if (pendingAutoSubmit && input.trim() && selectedDocs.length > 0 && apiKey && !chatLoading) {
                    setPendingAutoSubmit(false);
                    handleSendMessage();
                }
            }, [pendingAutoSubmit, input, selectedDocs, apiKey, chatLoading]);

            // API settings are now managed in main Settings page
            // No local settings panel needed

            const handleDeleteDoc = async (docId) => {
                if (!confirm('Delete this document and all its embeddings?')) return;
                await api.post('/pdf/delete', { document_id: docId });
                setDocuments(prev => prev.filter(d => d.id !== docId));
                setSelectedDocs(prev => prev.filter(id => id !== docId));
                if (viewingDoc?.id === docId) {
                    setViewingDoc(null);
                }
            };

            const handleBatchDelete = async () => {
                if (selectedDocs.length === 0) {
                    alert('No documents selected');
                    return;
                }
                if (!confirm(`Delete ${selectedDocs.length} selected document(s) and all their embeddings?`)) return;

                for (const docId of selectedDocs) {
                    await api.post('/pdf/delete', { document_id: docId });
                }

                setDocuments(prev => prev.filter(d => !selectedDocs.includes(d.id)));
                setSelectedDocs([]);
                setMessages([]);
            };

            const handlePageClick = (pageNumber, doc = null) => {
                const docToView = doc || documents.find(d => selectedDocs.includes(d.id));
                if (docToView?.public_url) {
                    setViewingDoc(docToView);
                    setPdfViewerPage(pageNumber);
                    setShowPdfViewer(true);
                }
            };

            // Load PDF and get total pages when viewer opens
            useEffect(() => {
                if (!showPdfViewer || !viewingDoc?.public_url) {
                    pdfDocRef.current = null;
                    setPdfTotalPages(0);
                    return;
                }

                const loadPdf = async () => {
                    setPdfPageLoading(true);
                    try {
                        const pdf = await pdfjsLib.getDocument(viewingDoc.public_url).promise;
                        pdfDocRef.current = pdf;
                        setPdfTotalPages(pdf.numPages);
                    } catch (err) {
                        console.error('Failed to load PDF:', err);
                    }
                };
                loadPdf();
            }, [showPdfViewer, viewingDoc?.public_url]);

            // Render PDF page to canvas when page changes or PDF loads
            useEffect(() => {
                if (!pdfDocRef.current || !pdfCanvasRef.current || !showPdfViewer) return;

                const renderPage = async () => {
                    setPdfPageLoading(true);
                    try {
                        const page = await pdfDocRef.current.getPage(pdfViewerPage);
                        const canvas = pdfCanvasRef.current;
                        const context = canvas.getContext('2d');

                        // Scale for better quality (2x for retina)
                        const scale = 2;
                        const viewport = page.getViewport({ scale });

                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        canvas.style.width = `${viewport.width / scale}px`;
                        canvas.style.height = `${viewport.height / scale}px`;

                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;

                        setPdfPageLoading(false);
                    } catch (err) {
                        console.error('Failed to render page:', err);
                        setPdfPageLoading(false);
                    }
                };

                renderPage();
            }, [pdfViewerPage, pdfTotalPages, showPdfViewer]);

            // Parse message content and replace page references with clickable links
            const renderMessageWithPageLinks = (content, sources = []) => {
                if (!content) return null;

                // Match patterns like "Page 133", "page 7", "Pages 15-16", "Pages 5, 10", "(Page 133)", etc.
                const pagePattern = /\(?[Pp]ages?\s*([\d]+(?:\s*[-‚Äì,]\s*\d+)*)\)?\.?/g;

                const parts = [];
                let lastIndex = 0;
                let match;

                while ((match = pagePattern.exec(content)) !== null) {
                    // Add text before the match
                    if (match.index > lastIndex) {
                        parts.push(content.slice(lastIndex, match.index));
                    }

                    // Parse page numbers from the match
                    const pageStr = match[1];
                    const pageNums = pageStr.split(/[-‚Äì,]/).map(s => parseInt(s.trim())).filter(n => !isNaN(n));

                    // Create clickable link(s)
                    pageNums.forEach((pageNum, idx) => {
                        if (idx > 0) parts.push(', ');
                        parts.push(
                            React.createElement('button', {
                                key: `page-${match.index}-${pageNum}`,
                                onClick: () => handlePageClick(pageNum),
                                className: 'text-blue-600 hover:text-blue-800 underline font-medium',
                                title: `View Page ${pageNum}`
                            }, `(P${pageNum})`)
                        );
                    });

                    lastIndex = match.index + match[0].length;
                }

                // Add remaining text
                if (lastIndex < content.length) {
                    parts.push(content.slice(lastIndex));
                }

                return parts.length > 0 ? parts : content;
            };

            if (loading) return (
                <div className="text-center py-12">
                    <div className="inline-block w-8 h-8 border-3 border-t-transparent rounded-full animate-spin" style={{ borderColor: 'var(--color-accent)', borderTopColor: 'transparent' }}></div>
                    <p className="mt-4" style={{ color: 'var(--color-text-muted)' }}>Loading Document Chat...</p>
                </div>
            );

            // Check API key status
            const hasValidOpenAIKey = settings?.openai_api_key && settings?.openai_validated;
            const currentProvider = settings?.default_provider || 'openai';

            return (
                <div className="max-w-7xl mx-auto p-6">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-4">
                            <div className="p-3 rounded-full" style={{ background: 'var(--color-primary)', color: 'var(--color-accent)' }}>
                                <Icons.document />
                            </div>
                            <div>
                                <h2 className="text-3xl font-bold font-display" style={{ color: 'var(--color-text)' }}>Document Chat</h2>
                                {hasValidOpenAIKey ? (
                                    <p className="text-sm mt-1" style={{ color: 'var(--color-success)' }}>
                                        OpenAI API connected ‚Ä¢ Using {currentProvider} for responses
                                    </p>
                                ) : (
                                    <p className="text-sm mt-1" style={{ color: 'var(--color-error)' }}>
                                        OpenAI API key not configured
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* API Key Status Banner */}
                    {!hasValidOpenAIKey && (
                        <div className="rounded-2xl p-4 mb-6" style={{ background: 'rgba(212, 160, 23, 0.1)', border: '1px solid var(--color-accent)' }}>
                            <h3 className="font-semibold mb-2" style={{ color: 'var(--color-accent)' }}>API Key Required</h3>
                            <p className="text-sm mb-3" style={{ color: 'var(--color-text-secondary)' }}>
                                Document Chat requires an OpenAI API key for embeddings. Please configure it in the main Settings page.
                            </p>
                            <p className="text-xs" style={{ color: 'var(--color-text-muted)' }}>
                                Go to <strong>Settings ‚Üí AI Providers ‚Üí OpenAI</strong> to add your API key.
                            </p>
                        </div>
                    )}

                    <div className="grid grid-cols-4 gap-6">
                        {/* Documents Sidebar */}
                        <div className="col-span-1 card p-4">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-semibold flex items-center gap-2" style={{ color: 'var(--color-text)' }}>
                                    <Icons.document /> Documents
                                </h3>
                                {documents.length > 0 && (
                                    <span className="text-xs px-2 py-0.5 rounded-full" style={{ background: 'rgba(212, 160, 23, 0.2)', color: 'var(--color-accent)' }}>
                                        {selectedDocs.length}/{documents.length}
                                    </span>
                                )}
                            </div>

                            {/* Upload Button */}
                            <label className="block w-full mb-3">
                                <div
                                    className="border-2 border-dashed rounded-lg p-3 text-center cursor-pointer transition"
                                    style={{
                                        borderColor: uploading || processing ? 'var(--color-border)' : 'var(--color-accent)',
                                        background: uploading || processing ? 'var(--color-bg-alt)' : 'transparent'
                                    }}
                                >
                                    {(uploading || processing) ? (
                                        <div className="flex flex-col items-center">
                                            <div className="w-6 h-6 border-2 border-t-transparent rounded-full animate-spin" style={{ borderColor: 'var(--color-accent)', borderTopColor: 'transparent' }}></div>
                                            <span className="text-sm font-medium mt-2" style={{ color: 'var(--color-text-secondary)' }}>
                                                {uploadStatus || (processing ? 'Processing...' : 'Uploading...')}
                                            </span>
                                        </div>
                                    ) : (
                                        <>
                                            <div style={{ color: 'var(--color-accent)' }}><Icons.document /></div>
                                            <p className="text-sm mt-1" style={{ color: 'var(--color-text)' }}>Upload Document</p>
                                            <p className="text-xs" style={{ color: 'var(--color-text-muted)' }}>20+ formats</p>
                                        </>
                                    )}
                                </div>
                                <input
                                    type="file"
                                    accept=".pdf,.txt,.md,.docx,.doc,.rtf,.odt,.xlsx,.xls,.csv,.ods,.pptx,.ppt,.odp,.epub,.html,.htm,.json,.xml"
                                    onChange={handleFileUpload}
                                    className="hidden"
                                    disabled={uploading || processing}
                                />
                            </label>

                            {/* Search and Sort Controls */}
                            {documents.length > 0 && (
                                <div className="mb-3 space-y-2">
                                    {/* Search Input */}
                                    <div className="relative">
                                        <svg className="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4" style={{ color: 'var(--color-text-muted)' }} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                        <input
                                            type="text"
                                            placeholder="Search documents..."
                                            value={docSearch}
                                            onChange={(e) => setDocSearch(e.target.value)}
                                            className="w-full pl-8 pr-3 py-1.5 text-sm rounded-lg"
                                            style={{
                                                background: 'var(--color-bg)',
                                                border: '1px solid var(--color-border-light)',
                                                color: 'var(--color-text)'
                                            }}
                                        />
                                        {docSearch && (
                                            <button
                                                onClick={() => setDocSearch('')}
                                                className="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 rounded"
                                                style={{ color: 'var(--color-text-muted)' }}
                                            >
                                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        )}
                                    </div>

                                    {/* Sort Dropdown */}
                                    <select
                                        value={docSort}
                                        onChange={(e) => setDocSort(e.target.value)}
                                        className="w-full px-2 py-1.5 text-xs rounded-lg"
                                        style={{
                                            background: 'var(--color-bg)',
                                            border: '1px solid var(--color-border-light)',
                                            color: 'var(--color-text)'
                                        }}
                                    >
                                        <option value="name-asc">Sort: Name (A‚ÜíZ)</option>
                                        <option value="name-desc">Sort: Name (Z‚ÜíA)</option>
                                        <option value="date-newest">Sort: Newest First</option>
                                        <option value="date-oldest">Sort: Oldest First</option>
                                        <option value="pages-most">Sort: Most Pages</option>
                                        <option value="pages-least">Sort: Fewest Pages</option>
                                    </select>

                                    {/* Selection Controls */}
                                    <div className="flex gap-1">
                                        <button onClick={selectAllDocs} className="btn btn-ghost flex-1 text-xs py-1">Select All</button>
                                        <button onClick={deselectAllDocs} className="btn btn-ghost flex-1 text-xs py-1">Deselect</button>
                                        {selectedDocs.length > 0 && (
                                            <button
                                                onClick={handleBatchDelete}
                                                className="btn text-xs py-1 px-2"
                                                style={{ background: 'var(--color-error)', color: '#FFF' }}
                                                title="Delete selected"
                                            >
                                                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                </svg>
                                            </button>
                                        )}
                                    </div>

                                    {/* Results count */}
                                    {docSearch && (
                                        <p className="text-xs" style={{ color: 'var(--color-text-muted)' }}>
                                            {filteredDocs.length} of {documents.length} documents match
                                        </p>
                                    )}
                                </div>
                            )}

                            {/* Document List */}
                            <div className="space-y-2 max-h-80 overflow-y-auto pr-1" style={{ scrollbarWidth: 'thin' }}>
                                {documents.length === 0 ? (
                                    <p className="text-sm text-center py-4" style={{ color: 'var(--color-text-muted)' }}>No documents yet</p>
                                ) : filteredDocs.length === 0 ? (
                                    <p className="text-sm text-center py-4" style={{ color: 'var(--color-text-muted)' }}>No documents match "{docSearch}"</p>
                                ) : (
                                    filteredDocs.map(doc => (
                                        <div
                                            key={doc.id}
                                            className="p-2 rounded-lg transition cursor-pointer"
                                            style={{
                                                background: selectedDocs.includes(doc.id) ? 'rgba(212, 160, 23, 0.15)' : 'var(--color-bg)',
                                                border: selectedDocs.includes(doc.id) ? '2px solid var(--color-accent)' : '2px solid transparent'
                                            }}
                                            onClick={() => { if (doc.status === 'ready') toggleDocSelection(doc.id); }}
                                        >
                                            <div className="flex items-start gap-2">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedDocs.includes(doc.id)}
                                                    onChange={() => toggleDocSelection(doc.id)}
                                                    disabled={doc.status !== 'ready'}
                                                    className="mt-1 h-4 w-4 rounded"
                                                    style={{ accentColor: 'var(--color-accent)' }}
                                                    onClick={(e) => e.stopPropagation()}
                                                />
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-medium text-sm truncate" style={{ color: 'var(--color-text)' }}>{doc.original_filename}</p>
                                                    <p className="text-xs" style={{ color: 'var(--color-text-muted)' }}>
                                                        {doc.page_count || '?'} pages ‚Ä¢{' '}
                                                        <span style={{ color: doc.status === 'ready' ? 'var(--color-success)' : doc.status === 'error' ? 'var(--color-error)' : 'var(--color-accent)' }}>
                                                            {doc.status}
                                                        </span>
                                                    </p>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    {doc.public_url && (
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); setViewingDoc(doc); setPdfViewerPage(1); setShowPdfViewer(true); }}
                                                            className="p-1 rounded transition"
                                                            style={{ color: 'var(--color-primary)' }}
                                                            title="View document"
                                                        >
                                                            <Icons.book />
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); handleDeleteDoc(doc.id); }}
                                                        className="p-1 rounded transition"
                                                        style={{ color: 'var(--color-error)' }}
                                                        title="Delete"
                                                    >
                                                        <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Chat Area */}
                        <div className="col-span-3 card flex flex-col" style={{ height: '600px' }}>
                            {/* Chat Header */}
                            <div className="p-4 flex items-center justify-between" style={{ borderBottom: '1px solid var(--color-border-light)' }}>
                                <div>
                                    <h3 className="font-semibold" style={{ color: 'var(--color-text)' }}>
                                        {selectedDocs.length === 0
                                            ? 'Select document(s) to chat'
                                            : selectedDocs.length === 1
                                                ? `Chatting with: ${documents.find(d => d.id === selectedDocs[0])?.original_filename || 'document'}`
                                                : `Chatting with ${selectedDocs.length} documents`}
                                    </h3>
                                    {selectedDocs.length > 0 && (
                                        <p className="text-xs" style={{ color: 'var(--color-text-muted)' }}>
                                            {selectedDocs.length === 1
                                                ? 'Ask questions about your study guide'
                                                : 'Ask questions across all selected documents'}
                                        </p>
                                    )}
                                </div>
                                {selectedDocs.length === 1 && documents.find(d => d.id === selectedDocs[0])?.public_url && (
                                    <button
                                        onClick={() => {
                                            const doc = documents.find(d => d.id === selectedDocs[0]);
                                            setViewingDoc(doc);
                                            setPdfViewerPage(1);
                                            setShowPdfViewer(true);
                                        }}
                                        className="btn btn-ghost text-sm"
                                    >
                                        <Icons.book /> View Document
                                    </button>
                                )}
                            </div>

                            {/* Messages */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-4" style={{ background: 'var(--color-bg)' }}>
                                {messages.length === 0 ? (
                                    <div className="text-center py-12" style={{ color: 'var(--color-text-muted)' }}>
                                        <span className="text-4xl">üí¨</span>
                                        <p className="mt-2">
                                            {selectedDocs.length > 0
                                                ? 'Ask a question about your document(s)'
                                                : 'Upload and select document(s) to start chatting'}
                                        </p>
                                    </div>
                                ) : (
                                    messages.map((msg, i) => (
                                        <div
                                            key={i}
                                            className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                        >
                                            <div
                                                className="max-w-3xl rounded-xl p-4"
                                                style={{
                                                    background: msg.role === 'user'
                                                        ? 'var(--color-success)'
                                                        : theme === 'dark' ? '#2A2A30' : '#F3F4F6',
                                                    color: msg.role === 'user'
                                                        ? '#FFFFFF'
                                                        : 'var(--color-text)'
                                                }}
                                            >
                                                <p className="whitespace-pre-wrap">
                                                    {msg.role === 'assistant'
                                                        ? renderMessageWithPageLinks(msg.content, msg.sources)
                                                        : msg.content}
                                                </p>

                                                {/* Source citations */}
                                                {msg.sources?.length > 0 && (
                                                    <div className="mt-3 pt-2 border-t" style={{ borderColor: theme === 'dark' ? '#3A3A40' : '#E5E7EB' }}>
                                                        <p className="text-xs font-medium mb-1" style={{ color: 'var(--color-text-muted)' }}>Sources:</p>
                                                        <div className="flex flex-wrap gap-1">
                                                            {/* Group by document for multi-doc, or just show pages for single doc */}
                                                            {selectedDocs.length > 1 ? (
                                                                // Multi-doc: show document name + page
                                                                msg.sources.map((s, idx) => {
                                                                    const doc = documents.find(d => d.id === s.document_id);
                                                                    return (
                                                                        <button
                                                                            key={idx}
                                                                            onClick={() => {
                                                                                if (doc) {
                                                                                    setViewingDoc(doc);
                                                                                    setPdfViewerPage(s.page_number);
                                                                                    setShowPdfViewer(true);
                                                                                }
                                                                            }}
                                                                            className="px-2 py-0.5 rounded text-xs transition"
                                                                            style={{
                                                                                background: 'rgba(212, 160, 23, 0.2)',
                                                                                color: 'var(--color-accent)'
                                                                            }}
                                                                            title={s.document_name || 'Document'}
                                                                        >
                                                                            {(s.document_name || 'Doc').substring(0, 15)}... p.{s.page_number}
                                                                        </button>
                                                                    );
                                                                })
                                                            ) : (
                                                                // Single doc: just show page numbers
                                                                [...new Set(msg.sources.map(s => s.page_number))].map(page => (
                                                                    <button
                                                                        key={page}
                                                                        onClick={() => handlePageClick(page)}
                                                                        className="px-2 py-0.5 rounded text-xs transition"
                                                                        style={{
                                                                            background: 'rgba(212, 160, 23, 0.2)',
                                                                            color: 'var(--color-accent)'
                                                                        }}
                                                                    >
                                                                        Page {page}
                                                                    </button>
                                                                ))
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                                {chatLoading && (
                                    <div className="flex justify-start">
                                        <div className="rounded-xl p-4" style={{ background: theme === 'dark' ? '#2A2A30' : '#F3F4F6', color: 'var(--color-text)' }}>
                                            <span className="animate-pulse">Thinking...</span>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Input Area */}
                            <div className="p-4 border-t">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        placeholder={selectedDocs.length > 0 ? "Ask about your study guide..." : "Select document(s) first"}
                                        disabled={selectedDocs.length === 0 || chatLoading}
                                        className="input flex-1"
                                        style={{ borderRadius: '9999px' }}
                                    />
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={selectedDocs.length === 0 || !input.trim() || chatLoading}
                                        className="btn btn-accent disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Document Viewer Modal */}
                    {showPdfViewer && viewingDoc?.public_url && (
                        <div className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ${pdfViewerFullscreen ? 'p-0' : 'p-4'}`}>
                            <div
                                className={`flex flex-col ${pdfViewerFullscreen ? 'w-full h-full' : 'rounded-xl w-11/12 h-5/6 max-w-6xl'}`}
                                style={{ background: 'var(--color-surface)' }}
                            >
                                <div className="p-3 flex items-center justify-between gap-2 flex-wrap" style={{ borderBottom: '1px solid var(--color-border)' }}>
                                    <h3 className="font-semibold text-sm truncate max-w-xs" style={{ color: 'var(--color-text)' }}>{viewingDoc.original_filename}</h3>
                                    <div className="flex items-center gap-2 flex-wrap">
                                        {/* Page Navigation */}
                                        <div className="flex items-center gap-1 rounded px-2 py-1" style={{ background: 'var(--color-bg-alt)' }}>
                                            <button
                                                onClick={() => setPdfViewerPage(Math.max(1, pdfViewerPage - 1))}
                                                className="px-2 rounded transition"
                                                style={{ color: 'var(--color-text)' }}
                                                disabled={pdfViewerPage <= 1}
                                            >‚Üê</button>
                                            <span className="text-sm min-w-[80px] text-center" style={{ color: 'var(--color-text)' }}>
                                                Page {pdfViewerPage}{pdfTotalPages > 0 ? ` / ${pdfTotalPages}` : ''}
                                            </span>
                                            <button
                                                onClick={() => setPdfViewerPage(Math.min(pdfTotalPages || 999, pdfViewerPage + 1))}
                                                className="px-2 rounded transition"
                                                style={{ color: 'var(--color-text)' }}
                                                disabled={pdfTotalPages > 0 && pdfViewerPage >= pdfTotalPages}
                                            >‚Üí</button>
                                        </div>
                                        {/* Zoom Controls */}
                                        <div className="flex items-center gap-1 rounded px-2 py-1" style={{ background: 'var(--color-bg-alt)' }}>
                                            <button
                                                onClick={() => setPdfViewerZoom(Math.max(50, pdfViewerZoom - 25))}
                                                className="px-2 rounded transition"
                                                style={{ color: 'var(--color-text)' }}
                                                title="Zoom Out"
                                            >‚àí</button>
                                            <span className="text-sm min-w-[50px] text-center" style={{ color: 'var(--color-text)' }}>{pdfViewerZoom}%</span>
                                            <button
                                                onClick={() => setPdfViewerZoom(Math.min(200, pdfViewerZoom + 25))}
                                                className="px-2 rounded transition"
                                                style={{ color: 'var(--color-text)' }}
                                                title="Zoom In"
                                            >+</button>
                                        </div>
                                        {/* Open in New Tab - enables native Cmd+F search */}
                                        <button
                                            onClick={() => window.open(`${viewingDoc.public_url}#page=${pdfViewerPage}`, '_blank')}
                                            className="px-3 py-1 rounded text-sm transition"
                                            style={{ background: 'rgba(212, 160, 23, 0.2)', color: 'var(--color-accent)' }}
                                            title="Open in new tab (use Cmd+F to search)"
                                        >üîç Search (Cmd+F)</button>
                                        {/* Fullscreen Toggle */}
                                        <button
                                            onClick={() => setPdfViewerFullscreen(!pdfViewerFullscreen)}
                                            className="px-3 py-1 rounded text-sm transition"
                                            style={{ background: 'var(--color-bg-alt)', color: 'var(--color-text)' }}
                                            title={pdfViewerFullscreen ? "Exit Fullscreen" : "Fullscreen"}
                                        >{pdfViewerFullscreen ? '‚äô' : '‚õ∂'}</button>
                                        {/* Close */}
                                        <button
                                            onClick={() => { setShowPdfViewer(false); setPdfViewerFullscreen(false); }}
                                            className="px-3 py-1 rounded text-sm transition"
                                            style={{ background: 'rgba(200, 50, 50, 0.15)', color: 'var(--color-error)' }}
                                        >‚úï</button>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-auto p-2 flex items-start justify-center relative" style={{ background: 'var(--color-bg-alt)' }}>
                                    {pdfPageLoading && (
                                        <div className="absolute inset-0 flex items-center justify-center z-10" style={{ background: theme === 'dark' ? 'rgba(19, 19, 22, 0.9)' : 'rgba(243, 244, 246, 0.9)' }}>
                                            <div className="text-center">
                                                <div className="animate-spin text-4xl mb-2">‚è≥</div>
                                                <p style={{ color: 'var(--color-text-secondary)' }}>Loading page {pdfViewerPage}...</p>
                                            </div>
                                        </div>
                                    )}
                                    <div style={{ transform: `scale(${pdfViewerZoom / 100})`, transformOrigin: 'top center', transition: 'transform 0.2s' }}>
                                        <canvas
                                            ref={pdfCanvasRef}
                                            className="border rounded shadow-lg"
                                            style={{ maxWidth: '100%', background: '#FFFFFF', borderColor: 'var(--color-border)' }}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app with ThemeProvider
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ThemeProvider>
                <App />
            </ThemeProvider>
        );
    </script>
</body>
</html>

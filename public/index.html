<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Geography Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Document parsing libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Supabase client for direct storage uploads -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        // Supabase client for direct uploads (anon key is safe to expose)
        const SUPABASE_URL = 'https://wamzijrgngnvuzczxoqx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbXppanJnbmdudnV6Y3p4b3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMDkwNTEsImV4cCI6MjA4Mzc4NTA1MX0.aURdBDJwdRhFlqm6bArvOtSlNA9IZ8AM-sdtwSu7Pc0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .flip-card { perspective: 1000px; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { backface-visibility: hidden; }
        .flip-card-back { transform: rotateY(180deg); }

        /* Typing animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }
        @keyframes caret-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        .animate-float-up { animation: floatUp 1s ease-out forwards; }
        .animate-pulse-glow { animation: pulse-glow 1.5s ease-in-out infinite; }
        .caret-blink { animation: caret-blink 1s step-end infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useRef, useCallback } = React;

        // API Base URL
        const API_URL = '/api';

        // Auth Context
        const AuthContext = createContext(null);

        // Typing Settings Context
        const TypingSettingsContext = createContext({
            enabled: true,
            memoryDuration: 5,
            stuckTimeout: 2,
            soundEnabled: true,
            ttsEnabled: true
        });

        // ============================================
        // AUDIO ENGINE - Synthesized sounds (no external assets)
        // ============================================
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.gainNode = null;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.ctx.createGain();
                    this.gainNode.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            playKeyClick() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'triangle';
                const baseFreq = 800 + Math.random() * 100;
                osc.frequency.setValueAtTime(baseFreq, t);
                osc.frequency.exponentialRampToValueAtTime(baseFreq / 2, t + 0.03);

                gain.gain.setValueAtTime(0.12, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.04);

                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start(t);
                osc.stop(t + 0.05);
            }

            playError() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(120, t);
                osc.frequency.linearRampToValueAtTime(80, t + 0.1);

                gain.gain.setValueAtTime(0.08, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);

                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start(t);
                osc.stop(t + 0.15);
            }

            playSuccessDing() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, t);
                osc.frequency.setValueAtTime(1046.50, t + 0.1);

                gain.gain.setValueAtTime(0.15, t);
                gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.8);

                osc.connect(gain);
                gain.connect(this.gainNode);
                osc.start(t);
                osc.stop(t + 0.8);
            }

            playPowerDing() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const osc1 = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc1.type = 'sine';
                osc2.type = 'triangle';

                osc1.frequency.setValueAtTime(880, t);
                osc1.frequency.linearRampToValueAtTime(1760, t + 0.1);
                osc2.frequency.setValueAtTime(1108, t);
                osc2.frequency.linearRampToValueAtTime(2217, t + 0.1);

                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.0001, t + 1);

                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(this.gainNode);

                osc1.start(t);
                osc2.start(t);
                osc1.stop(t + 1);
                osc2.stop(t + 1);
            }

            playVictory() {
                this.init();
                if (!this.ctx || !this.gainNode) return;

                const t = this.ctx.currentTime;
                const notes = [523.25, 659.25, 783.99, 1046.50];

                notes.forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const noteGain = this.ctx.createGain();

                    osc.type = 'square';
                    osc.frequency.setValueAtTime(freq, t + i * 0.1);

                    noteGain.gain.setValueAtTime(0, t + i * 0.1);
                    noteGain.gain.linearRampToValueAtTime(0.08, t + i * 0.1 + 0.05);
                    noteGain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.1 + 0.4);

                    osc.connect(noteGain);
                    noteGain.connect(this.gainNode);

                    osc.start(t + i * 0.1);
                    osc.stop(t + i * 0.1 + 0.5);
                });
            }

            speak(text) {
                if (!('speechSynthesis' in window)) return;
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;

                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v =>
                    (v.name.includes('Google') || v.name.includes('Premium') || v.name.includes('Daniel') || v.name.includes('Samantha'))
                    && v.lang.startsWith('en')
                );
                if (preferredVoice) utterance.voice = preferredVoice;

                window.speechSynthesis.speak(utterance);
            }

            cancelSpeech() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            }
        }

        const audioEngine = new AudioEngine();

        // Encouragement phrases
        const ENCOURAGEMENT_PHRASES = [
            "NAILED IT!", "GEOGRAPHY MASTER!", "BRILLIANT!",
            "EXAM READY!", "LOCKED IN!", "WORD PERFECT!",
            "DEFINITION CRUSHED!", "STELLAR!", "TOP MARKS!"
        ];

        // ============================================
        // TYPING PRACTICE COMPONENT
        // ============================================
        function TypingPractice({
            text,
            onComplete,
            onCancel,
            settings = {},
            label = "Definition"
        }) {
            const {
                memoryDuration = 5,
                stuckTimeout = 2,
                soundEnabled = true,
                ttsEnabled = true
            } = settings;

            const [input, setInput] = useState('');
            const [isTextVisible, setIsTextVisible] = useState(true);
            const [timeLeft, setTimeLeft] = useState(memoryDuration);
            const [hintEndIndex, setHintEndIndex] = useState(-1);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [isComplete, setIsComplete] = useState(false);

            const inputRef = useRef(null);
            const cursorRef = useRef(null);

            // TTS on mount
            useEffect(() => {
                if (ttsEnabled && text) {
                    setTimeout(() => audioEngine.speak(text), 300);
                }
                return () => audioEngine.cancelSpeech();
            }, [text, ttsEnabled]);

            // Countdown timer
            useEffect(() => {
                if (!isTextVisible || isComplete) return;

                const interval = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            setIsTextVisible(false);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(interval);
            }, [isTextVisible, isComplete]);

            // Stuck detection - reveal hint
            useEffect(() => {
                if (isComplete || input.length >= text.length) return;

                // Reset hint if user progressed past it
                if (hintEndIndex !== -1 && input.length >= hintEndIndex) {
                    setHintEndIndex(-1);
                }

                const timer = setTimeout(() => {
                    const spaceIndex = text.indexOf(' ', input.length);
                    const nextWordEnd = spaceIndex === -1 ? text.length : spaceIndex + 1;
                    setHintEndIndex(nextWordEnd);
                }, stuckTimeout * 1000);

                return () => clearTimeout(timer);
            }, [input, text, stuckTimeout, hintEndIndex, isComplete]);

            // Focus management
            useEffect(() => {
                inputRef.current?.focus();
                const interval = setInterval(() => {
                    if (inputRef.current && document.activeElement !== inputRef.current && !isComplete) {
                        inputRef.current.focus();
                    }
                }, 500);
                return () => clearInterval(interval);
            }, [isComplete]);

            const triggerFloatingText = (text) => {
                const id = Date.now();
                setFloatingTexts(prev => [...prev, { id, text }]);
                setTimeout(() => {
                    setFloatingTexts(prev => prev.filter(ft => ft.id !== id));
                }, 1000);
            };

            const handleInputChange = (e) => {
                const val = e.target.value;
                const isAdding = val.length > input.length;

                // Hide text on first keystroke
                if (isTextVisible && val.length > 0) {
                    setIsTextVisible(false);
                }

                if (isAdding) {
                    const charIndex = val.length - 1;
                    const expectedChar = text[charIndex];
                    const typedChar = val[charIndex];

                    if (expectedChar === typedChar) {
                        if (soundEnabled) audioEngine.playKeyClick();
                    } else {
                        if (soundEnabled) audioEngine.playError();
                    }
                }

                setInput(val);

                // Check completion
                if (val === text) {
                    setIsComplete(true);
                    if (soundEnabled) audioEngine.playSuccessDing();

                    triggerFloatingText(ENCOURAGEMENT_PHRASES[Math.floor(Math.random() * ENCOURAGEMENT_PHRASES.length)]);

                    // Fire confetti
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.7 },
                        colors: ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899']
                    });

                    setTimeout(() => onComplete && onComplete(), 1500);
                }
            };

            const handleReshow = () => {
                setIsTextVisible(true);
                setTimeLeft(memoryDuration);
                inputRef.current?.focus();
            };

            const renderText = () => {
                return text.split('').map((char, index) => {
                    const typedChar = input[index];
                    let className = "transition-all duration-200 ";

                    if (typedChar == null) {
                        // Untyped
                        const isHint = index < hintEndIndex;
                        if (!isTextVisible && !isHint) {
                            className += "opacity-0 blur-sm text-gray-400 select-none";
                        } else if (isHint) {
                            className += "text-yellow-500 opacity-100 animate-pulse";
                        } else {
                            className += "text-gray-400 opacity-60";
                        }
                    } else if (typedChar === char) {
                        className += "text-green-500 font-medium";
                    } else {
                        className += "text-red-500 bg-red-100 rounded";
                    }

                    const isCursor = index === input.length;

                    return (
                        <span key={index} ref={isCursor ? cursorRef : null} className={`relative ${className}`}>
                            {isCursor && (
                                <span className="absolute -left-px top-0 w-0.5 h-full bg-green-500 caret-blink" />
                            )}
                            {char}
                        </span>
                    );
                });
            };

            return (
                <div className="relative">
                    {/* Floating encouragement texts */}
                    {floatingTexts.map(ft => (
                        <div
                            key={ft.id}
                            className="absolute left-1/2 -translate-x-1/2 top-0 z-50 pointer-events-none animate-float-up"
                        >
                            <span className="text-2xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
                                {ft.text}
                            </span>
                        </div>
                    ))}

                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">‚å®Ô∏è</span>
                            <span className="font-semibold text-gray-700">Type to Memorize</span>
                        </div>
                        <div className="flex items-center gap-3">
                            {isTextVisible && !isComplete && (
                                <span className="text-sm font-mono bg-gray-100 px-3 py-1 rounded-full text-gray-600">
                                    ‚è±Ô∏è {timeLeft}s
                                </span>
                            )}
                            {!isTextVisible && !isComplete && (
                                <button
                                    onClick={handleReshow}
                                    className="text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full hover:bg-yellow-200 transition flex items-center gap-1"
                                >
                                    üëÅÔ∏è Peek
                                </button>
                            )}
                            <button
                                onClick={onCancel}
                                className="text-gray-400 hover:text-gray-600 transition"
                            >
                                ‚úï
                            </button>
                        </div>
                    </div>

                    {/* Label */}
                    <div className="text-xs uppercase tracking-wider text-gray-400 mb-2">{label}</div>

                    {/* Typing area */}
                    <div
                        className={`relative bg-gray-50 rounded-xl p-6 border-2 transition-all cursor-text ${
                            isComplete ? 'border-green-500 animate-pulse-glow' : 'border-gray-200'
                        }`}
                        onClick={() => inputRef.current?.focus()}
                    >
                        <div className="text-lg leading-relaxed font-serif min-h-[60px]">
                            {renderText()}
                            {input.length === text.length && !isComplete && (
                                <span className="inline-block w-0.5 h-5 bg-green-500 caret-blink align-middle ml-0.5" />
                            )}
                        </div>

                        {/* Hidden input */}
                        <input
                            ref={inputRef}
                            type="text"
                            value={input}
                            onChange={handleInputChange}
                            className="absolute inset-0 opacity-0 cursor-text"
                            autoFocus
                            spellCheck={false}
                            autoComplete="off"
                            disabled={isComplete}
                        />
                    </div>

                    {/* Progress bar */}
                    <div className="mt-4 flex items-center gap-3">
                        <div className="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div
                                className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all duration-150"
                                style={{ width: `${(input.length / text.length) * 100}%` }}
                            />
                        </div>
                        <span className="text-sm text-gray-500 font-mono">
                            {input.length}/{text.length}
                        </span>
                    </div>

                    {/* Completion message */}
                    {isComplete && (
                        <div className="mt-4 text-center animate-fade-in-up">
                            <span className="text-green-600 font-semibold">‚úÖ Perfect! Definition memorized!</span>
                        </div>
                    )}
                </div>
            );
        }

        // API Helper
        const api = {
            token: localStorage.getItem('token'),

            async request(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json' };
                if (this.token) headers['Authorization'] = `Bearer ${this.token}`;

                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });

                if (response.status === 401) {
                    this.token = null;
                    localStorage.removeItem('token');
                    window.location.reload();
                    return null;
                }

                return response.json();
            },

            get: (endpoint) => api.request(endpoint),
            post: (endpoint, data) => api.request(endpoint, { method: 'POST', body: JSON.stringify(data) }),
            put: (endpoint, data) => api.request(endpoint, { method: 'PUT', body: JSON.stringify(data) })
        };

        // Login Component
        function Login({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                const result = await api.post('/auth/login', { username, password });

                if (result?.token) {
                    api.token = result.token;
                    localStorage.setItem('token', result.token);
                    onLogin(result.user);
                } else {
                    setError('Invalid username or password');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-400 to-blue-500">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-96">
                        <div className="text-center mb-6">
                            <div className="text-6xl mb-4">üåç</div>
                            <h1 className="text-2xl font-bold text-gray-800">Geography Guru</h1>
                            <p className="text-gray-500">IGCSE 0460 Study Companion</p>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <input
                                type="text"
                                placeholder="Username"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full p-3 border rounded-lg mb-3 focus:ring-2 focus:ring-green-500 focus:outline-none"
                            />
                            <input
                                type="password"
                                placeholder="Password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-green-500 focus:outline-none"
                            />

                            {error && <p className="text-red-500 text-sm mb-4">{error}</p>}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition disabled:opacity-50"
                            >
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>

                        <p className="text-center text-gray-400 text-sm mt-4">Default: gary / 1234</p>
                    </div>
                </div>
            );
        }

        // ============================================================================
        // RAG Query Modal - Reusable "Talk to Documents" component
        // Can be used across Sample Exam Questions, Tips, Definitions, etc.
        // ============================================================================
        function RAGQueryModal({ isOpen, onClose, context, contextType, onNavigateToDocChat }) {
            const [documents, setDocuments] = useState([]);
            const [selectedDocs, setSelectedDocs] = useState([]);
            const [userQuestion, setUserQuestion] = useState('');
            const [loading, setLoading] = useState(true);
            const [querying, setQuerying] = useState(false);
            const [result, setResult] = useState(null);
            const [settings, setSettings] = useState(null);
            const [showDocViewer, setShowDocViewer] = useState(false);
            const [viewingDoc, setViewingDoc] = useState(null);
            const [viewerPage, setViewerPage] = useState(1);
            const [viewerZoom, setViewerZoom] = useState(100);
            const [viewerFullscreen, setViewerFullscreen] = useState(false);

            // Context type labels
            const contextLabels = {
                'sample_question': 'Sample Exam Question',
                'tip': 'Study Tip',
                'common_error': 'Common Error',
                'definition': 'Definition',
                'case_study': 'Case Study',
                'general': 'Content'
            };

            // Load documents and settings on open (use ai_settings for API keys - same as main Settings)
            useEffect(() => {
                if (isOpen) {
                    setLoading(true);
                    setResult(null);
                    Promise.all([
                        api.get('/pdf/documents'),
                        api.get('/ai/settings')
                    ]).then(([docs, aiSettingsData]) => {
                        const readyDocs = (docs || []).filter(d => d.status === 'ready');
                        setDocuments(readyDocs);
                        setSettings(aiSettingsData?.settings || {});
                        // Auto-select all ready documents
                        setSelectedDocs(readyDocs.map(d => d.id));
                        setLoading(false);
                    });
                }
            }, [isOpen]);

            const toggleDoc = (docId) => {
                setSelectedDocs(prev =>
                    prev.includes(docId)
                        ? prev.filter(id => id !== docId)
                        : [...prev, docId]
                );
            };

            const selectAll = () => setSelectedDocs(documents.map(d => d.id));
            const deselectAll = () => setSelectedDocs([]);

            const handleSubmit = async () => {
                if (selectedDocs.length === 0) {
                    alert('Please select at least one document');
                    return;
                }

                // Build the query - combine context with optional user question
                let query = '';
                if (contextType === 'sample_question') {
                    query = `Regarding this exam question and answer:\n\nQuestion: ${context.question}\n\nStudent Answer: ${context.answer}\n\nTeacher Comments: ${context.comments}`;
                } else if (contextType === 'tip') {
                    query = `Regarding this study tip:\n\n${context.text}`;
                } else if (contextType === 'common_error') {
                    query = `Regarding this common error:\n\nError: ${context.error}\n\nWhy it's wrong: ${context.explanation}`;
                } else if (contextType === 'definition') {
                    query = `Regarding this term and definition:\n\n${context.term}: ${context.definition}`;
                } else {
                    query = context.text || context;
                }

                if (userQuestion.trim()) {
                    query += `\n\nUser's Question: ${userQuestion}`;
                } else {
                    query += `\n\nPlease provide more context, examples, and explanation from the study materials.`;
                }

                // Navigate to Document Chat with prefilled data
                if (onNavigateToDocChat) {
                    onNavigateToDocChat({
                        question: query,
                        documentIds: selectedDocs
                    });
                    onClose();
                    return;
                }

                // Fallback: do inline search if navigation not available
                // Check if OpenAI key is validated (api key exists and is validated)
                const hasValidKey = settings?.openai_api_key && settings?.openai_validated;
                if (!hasValidKey) {
                    alert('Please configure your OpenAI API key in the main Settings page first (go to Settings > AI Providers > OpenAI)');
                    return;
                }

                setQuerying(true);
                setResult(null);

                try {
                    // Use stored keys from main Settings
                    const defaultProvider = settings?.default_provider || 'openai';
                    const response = await api.post('/rag/chat', {
                        question: query,
                        document_ids: selectedDocs,
                        use_stored_key: true,  // Use stored key from ai_settings
                        llm_provider: defaultProvider,
                        llm_model: settings?.[`${defaultProvider}_model`] || 'gpt-4o-mini'
                    });

                    if (response?.answer) {
                        setResult({
                            answer: response.answer,
                            sources: response.sources || []
                        });
                    } else {
                        setResult({
                            answer: 'Sorry, I could not find relevant information. ' + (response?.error || ''),
                            sources: []
                        });
                    }
                } catch (err) {
                    setResult({
                        answer: 'Error: ' + err.message,
                        sources: []
                    });
                }

                setQuerying(false);
            };

            const openDocAtPage = (source) => {
                const doc = documents.find(d => d.id === source.document_id);
                if (doc?.public_url) {
                    setViewingDoc(doc);
                    setViewerPage(source.page_number || 1);
                    setShowDocViewer(true);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl w-11/12 max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
                        {/* Header */}
                        <div className="p-4 border-b flex items-center justify-between bg-gradient-to-r from-green-500 to-teal-500 rounded-t-xl">
                            <div>
                                <h3 className="text-xl font-bold text-white">üìö Talk to Documents</h3>
                                <p className="text-green-100 text-sm">
                                    Get more context from your study materials
                                </p>
                            </div>
                            <button
                                onClick={onClose}
                                className="text-white hover:text-green-200 text-2xl"
                            >
                                ‚úï
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-4">
                            {loading ? (
                                <div className="text-center py-8">Loading documents...</div>
                            ) : documents.length === 0 ? (
                                <div className="text-center py-8">
                                    <span className="text-4xl">üìÑ</span>
                                    <p className="mt-2 text-gray-500">No documents uploaded yet.</p>
                                    <p className="text-sm text-gray-400 mt-1">
                                        Go to Document Chat to upload your study guides first.
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {/* Context Preview */}
                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                        <p className="text-xs font-medium text-amber-700 mb-1">
                                            {contextLabels[contextType] || 'Context'}:
                                        </p>
                                        <p className="text-sm text-gray-700 line-clamp-3">
                                            {contextType === 'sample_question' ? context.question :
                                             contextType === 'tip' ? context.text :
                                             contextType === 'common_error' ? context.error :
                                             contextType === 'definition' ? `${context.term}: ${context.definition}` :
                                             (context.text || String(context)).substring(0, 200)}...
                                        </p>
                                    </div>

                                    {/* Document Selection */}
                                    <div>
                                        <div className="flex items-center justify-between mb-2">
                                            <p className="font-medium text-gray-700">Select documents to search:</p>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={selectAll}
                                                    className="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded"
                                                >
                                                    Select All
                                                </button>
                                                <button
                                                    onClick={deselectAll}
                                                    className="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded"
                                                >
                                                    Deselect
                                                </button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                                            {documents.map(doc => (
                                                <label
                                                    key={doc.id}
                                                    className={`flex items-center gap-2 p-2 rounded cursor-pointer transition ${
                                                        selectedDocs.includes(doc.id)
                                                            ? 'bg-green-100 border border-green-300'
                                                            : 'bg-white border border-gray-200 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedDocs.includes(doc.id)}
                                                        onChange={() => toggleDoc(doc.id)}
                                                        className="h-4 w-4 text-green-600 rounded"
                                                    />
                                                    <span className="text-sm truncate">{doc.original_filename}</span>
                                                </label>
                                            ))}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {selectedDocs.length} of {documents.length} selected
                                        </p>
                                    </div>

                                    {/* Optional User Question */}
                                    <div>
                                        <p className="font-medium text-gray-700 mb-2">
                                            Your question (optional):
                                        </p>
                                        <textarea
                                            value={userQuestion}
                                            onChange={(e) => setUserQuestion(e.target.value)}
                                            placeholder="Enter a question to search your documents (e.g., 'Define birth rate')..."
                                            className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"
                                            rows={2}
                                        />
                                    </div>

                                    {/* Submit Button */}
                                    <button
                                        onClick={handleSubmit}
                                        disabled={querying || selectedDocs.length === 0}
                                        className="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-medium"
                                    >
                                        {querying ? 'üîç Searching...' : 'üîç Search in Document'}
                                    </button>

                                    {/* Result */}
                                    {result && (
                                        <div className="mt-4 border-t pt-4">
                                            <h4 className="font-medium text-gray-700 mb-2">üìñ From your study materials:</h4>
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                <p className="text-gray-800 whitespace-pre-wrap">{result.answer}</p>

                                                {/* Source Citations */}
                                                {result.sources?.length > 0 && (
                                                    <div className="mt-3 pt-3 border-t border-blue-200">
                                                        <p className="text-xs font-medium text-blue-700 mb-2">üìç Sources (click to view original):</p>
                                                        <div className="flex flex-wrap gap-2">
                                                            {result.sources.map((s, idx) => (
                                                                <button
                                                                    key={idx}
                                                                    onClick={() => openDocAtPage(s)}
                                                                    className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 hover:shadow-md transition flex items-center gap-1.5 border border-blue-200"
                                                                    title={`Click to view: ${s.content?.substring(0, 100)}...`}
                                                                >
                                                                    <span className="text-blue-500">üîó</span>
                                                                    <span className="truncate max-w-[140px] font-medium">
                                                                        {s.document_name || 'Document'}
                                                                    </span>
                                                                    <span className="bg-blue-200 px-1.5 py-0.5 rounded text-xs font-bold">p.{s.page_number}</span>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="p-3 border-t bg-gray-50 rounded-b-xl">
                            <p className="text-xs text-gray-500 text-center">
                                Powered by RAG ‚Ä¢ Searches your uploaded study materials
                            </p>
                        </div>
                    </div>

                    {/* Document Viewer Sub-Modal - Enhanced */}
                    {showDocViewer && viewingDoc?.public_url && (
                        <div className={`fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[60] ${viewerFullscreen ? 'p-0' : 'p-4'}`}>
                            <div className={`bg-white flex flex-col ${viewerFullscreen ? 'w-full h-full' : 'rounded-xl w-11/12 h-5/6 max-w-6xl'}`}>
                                {/* Header with controls */}
                                <div className="p-3 border-b flex items-center justify-between bg-gray-50 flex-shrink-0">
                                    <div className="flex items-center gap-3 flex-wrap">
                                        <h4 className="font-semibold text-gray-800 truncate max-w-[200px]" title={viewingDoc.original_filename}>
                                            {viewingDoc.original_filename}
                                        </h4>

                                        {/* Page Navigation */}
                                        <div className="flex items-center gap-1 bg-white border rounded-lg px-2 py-1">
                                            <button
                                                onClick={() => setViewerPage(Math.max(1, viewerPage - 1))}
                                                className="px-2 py-0.5 hover:bg-gray-100 rounded transition"
                                                title="Previous page"
                                            >
                                                ‚óÄ
                                            </button>
                                            <span className="text-sm font-medium px-2">Page {viewerPage}</span>
                                            <button
                                                onClick={() => setViewerPage(viewerPage + 1)}
                                                className="px-2 py-0.5 hover:bg-gray-100 rounded transition"
                                                title="Next page"
                                            >
                                                ‚ñ∂
                                            </button>
                                        </div>

                                        {/* Zoom Controls */}
                                        <div className="flex items-center gap-1 bg-white border rounded-lg px-2 py-1">
                                            <button
                                                onClick={() => setViewerZoom(Math.max(50, viewerZoom - 25))}
                                                className="px-2 py-0.5 hover:bg-gray-100 rounded transition font-bold"
                                                title="Zoom out"
                                            >
                                                ‚àí
                                            </button>
                                            <span className="text-sm font-medium px-2 min-w-[50px] text-center">{viewerZoom}%</span>
                                            <button
                                                onClick={() => setViewerZoom(Math.min(200, viewerZoom + 25))}
                                                className="px-2 py-0.5 hover:bg-gray-100 rounded transition font-bold"
                                                title="Zoom in"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>

                                    {/* Action Buttons */}
                                    <div className="flex items-center gap-2">
                                        {/* Open in New Tab */}
                                        <button
                                            onClick={() => window.open(`${viewingDoc.public_url}#page=${viewerPage}`, '_blank')}
                                            className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 transition flex items-center gap-1"
                                            title="Open in new tab for full search (Cmd+F)"
                                        >
                                            <span>üîç</span>
                                            <span className="hidden sm:inline">Search (New Tab)</span>
                                        </button>

                                        {/* Fullscreen Toggle */}
                                        <button
                                            onClick={() => setViewerFullscreen(!viewerFullscreen)}
                                            className="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition flex items-center gap-1"
                                            title={viewerFullscreen ? "Exit fullscreen" : "Fullscreen"}
                                        >
                                            <span>{viewerFullscreen ? '‚äô' : '‚õ∂'}</span>
                                            <span className="hidden sm:inline">{viewerFullscreen ? 'Exit' : 'Fullscreen'}</span>
                                        </button>

                                        {/* Close */}
                                        <button
                                            onClick={() => { setShowDocViewer(false); setViewerFullscreen(false); setViewerZoom(100); }}
                                            className="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200 transition"
                                            title="Close viewer"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>

                                {/* Search Tip Bar */}
                                <div className="px-3 py-1.5 bg-yellow-50 border-b text-xs text-yellow-800 flex items-center gap-2">
                                    <span>üí°</span>
                                    <span>Tip: Click "Search (New Tab)" to use Cmd+F for keyword search in the document</span>
                                </div>

                                {/* PDF Viewer */}
                                <div className="flex-1 overflow-auto bg-gray-100" style={{ padding: viewerFullscreen ? '0' : '8px' }}>
                                    <div style={{
                                        transform: `scale(${viewerZoom / 100})`,
                                        transformOrigin: 'top center',
                                        width: viewerZoom > 100 ? `${100 * 100 / viewerZoom}%` : '100%',
                                        height: viewerZoom > 100 ? `${100 * 100 / viewerZoom}%` : '100%'
                                    }}>
                                        <iframe
                                            src={`${viewingDoc.public_url}#page=${viewerPage}`}
                                            className="w-full h-full border-0 rounded bg-white shadow-lg"
                                            style={{ minHeight: viewerFullscreen ? '100vh' : '70vh' }}
                                            title="Document Viewer"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Navigation Component
        function Navigation({ user, currentView, setCurrentView, onLogout }) {
            const navItems = [
                { id: 'topics', label: 'Topics', icon: 'üìö' },
                { id: 'pdf-chat', label: 'Document Chat', icon: 'üìÑ' },
                { id: 'progress', label: 'Progress', icon: 'üìä' },
                { id: 'weak-points', label: 'Weak Points', icon: 'üéØ' },
                { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
            ];

            return (
                <nav className="bg-white shadow-lg">
                    <div className="max-w-7xl mx-auto px-4">
                        <div className="flex justify-between items-center py-4">
                            <div className="flex items-center space-x-2">
                                <span className="text-3xl">üåç</span>
                                <span className="text-xl font-bold text-gray-800">Geography Guru</span>
                            </div>

                            <div className="flex items-center space-x-4">
                                {navItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setCurrentView(item.id)}
                                        className={`flex items-center space-x-1 px-4 py-2 rounded-lg transition
                                            ${currentView === item.id
                                                ? 'bg-green-500 text-white'
                                                : 'text-gray-600 hover:bg-gray-100'}`}
                                    >
                                        <span>{item.icon}</span>
                                        <span>{item.label}</span>
                                    </button>
                                ))}

                                <div className="border-l pl-4 ml-4">
                                    <span className="text-gray-600">üë§ {user.display_name}</span>
                                    <button
                                        onClick={onLogout}
                                        className="ml-3 text-red-500 hover:text-red-700"
                                    >
                                        Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        }

        // Topics List Component
        function TopicsList({ onSelectTopic }) {
            const [themes, setThemes] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/topics').then(data => {
                    setThemes(data || []);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading topics...</div>;

            const themeColors = {
                1: 'from-purple-500 to-pink-500',
                2: 'from-green-500 to-teal-500',
                3: 'from-orange-500 to-red-500',
                4: 'from-blue-500 to-indigo-500'
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">üìö Select a Topic</h2>

                    <div className="grid gap-6">
                        {themes.map(theme => (
                            <div key={theme.theme_number} className="bg-white rounded-xl shadow-lg overflow-hidden">
                                <div className={`bg-gradient-to-r ${themeColors[theme.theme_number]} p-4`}>
                                    <h3 className="text-white text-xl font-bold">
                                        Theme {theme.theme_number}: {theme.theme_name}
                                    </h3>
                                </div>

                                <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {theme.topics.map(topic => (
                                        <button
                                            key={topic.id}
                                            onClick={() => onSelectTopic(topic)}
                                            className="p-4 border rounded-lg text-left hover:bg-gray-50 hover:border-green-500 transition group"
                                        >
                                            <span className="font-semibold text-green-600 group-hover:text-green-700">
                                                {topic.topic_number}
                                            </span>
                                            <span className="text-gray-700 ml-2">{topic.topic_name}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Topic Detail Component
        function TopicDetail({ topic, onBack, typingSettings, onNavigateToDocChat }) {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('learn');
            const [startIndex, setStartIndex] = useState(0);
            // RAG modal state
            const [ragModalOpen, setRagModalOpen] = useState(false);
            const [ragContext, setRagContext] = useState(null);
            const [ragContextType, setRagContextType] = useState('general');

            useEffect(() => {
                api.get(`/topics/${topic.id}`).then(result => {
                    setData(result);
                    setLoading(false);
                });
            }, [topic.id]);

            // Navigation helper to jump to a specific item in a tab
            const navigateTo = (tabId, index = 0) => {
                setStartIndex(index);
                setActiveTab(tabId);
            };

            // RAG modal helper
            const openRAGModal = (context, contextType) => {
                setRagContext(context);
                setRagContextType(contextType);
                setRagModalOpen(true);
            };

            if (loading) return <div className="text-center py-8">Loading...</div>;

            const tabs = [
                { id: 'learn', label: 'Learn', icon: 'üìñ' },
                { id: 'flashcards', label: 'Flashcards', icon: 'üÉè' },
                { id: 'test-yourself', label: 'Test Yourself', icon: '‚úÖ' },
                { id: 'exam-practice', label: 'Exam Practice', icon: 'üìù' },
                { id: 'study-tips', label: 'Tips & Errors', icon: 'üí°' },
                { id: 'quiz', label: 'Quiz', icon: '‚úèÔ∏è' }
            ];

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <button
                        onClick={onBack}
                        className="mb-4 text-green-600 hover:text-green-800 flex items-center"
                    >
                        ‚Üê Back to Topics
                    </button>

                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-green-500 to-teal-500 p-6">
                            <h2 className="text-white text-2xl font-bold">
                                {topic.topic_number} {topic.topic_name}
                            </h2>
                        </div>

                        <div className="border-b">
                            <div className="flex">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => { setStartIndex(0); setActiveTab(tab.id); }}
                                        className={`px-6 py-4 flex items-center space-x-2 font-medium transition
                                            ${activeTab === tab.id
                                                ? 'border-b-2 border-green-500 text-green-600'
                                                : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        <span>{tab.icon}</span>
                                        <span>{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-6">
                            {activeTab === 'learn' && <LearnTab data={data} onNavigate={navigateTo} onOpenRAG={openRAGModal} />}
                            {activeTab === 'flashcards' && <FlashcardsTab definitions={data?.definitions || []} topicId={topic.id} typingSettings={typingSettings} startIndex={startIndex} onStartIndexUsed={() => setStartIndex(0)} />}
                            {activeTab === 'test-yourself' && <TestYourselfTab topicCode={topic.topic_number} topicName={topic.topic_name} typingSettings={typingSettings} startIndex={startIndex} onStartIndexUsed={() => setStartIndex(0)} />}
                            {activeTab === 'exam-practice' && <ExamPracticeTab topicId={topic.id} topicName={topic.topic_name} />}
                            {activeTab === 'study-tips' && <StudyTipsTab topicId={topic.id} />}
                            {activeTab === 'quiz' && <QuizTab questions={data?.questions || []} topicId={topic.id} typingSettings={typingSettings} startIndex={startIndex} onStartIndexUsed={() => setStartIndex(0)} />}
                        </div>
                    </div>

                    {/* RAG Query Modal */}
                    {ragModalOpen && (
                        <RAGQueryModal
                            isOpen={ragModalOpen}
                            onClose={() => setRagModalOpen(false)}
                            context={ragContext}
                            contextType={ragContextType}
                            onNavigateToDocChat={onNavigateToDocChat}
                        />
                    )}
                </div>
            );
        }

        // Learn Tab Component
        function LearnTab({ data, onNavigate, onOpenRAG }) {
            const content = data?.content || {};

            return (
                <div className="space-y-6">
                    <section>
                        <h3 className="text-xl font-bold text-gray-800 mb-4">üìù Key Definitions</h3>
                        <div className="grid gap-3">
                            {data?.definitions?.map((def, i) => (
                                <div key={i} className="bg-gray-50 p-4 rounded-lg">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <span className="font-semibold text-green-600">{def.term}:</span>
                                            <span className="ml-2 text-gray-700">{def.definition}</span>
                                            {def.textbook_page && (
                                                <span className="ml-2 text-gray-400 text-sm">(p.{def.textbook_page})</span>
                                            )}
                                        </div>
                                        <div className="flex gap-1 ml-3 flex-shrink-0">
                                            <button
                                                onClick={() => onNavigate('flashcards', i)}
                                                className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition"
                                                title="Practice with Flashcard"
                                            >
                                                üÉè
                                            </button>
                                            <button
                                                onClick={() => onNavigate('test-yourself', i)}
                                                className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition"
                                                title="Test Yourself"
                                            >
                                                ‚úÖ
                                            </button>
                                            <button
                                                onClick={() => onNavigate('quiz', i)}
                                                className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition"
                                                title="Take Quiz"
                                            >
                                                ‚úèÔ∏è
                                            </button>
                                            <button
                                                onClick={() => onOpenRAG({ term: def.term, definition: def.definition }, 'definition')}
                                                className="px-2 py-1 text-xs bg-teal-100 text-teal-700 rounded hover:bg-teal-200 transition"
                                                title="Search in documents"
                                            >
                                                üìö
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>

                    {content.tips?.length > 0 && (
                        <section>
                            <h3 className="text-xl font-bold text-gray-800 mb-4">üí° Exam Tips</h3>
                            <div className="space-y-2">
                                {content.tips.map((tip, i) => (
                                    <div key={i} className="flex items-start gap-2">
                                        <span className="text-gray-700">‚Ä¢ {tip}</span>
                                        <button
                                            onClick={() => onOpenRAG({ text: tip }, 'tip')}
                                            className="px-2 py-0.5 text-xs bg-teal-100 text-teal-700 rounded hover:bg-teal-200 transition flex-shrink-0"
                                            title="Search in documents"
                                        >
                                            üìö
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    {content.common_errors?.length > 0 && (
                        <section>
                            <h3 className="text-xl font-bold text-gray-800 mb-4">‚ö†Ô∏è Common Errors</h3>
                            <div className="space-y-2">
                                {content.common_errors.map((error, i) => (
                                    <div key={i} className="flex items-start gap-2">
                                        <span className="text-red-600">‚Ä¢ {error}</span>
                                        <button
                                            onClick={() => onOpenRAG({ error: error, explanation: '' }, 'common_error')}
                                            className="px-2 py-0.5 text-xs bg-teal-100 text-teal-700 rounded hover:bg-teal-200 transition flex-shrink-0"
                                            title="Search in documents"
                                        >
                                            üìö
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}
                </div>
            );
        }

        // Flashcards Tab Component - ENHANCED with Type to Learn
        function FlashcardsTab({ definitions, topicId, typingSettings, startIndex = 0, onStartIndexUsed }) {
            const [currentIndex, setCurrentIndex] = useState(startIndex);
            const [flipped, setFlipped] = useState(false);
            const [stats, setStats] = useState({ knew: 0, didnt: 0 });
            const [mode, setMode] = useState('flip'); // 'flip' or 'type'
            const [isTyping, setIsTyping] = useState(false);

            // Handle startIndex from navigation
            useEffect(() => {
                if (startIndex > 0 && startIndex < definitions.length) {
                    setCurrentIndex(startIndex);
                    setFlipped(false);
                    setIsTyping(false);
                    if (onStartIndexUsed) onStartIndexUsed();
                }
            }, [startIndex, definitions.length, onStartIndexUsed]);

            const current = definitions[currentIndex];

            // Navigation functions
            const goToNext = () => {
                if (currentIndex < definitions.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                    setFlipped(false);
                    setIsTyping(false);
                }
            };

            const goToPrevious = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                    setFlipped(false);
                    setIsTyping(false);
                }
            };

            const handleResponse = async (knewIt) => {
                await api.post(`/flashcards/${current.id}/attempt`, { knew_it: knewIt });

                setStats(prev => ({
                    knew: knewIt ? prev.knew + 1 : prev.knew,
                    didnt: !knewIt ? prev.didnt + 1 : prev.didnt
                }));

                setFlipped(false);
                setIsTyping(false);
                if (currentIndex < definitions.length - 1) {
                    setTimeout(() => setCurrentIndex(currentIndex + 1), 300);
                }
            };

            const handleTypeComplete = () => {
                // Auto-mark as knew it if typed correctly
                handleResponse(true);
            };

            const startTyping = () => {
                setIsTyping(true);
            };

            if (!definitions.length) {
                return <div className="text-center py-8 text-gray-500">No flashcards available for this topic.</div>;
            }

            if (currentIndex >= definitions.length) {
                const percentage = Math.round((stats.knew / (stats.knew + stats.didnt)) * 100);
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">üéâ</div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">All done!</h3>
                        <p className="text-gray-600 mb-4">
                            You knew {stats.knew} out of {stats.knew + stats.didnt} definitions ({percentage}%)
                        </p>
                        <button
                            onClick={() => { setCurrentIndex(0); setStats({ knew: 0, didnt: 0 }); setIsTyping(false); }}
                            className="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600"
                        >
                            Start Again
                        </button>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center">
                    {/* Mode Toggle */}
                    <div className="mb-4 flex items-center gap-2 bg-gray-100 p-1 rounded-full">
                        <button
                            onClick={() => { setMode('flip'); setIsTyping(false); setFlipped(false); }}
                            className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                mode === 'flip' ? 'bg-white shadow text-green-600' : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            üÉè Flip Mode
                        </button>
                        <button
                            onClick={() => { setMode('type'); setFlipped(false); }}
                            className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                mode === 'type' ? 'bg-white shadow text-green-600' : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            ‚å®Ô∏è Type Mode
                        </button>
                    </div>

                    {/* Navigation Controls */}
                    <div className="mb-4 flex items-center gap-4">
                        <button
                            onClick={goToPrevious}
                            disabled={currentIndex === 0}
                            className="px-3 py-1 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                        >
                            ‚Üê Prev
                        </button>
                        <span className="text-gray-500">
                            Card {currentIndex + 1} of {definitions.length}
                        </span>
                        <button
                            onClick={goToNext}
                            disabled={currentIndex >= definitions.length - 1}
                            className="px-3 py-1 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                        >
                            Next ‚Üí
                        </button>
                    </div>

                    {mode === 'flip' ? (
                        <>
                            <div
                                className={`flip-card w-full max-w-lg h-64 cursor-pointer ${flipped ? 'flipped' : ''}`}
                                onClick={() => setFlipped(!flipped)}
                            >
                                <div className="flip-card-inner relative w-full h-full">
                                    <div className="flip-card-front absolute w-full h-full bg-gradient-to-br from-green-400 to-teal-500 rounded-xl flex items-center justify-center p-8">
                                        <h3 className="text-white text-2xl font-bold text-center">{current.term}</h3>
                                    </div>
                                    <div className="flip-card-back absolute w-full h-full bg-white border-2 border-green-500 rounded-xl flex items-center justify-center p-8">
                                        <p className="text-gray-700 text-lg text-center">{current.definition}</p>
                                    </div>
                                </div>
                            </div>

                            <p className="text-gray-400 text-sm mt-4 mb-6">Click to flip</p>

                            <div className="flex space-x-4">
                                <button
                                    onClick={() => handleResponse(false)}
                                    className="bg-red-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-red-600 transition"
                                >
                                    ‚ùå Didn't Know
                                </button>
                                <button
                                    onClick={() => handleResponse(true)}
                                    className="bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600 transition"
                                >
                                    ‚úÖ Knew It!
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="w-full max-w-lg">
                            {/* Term card */}
                            <div className="bg-gradient-to-br from-green-400 to-teal-500 rounded-xl p-6 mb-6">
                                <h3 className="text-white text-2xl font-bold text-center">{current.term}</h3>
                            </div>

                            {!isTyping ? (
                                <div className="text-center">
                                    <p className="text-gray-600 mb-4">
                                        Read the definition, then type it from memory to reinforce learning
                                    </p>

                                    {/* Show definition preview */}
                                    <div className="bg-gray-50 rounded-xl p-6 mb-6 text-left">
                                        <p className="text-gray-700 text-lg">{current.definition}</p>
                                    </div>

                                    <button
                                        onClick={startTyping}
                                        className="bg-green-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-600 transition flex items-center gap-2 mx-auto"
                                    >
                                        ‚å®Ô∏è Type to Memorize
                                    </button>

                                    <button
                                        onClick={() => handleResponse(true)}
                                        className="mt-3 text-gray-500 hover:text-gray-700 text-sm"
                                    >
                                        Skip (I already know this)
                                    </button>
                                </div>
                            ) : (
                                <TypingPractice
                                    text={current.definition}
                                    onComplete={handleTypeComplete}
                                    onCancel={() => setIsTyping(false)}
                                    settings={typingSettings}
                                    label={`Definition of "${current.term}"`}
                                />
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Test Yourself Tab Component (Study Guide Questions p.125-127) - ENHANCED
        function TestYourselfTab({ topicCode, topicName, typingSettings, startIndex = 0, onStartIndexUsed }) {
            const [questions, setQuestions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [revealedAnswers, setRevealedAnswers] = useState({});
            const [userScores, setUserScores] = useState({});
            const [completed, setCompleted] = useState(false);
            const [typingIndex, setTypingIndex] = useState(null);
            const [focusedIndex, setFocusedIndex] = useState(null); // For single-question view
            const questionRefs = React.useRef([]);

            useEffect(() => {
                api.get(`/test-yourself/${topicCode}`).then(data => {
                    setQuestions(data || []);
                    setLoading(false);
                });
            }, [topicCode]);

            // Handle startIndex from navigation - focus on that question
            useEffect(() => {
                if (startIndex > 0 && questions.length > 0 && startIndex < questions.length) {
                    setFocusedIndex(startIndex);
                    if (onStartIndexUsed) onStartIndexUsed();
                }
            }, [startIndex, questions.length, onStartIndexUsed]);

            // Navigation for focused view
            const goToNext = () => {
                if (focusedIndex !== null && focusedIndex < questions.length - 1) {
                    setFocusedIndex(focusedIndex + 1);
                    setTypingIndex(null);
                }
            };

            const goToPrevious = () => {
                if (focusedIndex !== null && focusedIndex > 0) {
                    setFocusedIndex(focusedIndex - 1);
                    setTypingIndex(null);
                }
            };

            const exitFocusMode = () => {
                setFocusedIndex(null);
                setTypingIndex(null);
            };

            const toggleAnswer = (index) => {
                setRevealedAnswers(prev => ({
                    ...prev,
                    [index]: !prev[index]
                }));
            };

            const markScore = async (index, knewIt) => {
                setUserScores(prev => ({
                    ...prev,
                    [index]: knewIt
                }));
                setTypingIndex(null);

                await api.post(`/test-yourself/${topicCode}/attempt`, {
                    question_number: index + 1,
                    knew_it: knewIt
                });

                const newScores = { ...userScores, [index]: knewIt };
                if (Object.keys(newScores).length === questions.length) {
                    setCompleted(true);
                }
            };

            const startTyping = (index) => {
                setTypingIndex(index);
            };

            const handleTypingComplete = (index) => {
                markScore(index, true);
            };

            const resetQuiz = () => {
                setRevealedAnswers({});
                setUserScores({});
                setCompleted(false);
                setTypingIndex(null);
            };

            if (loading) {
                return <div className="text-center py-8">Loading Test Yourself questions...</div>;
            }

            if (!questions.length) {
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">üìù</div>
                        <p className="text-gray-500">No Test Yourself questions available for this topic yet.</p>
                    </div>
                );
            }

            const totalScore = Object.values(userScores).filter(v => v === true).length;
            const totalAnswered = Object.keys(userScores).length;

            if (completed) {
                const percentage = Math.round(totalScore / questions.length * 100);
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">{percentage >= 70 ? 'üåü' : percentage >= 50 ? 'üëç' : 'üìö'}</div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Test Yourself Complete!</h3>
                        <p className="text-xl text-gray-600 mb-4">
                            You knew {totalScore} out of {questions.length} answers ({percentage}%)
                        </p>
                        <p className="text-gray-500 mb-6">
                            {percentage >= 70 ? 'Excellent work! You have a strong understanding.' :
                             percentage >= 50 ? 'Good effort! Review the answers you missed.' :
                             'Keep studying! Review the definitions and try again.'}
                        </p>
                        <button
                            onClick={resetQuiz}
                            className="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600"
                        >
                            Try Again
                        </button>
                    </div>
                );
            }

            // Focused single-question view with navigation
            if (focusedIndex !== null && questions[focusedIndex]) {
                const q = questions[focusedIndex];
                const index = focusedIndex;
                return (
                    <div className="space-y-6">
                        <div className="flex items-center justify-between">
                            <button
                                onClick={exitFocusMode}
                                className="text-gray-500 hover:text-gray-700 flex items-center gap-1"
                            >
                                ‚Üê Back to All Questions
                            </button>
                        </div>

                        {/* Navigation Controls */}
                        <div className="flex items-center justify-center gap-4">
                            <button
                                onClick={goToPrevious}
                                disabled={focusedIndex === 0}
                                className="px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                            >
                                ‚Üê Previous
                            </button>
                            <span className="text-gray-500 font-medium">
                                Question {focusedIndex + 1} of {questions.length}
                            </span>
                            <button
                                onClick={goToNext}
                                disabled={focusedIndex >= questions.length - 1}
                                className="px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                            >
                                Next ‚Üí
                            </button>
                        </div>

                        {/* Single Question Card */}
                        <div className={`border-2 rounded-xl overflow-hidden ${
                            userScores[index] !== undefined
                                ? (userScores[index] ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50')
                                : 'border-gray-300'
                        }`}>
                            <div className="p-6">
                                <div className="flex items-start space-x-4">
                                    <span className="flex-shrink-0 w-12 h-12 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-xl">
                                        {q.number}
                                    </span>
                                    <div className="flex-grow">
                                        <p className="text-gray-800 font-medium text-lg">{q.question}</p>
                                    </div>
                                </div>

                                {!revealedAnswers[index] && userScores[index] === undefined && (
                                    <button
                                        onClick={() => toggleAnswer(index)}
                                        className="mt-6 ml-16 text-green-600 hover:text-green-800 font-medium flex items-center space-x-1 text-lg"
                                    >
                                        <span>üëÅÔ∏è Reveal Answer</span>
                                    </button>
                                )}

                                {revealedAnswers[index] && userScores[index] === undefined && (
                                    <div className="mt-6 ml-16">
                                        {typingIndex === index ? (
                                            <TypingPractice
                                                text={q.answer}
                                                onComplete={() => handleTypingComplete(index)}
                                                onCancel={() => setTypingIndex(null)}
                                                settings={typingSettings}
                                                label="Answer"
                                            />
                                        ) : (
                                            <>
                                                <div className="bg-white p-6 rounded-lg border border-green-200">
                                                    <p className="text-gray-700 text-lg">{q.answer}</p>
                                                </div>
                                                <div className="mt-4 flex flex-wrap gap-3">
                                                    <button
                                                        onClick={() => startTyping(index)}
                                                        className="bg-blue-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition flex items-center gap-2"
                                                    >
                                                        ‚å®Ô∏è Type to Memorize
                                                    </button>
                                                    <button
                                                        onClick={() => markScore(index, true)}
                                                        className="bg-green-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-600 transition"
                                                    >
                                                        ‚úÖ I knew this
                                                    </button>
                                                    <button
                                                        onClick={() => markScore(index, false)}
                                                        className="bg-red-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-600 transition"
                                                    >
                                                        ‚ùå Didn't know
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}

                                {userScores[index] !== undefined && (
                                    <div className="mt-6 ml-16">
                                        <div className="bg-white p-4 rounded-lg border border-green-200">
                                            <p className="text-gray-700">{q.answer}</p>
                                        </div>
                                        <p className={`mt-2 font-medium ${userScores[index] ? 'text-green-600' : 'text-red-600'}`}>
                                            {userScores[index] ? '‚úÖ You knew this!' : '‚ùå Keep practicing!'}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h3 className="text-lg font-bold text-blue-800 mb-2">üìñ Test Yourself</h3>
                        <p className="text-blue-700">
                            These questions are from the Cambridge IGCSE Geography Study and Revision Guide (p.125-127).
                            Try to answer each question, then reveal and <b>type the answer to memorize it</b>!
                        </p>
                    </div>

                    {totalAnswered > 0 && (
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <div className="flex justify-between items-center">
                                <span className="text-gray-600">Progress: {totalAnswered}/{questions.length}</span>
                                <span className="font-semibold text-green-600">Score: {totalScore}/{totalAnswered}</span>
                            </div>
                            <div className="mt-2 bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-green-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${(totalAnswered / questions.length) * 100}%` }}
                                ></div>
                            </div>
                        </div>
                    )}

                    <div className="space-y-4">
                        {questions.map((q, index) => (
                            <div key={index} className={`border rounded-lg overflow-hidden ${
                                userScores[index] !== undefined
                                    ? (userScores[index] ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50')
                                    : 'border-gray-200'
                            }`}>
                                <div className="p-4">
                                    <div className="flex items-start space-x-3">
                                        <span className="flex-shrink-0 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">
                                            {q.number}
                                        </span>
                                        <div className="flex-grow">
                                            <p className="text-gray-800 font-medium">{q.question}</p>
                                        </div>
                                        <button
                                            onClick={() => setFocusedIndex(index)}
                                            className="flex-shrink-0 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition"
                                            title="Focus on this question"
                                        >
                                            Focus ‚Üí
                                        </button>
                                    </div>

                                    {!revealedAnswers[index] && userScores[index] === undefined && (
                                        <button
                                            onClick={() => toggleAnswer(index)}
                                            className="mt-4 ml-11 text-green-600 hover:text-green-800 font-medium flex items-center space-x-1"
                                        >
                                            <span>üëÅÔ∏è Reveal Answer</span>
                                        </button>
                                    )}

                                    {revealedAnswers[index] && userScores[index] === undefined && (
                                        <div className="mt-4 ml-11">
                                            {typingIndex === index ? (
                                                <TypingPractice
                                                    text={q.answer}
                                                    onComplete={() => handleTypingComplete(index)}
                                                    onCancel={() => setTypingIndex(null)}
                                                    settings={typingSettings}
                                                    label="Answer"
                                                />
                                            ) : (
                                                <>
                                                    <div className="bg-white p-4 rounded-lg border border-green-200">
                                                        <p className="text-gray-700">{q.answer}</p>
                                                    </div>

                                                    <div className="mt-3 flex flex-wrap gap-3">
                                                        <button
                                                            onClick={() => startTyping(index)}
                                                            className="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition flex items-center gap-2"
                                                        >
                                                            ‚å®Ô∏è Type to Memorize
                                                        </button>
                                                        <button
                                                            onClick={() => markScore(index, true)}
                                                            className="bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition flex items-center space-x-2"
                                                        >
                                                            <span>‚úÖ</span>
                                                            <span>I knew this</span>
                                                        </button>
                                                        <button
                                                            onClick={() => markScore(index, false)}
                                                            className="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition flex items-center space-x-2"
                                                        >
                                                            <span>‚ùå</span>
                                                            <span>Need to review</span>
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {userScores[index] !== undefined && (
                                        <div className="mt-4 ml-11">
                                            <div className="bg-white p-4 rounded-lg border border-green-200 mb-2">
                                                <p className="text-gray-700">{q.answer}</p>
                                            </div>
                                            <div className={`inline-block px-3 py-1 rounded-full text-sm font-medium ${
                                                userScores[index] ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                                            }`}>
                                                {userScores[index] ? '‚úÖ Correct!' : '‚ùå Review this'}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="text-center text-sm text-gray-400">
                        Source: Cambridge IGCSE and O Level Geography Study and Revision Guide (p.125-127)
                    </div>
                </div>
            );
        }

        // Exam Practice Tab Component - Shows exam questions with model answers for this topic
        function ExamPracticeTab({ topicId, topicName }) {
            const [questions, setQuestions] = useState([]);
            const [sampleAnswers, setSampleAnswers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expandedId, setExpandedId] = useState(null);
            const [expandedSampleId, setExpandedSampleId] = useState(null);
            // RAG Modal state
            const [ragModalOpen, setRagModalOpen] = useState(false);
            const [ragContext, setRagContext] = useState(null);
            const [ragContextType, setRagContextType] = useState('general');

            const openRAGModal = (context, type) => {
                setRagContext(context);
                setRagContextType(type);
                setRagModalOpen(true);
            };

            useEffect(() => {
                Promise.all([
                    api.get(`/exam-questions/${topicId}`),
                    api.get(`/sample-answers/${topicId}`)
                ]).then(([questionsData, sampleData]) => {
                    setQuestions(questionsData || []);
                    setSampleAnswers(sampleData || []);
                    setLoading(false);
                });
            }, [topicId]);

            if (loading) return <div className="text-center py-8">Loading exam questions...</div>;

            if (questions.length === 0 && sampleAnswers.length === 0) {
                return (
                    <div className="text-center py-12">
                        <span className="text-6xl">üìù</span>
                        <p className="mt-4 text-gray-500">No exam questions available for this topic yet.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-8">
                    {/* Exam-Style Questions Section */}
                    {questions.length > 0 && (
                        <div className="space-y-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">
                                    üìù Exam-Style Questions ({questions.length})
                                </h3>
                            </div>

                            {questions.map((q, index) => (
                                <div key={q.id} className="border rounded-xl overflow-hidden bg-white shadow-sm">
                                    <div
                                        className="p-4 cursor-pointer hover:bg-gray-50 transition"
                                        onClick={() => setExpandedId(expandedId === q.id ? null : q.id)}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex-grow">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm font-medium">
                                                        {q.marks} marks
                                                    </span>
                                                    {q.command_word && (
                                                        <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded text-sm">
                                                            {q.command_word}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-gray-800 font-medium">{q.question_text}</p>
                                            </div>
                                            <span className="text-gray-400 text-xl ml-4">
                                                {expandedId === q.id ? '‚ñº' : '‚ñ∂'}
                                            </span>
                                        </div>
                                    </div>

                                    {expandedId === q.id && (
                                        <div className="border-t bg-green-50 p-4">
                                            <h4 className="font-semibold text-green-800 mb-2">‚úÖ Model Answer:</h4>
                                            <p className="text-gray-700 whitespace-pre-line">{q.model_answer}</p>
                                            <div className="mt-3 pt-3 border-t border-green-200 flex justify-end">
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        openRAGModal({
                                                            question: q.question_text,
                                                            answer: q.model_answer,
                                                            comments: ''
                                                        }, 'sample_question');
                                                    }}
                                                    className="px-3 py-1.5 bg-teal-500 text-white rounded-lg text-sm hover:bg-teal-600 transition flex items-center gap-1"
                                                >
                                                    üìö Talk to Documents
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Sample Exam Questions with Student Answers Section */}
                    {sampleAnswers.length > 0 && (
                        <div className="space-y-4">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">
                                    üìã Sample Exam Questions with Student Answers ({sampleAnswers.length})
                                </h3>
                            </div>
                            <p className="text-sm text-gray-600 mb-4">
                                Learn from real student answers and teacher feedback to understand how marks are awarded.
                            </p>

                            {sampleAnswers.map((sa, index) => (
                                <div key={sa.id} className="border-2 border-amber-200 rounded-xl overflow-hidden bg-amber-50 shadow-sm">
                                    <div
                                        className="p-4 cursor-pointer hover:bg-amber-100 transition"
                                        onClick={() => setExpandedSampleId(expandedSampleId === sa.id ? null : sa.id)}
                                    >
                                        <div className="flex items-start justify-between">
                                            <div className="flex-grow">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="px-2 py-1 bg-amber-200 text-amber-800 rounded text-sm font-medium">
                                                        {sa.marks} marks available
                                                    </span>
                                                    <span className="px-2 py-1 bg-green-200 text-green-800 rounded text-sm font-medium">
                                                        {sa.marks_awarded}/{sa.marks} awarded
                                                    </span>
                                                    {sa.source_page && (
                                                        <span className="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">
                                                            {sa.source_page}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-gray-800 font-medium">{sa.question_text}</p>
                                            </div>
                                            <span className="text-amber-600 text-xl ml-4">
                                                {expandedSampleId === sa.id ? '‚ñº' : '‚ñ∂'}
                                            </span>
                                        </div>
                                    </div>

                                    {expandedSampleId === sa.id && (
                                        <div className="border-t border-amber-300">
                                            {/* Student Answer */}
                                            <div className="bg-blue-50 p-4 border-b border-amber-200">
                                                <h4 className="font-semibold text-blue-800 mb-2">üë§ Student's Answer:</h4>
                                                <p className="text-gray-700 whitespace-pre-line">{sa.student_answer}</p>
                                            </div>

                                            {/* Teacher Comments */}
                                            <div className="bg-green-50 p-4">
                                                <h4 className="font-semibold text-green-800 mb-2">üë®‚Äçüè´ Teacher's Comments:</h4>
                                                <p className="text-gray-700 whitespace-pre-line">{sa.teacher_comments}</p>
                                                <div className="mt-3 pt-3 border-t border-green-200 flex items-center justify-between">
                                                    <span className="text-sm font-medium text-green-700">
                                                        Marks Awarded: {sa.marks_awarded} out of {sa.marks}
                                                    </span>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            openRAGModal({
                                                                question: sa.question_text,
                                                                answer: sa.student_answer,
                                                                comments: sa.teacher_comments
                                                            }, 'sample_question');
                                                        }}
                                                        className="px-3 py-1.5 bg-teal-500 text-white rounded-lg text-sm hover:bg-teal-600 transition flex items-center gap-1"
                                                    >
                                                        üìö Talk to Documents
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="text-center text-sm text-gray-400 mt-6">
                        Practice these questions to prepare for your exam
                    </div>

                    {/* RAG Query Modal */}
                    <RAGQueryModal
                        isOpen={ragModalOpen}
                        onClose={() => setRagModalOpen(false)}
                        context={ragContext}
                        contextType={ragContextType}
                    />
                </div>
            );
        }

        // Study Tips Tab Component - Shows tips and common errors for this topic
        function StudyTipsTab({ topicId }) {
            const [tips, setTips] = useState([]);
            const [errors, setErrors] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeSection, setActiveSection] = useState('tips');
            // RAG Modal state
            const [ragModalOpen, setRagModalOpen] = useState(false);
            const [ragContext, setRagContext] = useState(null);
            const [ragContextType, setRagContextType] = useState('general');

            const openRAGModal = (context, type) => {
                setRagContext(context);
                setRagContextType(type);
                setRagModalOpen(true);
            };

            useEffect(() => {
                Promise.all([
                    api.get(`/tips/${topicId}`),
                    api.get(`/common-errors/${topicId}`)
                ]).then(([tipsData, errorsData]) => {
                    setTips(tipsData || []);
                    setErrors(errorsData || []);
                    setLoading(false);
                });
            }, [topicId]);

            if (loading) return <div className="text-center py-8">Loading study tips...</div>;

            const hasTips = tips.length > 0;
            const hasErrors = errors.length > 0;

            if (!hasTips && !hasErrors) {
                return (
                    <div className="text-center py-12">
                        <span className="text-6xl">üí°</span>
                        <p className="mt-4 text-gray-500">No tips or common errors available for this topic yet.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* Section Tabs */}
                    <div className="flex gap-4 border-b">
                        <button
                            onClick={() => setActiveSection('tips')}
                            className={`pb-2 px-4 font-medium transition ${
                                activeSection === 'tips'
                                    ? 'border-b-2 border-green-500 text-green-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            üí° Tips ({tips.length})
                        </button>
                        <button
                            onClick={() => setActiveSection('errors')}
                            className={`pb-2 px-4 font-medium transition ${
                                activeSection === 'errors'
                                    ? 'border-b-2 border-red-500 text-red-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            ‚ö†Ô∏è Common Errors ({errors.length})
                        </button>
                    </div>

                    {/* Tips Section */}
                    {activeSection === 'tips' && (
                        <div className="space-y-3">
                            {tips.length === 0 ? (
                                <p className="text-gray-500 text-center py-4">No tips available for this topic.</p>
                            ) : (
                                tips.map((tip, index) => (
                                    <div key={tip.id} className="flex items-start gap-3 p-4 bg-green-50 rounded-lg border border-green-200">
                                        <span className="text-2xl">üí°</span>
                                        <div className="flex-1">
                                            <div className="flex items-center justify-between mb-1">
                                                <span className="inline-block px-2 py-0.5 bg-green-200 text-green-800 rounded text-xs">
                                                    {tip.tip_type === 'exam' ? 'Exam Tip' : 'Study Tip'}
                                                </span>
                                                <button
                                                    onClick={() => openRAGModal({ text: tip.tip_text }, 'tip')}
                                                    className="px-2 py-1 bg-teal-500 text-white rounded text-xs hover:bg-teal-600 transition flex items-center gap-1"
                                                >
                                                    üìö Talk to Docs
                                                </button>
                                            </div>
                                            <p className="text-gray-700">{tip.tip_text}</p>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* Common Errors Section */}
                    {activeSection === 'errors' && (
                        <div className="space-y-3">
                            {errors.length === 0 ? (
                                <p className="text-gray-500 text-center py-4">No common errors listed for this topic.</p>
                            ) : (
                                errors.map((error, index) => (
                                    <div key={error.id} className="p-4 bg-red-50 rounded-lg border border-red-200">
                                        <div className="flex items-start gap-3">
                                            <span className="text-2xl">‚ö†Ô∏è</span>
                                            <div className="flex-1">
                                                <div className="flex items-start justify-between">
                                                    <p className="text-red-800 font-medium">{error.error_description}</p>
                                                    <button
                                                        onClick={() => openRAGModal({
                                                            error: error.error_description,
                                                            explanation: error.why_wrong
                                                        }, 'common_error')}
                                                        className="ml-2 px-2 py-1 bg-teal-500 text-white rounded text-xs hover:bg-teal-600 transition flex items-center gap-1 whitespace-nowrap"
                                                    >
                                                        üìö Talk to Docs
                                                    </button>
                                                </div>
                                                {error.why_wrong && (
                                                    <p className="text-gray-600 mt-2 text-sm">
                                                        <span className="font-medium">Why it's wrong:</span> {error.why_wrong}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* RAG Query Modal */}
                    <RAGQueryModal
                        isOpen={ragModalOpen}
                        onClose={() => setRagModalOpen(false)}
                        context={ragContext}
                        contextType={ragContextType}
                    />
                </div>
            );
        }

        // Quiz Tab Component - ENHANCED with Type to Review
        function QuizTab({ questions, topicId, typingSettings, startIndex = 0, onStartIndexUsed }) {
            const [currentIndex, setCurrentIndex] = useState(startIndex);
            const [answer, setAnswer] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [hintLevel, setHintLevel] = useState(0);
            const [hint, setHint] = useState('');
            const [stats, setStats] = useState({ correct: 0, total: 0, marks: 0, maxMarks: 0 });
            const [isTypingReview, setIsTypingReview] = useState(false);
            const [quizMode, setQuizMode] = useState('quiz'); // 'quiz' or 'type'

            // Handle startIndex from navigation
            useEffect(() => {
                if (startIndex > 0 && startIndex < questions.length) {
                    setCurrentIndex(startIndex);
                    setAnswer('');
                    setResult(null);
                    setHint('');
                    setHintLevel(0);
                    setIsTypingReview(false);
                    if (onStartIndexUsed) onStartIndexUsed();
                }
            }, [startIndex, questions.length, onStartIndexUsed]);

            const current = questions[currentIndex];

            const submitAnswer = async () => {
                setLoading(true);
                const res = await api.post(`/questions/${current.id}/submit`, {
                    answer,
                    use_ai_marking: true
                });
                setResult(res);
                setStats(prev => ({
                    correct: res?.is_correct ? prev.correct + 1 : prev.correct,
                    total: prev.total + 1,
                    marks: prev.marks + (res?.marks_awarded || 0),
                    maxMarks: prev.maxMarks + (res?.marks_possible || current.marks)
                }));
                setLoading(false);
            };

            const getHint = async () => {
                const newLevel = Math.min(hintLevel + 1, 3);
                setHintLevel(newLevel);
                const res = await api.post('/ai/hint', {
                    question_id: current.id,
                    hint_level: newLevel
                });
                setHint(res?.hint || 'Think about the key terms for this topic.');
            };

            const nextQuestion = () => {
                setCurrentIndex(currentIndex + 1);
                setAnswer('');
                setResult(null);
                setHint('');
                setHintLevel(0);
                setIsTypingReview(false);
            };

            const previousQuestion = () => {
                if (currentIndex > 0) {
                    setCurrentIndex(currentIndex - 1);
                    setAnswer('');
                    setResult(null);
                    setHint('');
                    setHintLevel(0);
                    setIsTypingReview(false);
                }
            };

            const generateSimilar = async () => {
                setLoading(true);
                const res = await api.post('/ai/generate-questions', {
                    question_id: current.id,
                    num_questions: 3
                });
                if (res?.questions?.length) {
                    alert(`Generated ${res.questions.length} new questions! They'll appear in your next quiz.`);
                } else if (res?.error) {
                    alert(res.error);
                }
                setLoading(false);
            };

            const handleTypingComplete = () => {
                setIsTypingReview(false);
                // Show celebration
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { y: 0.7 },
                    colors: ['#22c55e', '#3b82f6', '#f59e0b']
                });
            };

            if (!questions.length) {
                return <div className="text-center py-8 text-gray-500">No questions available for this topic.</div>;
            }

            // Type Mode - shows question and model answer for typing practice
            if (quizMode === 'type') {
                return (
                    <div className="max-w-2xl mx-auto">
                        {/* Mode Toggle */}
                        <div className="flex justify-center gap-2 mb-6">
                            <button
                                onClick={() => setQuizMode('quiz')}
                                className="px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-600 hover:bg-gray-200"
                            >
                                Quiz Mode
                            </button>
                            <button
                                onClick={() => setQuizMode('type')}
                                className="px-4 py-2 rounded-lg font-medium transition bg-green-500 text-white"
                            >
                                Type Mode
                            </button>
                        </div>

                        {/* Navigation */}
                        <div className="flex items-center justify-center gap-4 mb-4">
                            <button
                                onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))}
                                disabled={currentIndex === 0}
                                className="px-3 py-1 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                            >
                                ‚Üê Prev
                            </button>
                            <span className="text-gray-500">
                                Question {currentIndex + 1} of {questions.length}
                            </span>
                            <button
                                onClick={() => setCurrentIndex(Math.min(questions.length - 1, currentIndex + 1))}
                                disabled={currentIndex >= questions.length - 1}
                                className="px-3 py-1 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                            >
                                Next ‚Üí
                            </button>
                        </div>

                        <div className="flex justify-end mb-4">
                            <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                                {current.assessment_objective || 'AO1'} ‚Ä¢ {current.marks} mark{current.marks > 1 ? 's' : ''}
                            </span>
                        </div>

                        {/* Question */}
                        <div className="bg-gray-50 p-6 rounded-lg mb-6">
                            <h3 className="text-lg font-medium text-gray-800">{current.question_text}</h3>
                        </div>

                        {/* Model Answer for Typing */}
                        <div className="bg-blue-50 p-4 rounded-lg mb-4">
                            <div className="text-sm text-blue-600 font-medium mb-2">Model Answer to Practice:</div>
                            <div className="text-gray-800">{current.mark_scheme || current.model_answer || 'No model answer available.'}</div>
                        </div>

                        {/* Typing Practice */}
                        {typingSettings?.enabled ? (
                            <TypingPractice
                                text={current.mark_scheme || current.model_answer || 'No model answer available'}
                                onComplete={() => {
                                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                                    if (currentIndex < questions.length - 1) {
                                        setTimeout(() => setCurrentIndex(currentIndex + 1), 500);
                                    }
                                }}
                                settings={typingSettings}
                                label="Model Answer"
                            />
                        ) : (
                            <div className="bg-yellow-50 p-4 rounded-lg text-yellow-700">
                                Enable Typing Practice in Settings to practice typing answers.
                            </div>
                        )}
                    </div>
                );
            }

            if (currentIndex >= questions.length) {
                const percentage = stats.maxMarks > 0 ? Math.round(stats.marks / stats.maxMarks * 100) : 0;
                return (
                    <div className="text-center py-8">
                        <div className="text-6xl mb-4">{percentage >= 70 ? 'üåü' : percentage >= 50 ? 'üëç' : 'üìö'}</div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Quiz Complete!</h3>
                        <p className="text-xl text-gray-600 mb-2">
                            Score: {stats.marks}/{stats.maxMarks} marks ({percentage}%)
                        </p>
                        <p className="text-gray-500 mb-6">
                            {stats.correct} of {stats.total} questions correct
                        </p>
                        <button
                            onClick={() => { setCurrentIndex(0); setStats({ correct: 0, total: 0, marks: 0, maxMarks: 0 }); }}
                            className="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600"
                        >
                            Try Again
                        </button>
                    </div>
                );
            }

            return (
                <div className="max-w-2xl mx-auto">
                    {/* Mode Toggle */}
                    <div className="flex justify-center gap-2 mb-6">
                        <button
                            onClick={() => setQuizMode('quiz')}
                            className="px-4 py-2 rounded-lg font-medium transition bg-green-500 text-white"
                        >
                            Quiz Mode
                        </button>
                        <button
                            onClick={() => setQuizMode('type')}
                            className="px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-600 hover:bg-gray-200"
                        >
                            Type Mode
                        </button>
                    </div>

                    {/* Navigation Controls */}
                    <div className="flex items-center justify-center gap-4 mb-4">
                        <button
                            onClick={previousQuestion}
                            disabled={currentIndex === 0}
                            className="px-3 py-1 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                        >
                            ‚Üê Prev
                        </button>
                        <span className="text-gray-500">
                            Question {currentIndex + 1} of {questions.length}
                        </span>
                        <button
                            onClick={nextQuestion}
                            disabled={currentIndex >= questions.length - 1 || !result}
                            className="px-3 py-1 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300 disabled:opacity-40 disabled:cursor-not-allowed transition"
                        >
                            Next ‚Üí
                        </button>
                    </div>

                    <div className="flex justify-end mb-4">
                        <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                            {current.assessment_objective || 'AO1'} ‚Ä¢ {current.marks} mark{current.marks > 1 ? 's' : ''}
                        </span>
                    </div>

                    <div className="bg-gray-50 p-6 rounded-lg mb-6">
                        <h3 className="text-lg font-medium text-gray-800">{current.question_text}</h3>
                    </div>

                    {!result ? (
                        <>
                            <textarea
                                value={answer}
                                onChange={(e) => setAnswer(e.target.value)}
                                placeholder="Type your answer here..."
                                className="w-full p-4 border rounded-lg mb-4 h-32 focus:ring-2 focus:ring-green-500 focus:outline-none"
                            />

                            {hint && (
                                <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                                    <span className="text-yellow-700">üí° Hint: {hint}</span>
                                </div>
                            )}

                            <div className="flex justify-between">
                                <button
                                    onClick={getHint}
                                    disabled={hintLevel >= 3}
                                    className="text-yellow-600 hover:text-yellow-800 disabled:opacity-50"
                                >
                                    {hintLevel === 0 ? 'üí° Get Hint' : `üí° More Hints (${3 - hintLevel} left)`}
                                </button>

                                <button
                                    onClick={submitAnswer}
                                    disabled={loading || !answer.trim()}
                                    className="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600 disabled:opacity-50"
                                >
                                    {loading ? 'Checking...' : 'Submit Answer'}
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="space-y-4">
                            <div className={`p-4 rounded-lg ${result.is_correct ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                                <div className="flex items-center mb-2">
                                    <span className="text-2xl mr-2">{result.is_correct ? '‚úÖ' : '‚ùå'}</span>
                                    <span className="font-bold text-lg">
                                        {result.marks_awarded}/{result.marks_possible} marks
                                    </span>
                                </div>
                                <p className="text-gray-700">{result.feedback}</p>
                            </div>

                            {result.correct_points?.length > 0 && (
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h4 className="font-semibold text-green-700 mb-2">‚úì Correct Points:</h4>
                                    <ul className="list-disc list-inside text-green-600">
                                        {result.correct_points.map((p, i) => <li key={i}>{p}</li>)}
                                    </ul>
                                </div>
                            )}

                            {result.missing_points?.length > 0 && (
                                <div className="bg-red-50 p-4 rounded-lg">
                                    <h4 className="font-semibold text-red-700 mb-2">‚úó Missing Points:</h4>
                                    <ul className="list-disc list-inside text-red-600">
                                        {result.missing_points.map((p, i) => <li key={i}>{p}</li>)}
                                    </ul>
                                </div>
                            )}

                            {/* Model Answer with Type to Memorize */}
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className="font-semibold text-blue-700">üìù Model Answer:</h4>
                                    {!isTypingReview && (
                                        <button
                                            onClick={() => setIsTypingReview(true)}
                                            className="text-sm bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition flex items-center gap-1"
                                        >
                                            ‚å®Ô∏è Type to Memorize
                                        </button>
                                    )}
                                </div>

                                {isTypingReview ? (
                                    <TypingPractice
                                        text={result.model_answer}
                                        onComplete={handleTypingComplete}
                                        onCancel={() => setIsTypingReview(false)}
                                        settings={typingSettings}
                                        label="Model Answer"
                                    />
                                ) : (
                                    <p className="text-gray-700">{result.model_answer}</p>
                                )}
                            </div>

                            {result.teacher_comment && (
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <h4 className="font-semibold text-purple-700 mb-2">üë©‚Äçüè´ Teacher Comment:</h4>
                                    <p className="text-gray-700">{result.teacher_comment}</p>
                                </div>
                            )}

                            <div className="flex justify-between pt-4">
                                <button
                                    onClick={generateSimilar}
                                    disabled={loading}
                                    className="text-blue-600 hover:text-blue-800 disabled:opacity-50"
                                >
                                    üîÑ Generate Similar Questions
                                </button>

                                <button
                                    onClick={nextQuestion}
                                    className="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600"
                                >
                                    Next Question ‚Üí
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Progress View Component
        function ProgressView() {
            const [progress, setProgress] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/progress').then(data => {
                    setProgress(data);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading progress...</div>;

            const overall = progress?.overall || {};

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">üìä Your Progress</h2>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <div className="text-4xl mb-2">üìù</div>
                            <div className="text-3xl font-bold text-gray-800">{overall.questions_attempted || 0}</div>
                            <div className="text-gray-500">Questions Attempted</div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <div className="text-4xl mb-2">‚úÖ</div>
                            <div className="text-3xl font-bold text-green-600">{overall.questions_correct || 0}</div>
                            <div className="text-gray-500">Correct Answers</div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <div className="text-4xl mb-2">üéØ</div>
                            <div className="text-3xl font-bold text-blue-600">{overall.accuracy || 0}%</div>
                            <div className="text-gray-500">Accuracy Rate</div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <div className="text-4xl mb-2">üÉè</div>
                            <div className="text-3xl font-bold text-purple-600">{overall.definitions_studied || 0}</div>
                            <div className="text-gray-500">Definitions Studied</div>
                        </div>
                    </div>

                    {progress?.weak_points_count > 0 && (
                        <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
                            <span className="text-yellow-700">
                                ‚ö†Ô∏è You have {progress.weak_points_count} weak point{progress.weak_points_count > 1 ? 's' : ''} to work on.
                                Check the Weak Points section!
                            </span>
                        </div>
                    )}

                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <h3 className="text-xl font-bold text-gray-800 p-6 border-b">Progress by Topic</h3>

                        <div className="divide-y">
                            {progress?.by_topic?.map((item, i) => (
                                <div key={i} className="p-4 flex items-center justify-between">
                                    <div>
                                        <span className="font-semibold text-green-600">{item.topic_number}</span>
                                        <span className="ml-2 text-gray-700">{item.topic_name}</span>
                                    </div>
                                    <div className="flex items-center space-x-6">
                                        <div className="text-sm text-gray-500">
                                            {item.questions_correct}/{item.questions_attempted} correct
                                        </div>
                                        <div className="w-32 bg-gray-200 rounded-full h-2">
                                            <div
                                                className="bg-green-500 h-2 rounded-full"
                                                style={{ width: `${item.questions_attempted > 0 ? (item.questions_correct / item.questions_attempted * 100) : 0}%` }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            ))}

                            {(!progress?.by_topic || progress.by_topic.length === 0) && (
                                <div className="p-8 text-center text-gray-500">
                                    No progress yet. Start studying to track your learning!
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Weak Points View Component
        function WeakPointsView() {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/weak-points').then(result => {
                    setData(result);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading weak points...</div>;

            const weakPoints = data?.weak_points || [];

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">üéØ Weak Points</h2>

                    {data?.analysis && (
                        <div className="bg-blue-50 border border-blue-200 p-6 rounded-xl mb-6">
                            <h3 className="font-bold text-blue-700 mb-2">ü§ñ AI Analysis</h3>
                            <p className="text-gray-700 whitespace-pre-line">{data.analysis}</p>
                        </div>
                    )}

                    {weakPoints.length === 0 ? (
                        <div className="bg-green-50 p-8 rounded-xl text-center">
                            <div className="text-6xl mb-4">üåü</div>
                            <h3 className="text-xl font-bold text-gray-800">No weak points!</h3>
                            <p className="text-gray-600">Keep up the great work!</p>
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {weakPoints.map((wp, i) => (
                                <div key={i} className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-red-500">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="bg-red-100 text-red-700 px-2 py-1 rounded text-sm">
                                            {wp.failure_count}x incorrect
                                        </span>
                                        <span className="text-gray-500 text-sm">{wp.topic}</span>
                                    </div>

                                    {wp.type === 'definition' && (
                                        <div>
                                            <p className="font-semibold text-gray-800">{wp.term}</p>
                                            <p className="text-gray-600">{wp.definition}</p>
                                        </div>
                                    )}

                                    {wp.type === 'question' && (
                                        <div>
                                            <p className="font-semibold text-gray-800">{wp.question}</p>
                                            <details className="mt-2">
                                                <summary className="text-green-600 cursor-pointer">Show model answer</summary>
                                                <p className="text-gray-600 mt-2">{wp.model_answer}</p>
                                            </details>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Settings View Component - ENHANCED with Typing Settings
        function SettingsView({ typingSettings, onTypingSettingsChange }) {
            const [settings, setSettings] = useState(null);
            const [models, setModels] = useState({});
            const [loading, setLoading] = useState(true);
            const [validating, setValidating] = useState({});
            const [saveStatus, setSaveStatus] = useState({});
            const [activeSection, setActiveSection] = useState('ai'); // 'ai' or 'typing'

            const [formData, setFormData] = useState({
                default_provider: 'claude',
                claude_model: 'claude-haiku-4-5-20251001',
                claude_api_key: '',
                claude_validated: false,
                gemini_model: 'gemini-2.0-flash',
                gemini_api_key: '',
                gemini_validated: false,
                openai_model: 'gpt-4o-mini',
                openai_api_key: '',
                openai_validated: false
            });

            useEffect(() => {
                api.get('/ai/settings').then(data => {
                    if (data?.settings) {
                        setSettings(data.settings);
                        setFormData({
                            default_provider: data.settings.default_provider || 'claude',
                            claude_model: data.settings.claude_model || 'claude-haiku-4-5-20251001',
                            claude_api_key: data.settings.claude_api_key || '',
                            claude_validated: data.settings.claude_validated || false,
                            gemini_model: data.settings.gemini_model || 'gemini-2.0-flash',
                            gemini_api_key: data.settings.gemini_api_key || '',
                            gemini_validated: data.settings.gemini_validated || false,
                            openai_model: data.settings.openai_model || 'gpt-4o-mini',
                            openai_api_key: data.settings.openai_api_key || '',
                            openai_validated: data.settings.openai_validated || false
                        });
                    }
                    if (data?.models) setModels(data.models);
                    setLoading(false);
                });
            }, []);

            const autoSave = async (field, value) => {
                setSaveStatus(prev => ({ ...prev, [field]: 'saving' }));
                await api.put('/ai/settings', { [field]: value });
                setSaveStatus(prev => ({ ...prev, [field]: 'saved' }));
                setTimeout(() => setSaveStatus(prev => ({ ...prev, [field]: null })), 2000);
            };

            const handleModelChange = async (provider, modelId) => {
                setFormData(prev => ({ ...prev, [`${provider}_model`]: modelId }));
                await autoSave(`${provider}_model`, modelId);
            };

            const handleSetDefault = async (provider) => {
                setFormData(prev => ({ ...prev, default_provider: provider }));
                await autoSave('default_provider', provider);
            };

            const handleValidate = async (provider) => {
                setValidating(prev => ({ ...prev, [provider]: true }));

                const keyField = `${provider}_api_key`;
                const apiKey = formData[keyField];

                if (!apiKey || apiKey.startsWith('‚Ä¢')) {
                    alert('Please enter an API key first');
                    setValidating(prev => ({ ...prev, [provider]: false }));
                    return;
                }

                const result = await api.post('/ai/validate-key', { provider, api_key: apiKey });

                if (result?.valid) {
                    setFormData(prev => ({
                        ...prev,
                        [`${provider}_validated`]: true,
                        [`${provider}_api_key`]: '‚Ä¢'.repeat(20) + apiKey.slice(-4)
                    }));
                    if (result.models) {
                        console.log(`[AI Settings] ${provider} models received:`, result.models.length, 'models');
                        console.log(`[AI Settings] ${provider} model list:`, result.models.map(m => m.id).join(', '));
                        setModels(prev => ({ ...prev, [provider]: result.models }));
                    }
                    alert(`‚úÖ ${provider.charAt(0).toUpperCase() + provider.slice(1)} API key validated and saved!`);
                } else {
                    alert(`‚ùå Invalid API key: ${result?.error || 'Unknown error'}`);
                }

                setValidating(prev => ({ ...prev, [provider]: false }));
            };

            const handleKeyChange = (provider, value) => {
                setFormData(prev => ({
                    ...prev,
                    [`${provider}_api_key`]: value,
                    [`${provider}_validated`]: value.startsWith('‚Ä¢') ? prev[`${provider}_validated`] : false
                }));
            };

            const [reloading, setReloading] = useState({});

            const handleReloadModels = async (provider) => {
                setReloading(prev => ({ ...prev, [provider]: true }));
                try {
                    // Call the dynamic models endpoint
                    const data = await api.get(`/ai/models/${provider}`);
                    console.log(`[AI Settings] Reload ${provider} models response:`, data);
                    if (data?.models?.length > 0) {
                        console.log(`[AI Settings] Reload ${provider} - ${data.models.length} models:`, data.models.map(m => m.id).join(', '));
                        setModels(prev => ({ ...prev, [provider]: data.models }));
                    } else {
                        console.log(`[AI Settings] Reload ${provider} - no models returned, keeping current list`);
                    }
                } catch (err) {
                    console.error('[AI Settings] Failed to reload models:', err);
                }
                setReloading(prev => ({ ...prev, [provider]: false }));
            };

            if (loading) return <div className="text-center py-8">Loading settings...</div>;

            const providers = [
                { id: 'claude', name: 'Claude', company: 'Anthropic', icon: 'üîÆ', color: 'purple', url: 'https://console.anthropic.com' },
                { id: 'gemini', name: 'Gemini', company: 'Google', icon: 'üíé', color: 'blue', url: 'https://aistudio.google.com/apikey' },
                { id: 'openai', name: 'OpenAI', company: 'OpenAI', icon: 'ü§ñ', color: 'green', url: 'https://platform.openai.com/api-keys' }
            ];

            return (
                <div className="max-w-5xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6">‚öôÔ∏è Settings</h2>

                    {/* Section Tabs */}
                    <div className="flex gap-2 mb-6">
                        <button
                            onClick={() => setActiveSection('ai')}
                            className={`px-4 py-2 rounded-lg font-medium transition ${
                                activeSection === 'ai'
                                    ? 'bg-green-500 text-white'
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                        >
                            ü§ñ AI Providers
                        </button>
                        <button
                            onClick={() => setActiveSection('typing')}
                            className={`px-4 py-2 rounded-lg font-medium transition ${
                                activeSection === 'typing'
                                    ? 'bg-green-500 text-white'
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                        >
                            ‚å®Ô∏è Typing Practice
                        </button>
                    </div>

                    {activeSection === 'ai' ? (
                        <div className="grid gap-6">
                            {providers.map(provider => {
                                const isDefault = formData.default_provider === provider.id;
                                const isValidated = formData[`${provider.id}_validated`];
                                const currentModel = formData[`${provider.id}_model`];
                                const providerModels = models[provider.id] || [];

                                return (
                                    <div key={provider.id} className={`bg-white rounded-xl shadow-lg p-6 border-2 ${isDefault ? 'border-green-500' : 'border-transparent'}`}>
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center space-x-3">
                                                <span className="text-3xl">{provider.icon}</span>
                                                <div>
                                                    <h3 className="text-xl font-bold text-gray-800">{provider.name}</h3>
                                                    <span className="text-sm text-gray-500">{provider.company}</span>
                                                </div>
                                                {isValidated && <span className="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">‚úì Connected</span>}
                                            </div>
                                            <button
                                                onClick={() => handleSetDefault(provider.id)}
                                                className={`px-4 py-2 rounded-lg font-medium transition ${
                                                    isDefault
                                                        ? 'bg-green-500 text-white'
                                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                }`}
                                            >
                                                {isDefault ? '‚òÖ Default' : 'Set as Default'}
                                            </button>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-gray-700 font-medium mb-2">API Key</label>
                                                <div className="flex space-x-2">
                                                    <input
                                                        type="password"
                                                        value={formData[`${provider.id}_api_key`]}
                                                        onChange={(e) => handleKeyChange(provider.id, e.target.value)}
                                                        placeholder={`Enter ${provider.name} API key`}
                                                        className="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                    <button
                                                        onClick={() => handleValidate(provider.id)}
                                                        disabled={validating[provider.id]}
                                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                                            isValidated
                                                                ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                                                : 'bg-blue-500 text-white hover:bg-blue-600'
                                                        } disabled:opacity-50`}
                                                    >
                                                        {validating[provider.id] ? '...' : isValidated ? 'Re-validate' : 'Validate'}
                                                    </button>
                                                </div>
                                                <a href={provider.url} target="_blank" rel="noopener" className="text-xs text-blue-600 hover:underline mt-1 inline-block">
                                                    Get API key ‚Üí
                                                </a>
                                            </div>

                                            <div>
                                                <label className="block text-gray-700 font-medium mb-2">
                                                    Model
                                                    {saveStatus[`${provider.id}_model`] === 'saving' && <span className="ml-2 text-gray-400 text-sm">Saving...</span>}
                                                    {saveStatus[`${provider.id}_model`] === 'saved' && <span className="ml-2 text-green-500 text-sm">‚úì Saved</span>}
                                                </label>
                                                <div className="flex space-x-2">
                                                    <select
                                                        value={currentModel}
                                                        onChange={(e) => handleModelChange(provider.id, e.target.value)}
                                                        disabled={!isValidated && providerModels.length === 0}
                                                        className={`flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none ${
                                                            !isValidated && providerModels.length === 0 ? 'bg-gray-100 text-gray-400' : ''
                                                        }`}
                                                    >
                                                        {providerModels.length > 0 ? (
                                                            providerModels.map(model => (
                                                                <option key={model.id} value={model.id}>
                                                                    {model.name} {model.description ? `- ${model.description}` : ''}
                                                                </option>
                                                            ))
                                                        ) : (
                                                            <option value={currentModel}>Validate API key to see models</option>
                                                        )}
                                                    </select>
                                                    <button
                                                        onClick={() => handleReloadModels(provider.id)}
                                                        disabled={reloading[provider.id]}
                                                        title="Reload model list"
                                                        className="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg transition disabled:opacity-50"
                                                    >
                                                        {reloading[provider.id] ? '...' : '‚Üª'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}

                            <div className="p-4 bg-blue-50 rounded-lg">
                                <h4 className="font-semibold text-blue-800 mb-2">üí° Tips:</h4>
                                <ul className="text-sm text-blue-700 space-y-1">
                                    <li>‚Ä¢ The <b>default provider</b> will be used for AI marking and question generation</li>
                                    <li>‚Ä¢ <b>Claude Haiku</b> is recommended for fast, cost-effective responses</li>
                                    <li>‚Ä¢ <b>Gemini Flash</b> is a good free alternative</li>
                                    <li>‚Ä¢ Settings are auto-saved when you change the model or default provider</li>
                                </ul>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                                ‚å®Ô∏è Typing Practice Settings
                            </h3>

                            <div className="space-y-6">
                                {/* Enable/Disable */}
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div className="font-medium text-gray-800">Enable Typing Mode</div>
                                        <div className="text-sm text-gray-500">Practice definitions and answers by typing them</div>
                                    </div>
                                    <button
                                        onClick={() => onTypingSettingsChange({ ...typingSettings, enabled: !typingSettings.enabled })}
                                        className={`w-14 h-8 rounded-full transition-colors relative ${
                                            typingSettings.enabled ? 'bg-green-500' : 'bg-gray-300'
                                        }`}
                                    >
                                        <div className={`absolute w-6 h-6 bg-white rounded-full top-1 transition-transform ${
                                            typingSettings.enabled ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>

                                {/* Memory Duration */}
                                <div className="p-4 bg-gray-50 rounded-lg">
                                    <div className="flex items-center justify-between mb-3">
                                        <div>
                                            <div className="font-medium text-gray-800">Memory Timer</div>
                                            <div className="text-sm text-gray-500">How long to show text before hiding it</div>
                                        </div>
                                        <span className="text-lg font-mono font-bold text-green-600">{typingSettings.memoryDuration}s</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="3"
                                        max="30"
                                        step="1"
                                        value={typingSettings.memoryDuration}
                                        onChange={(e) => onTypingSettingsChange({ ...typingSettings, memoryDuration: parseInt(e.target.value) })}
                                        className="w-full accent-green-500"
                                    />
                                    <div className="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>3s (Hard)</span>
                                        <span>30s (Easy)</span>
                                    </div>
                                </div>

                                {/* Stuck Timeout */}
                                <div className="p-4 bg-gray-50 rounded-lg">
                                    <div className="flex items-center justify-between mb-3">
                                        <div>
                                            <div className="font-medium text-gray-800">Hint Delay</div>
                                            <div className="text-sm text-gray-500">How long before showing a hint when stuck</div>
                                        </div>
                                        <span className="text-lg font-mono font-bold text-yellow-600">{typingSettings.stuckTimeout}s</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="1"
                                        max="10"
                                        step="1"
                                        value={typingSettings.stuckTimeout}
                                        onChange={(e) => onTypingSettingsChange({ ...typingSettings, stuckTimeout: parseInt(e.target.value) })}
                                        className="w-full accent-yellow-500"
                                    />
                                    <div className="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>1s (Quick hints)</span>
                                        <span>10s (Challenge mode)</span>
                                    </div>
                                </div>

                                {/* Sound Effects */}
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div className="font-medium text-gray-800">üîä Sound Effects</div>
                                        <div className="text-sm text-gray-500">Key clicks, dings, and celebration sounds</div>
                                    </div>
                                    <button
                                        onClick={() => onTypingSettingsChange({ ...typingSettings, soundEnabled: !typingSettings.soundEnabled })}
                                        className={`w-14 h-8 rounded-full transition-colors relative ${
                                            typingSettings.soundEnabled ? 'bg-green-500' : 'bg-gray-300'
                                        }`}
                                    >
                                        <div className={`absolute w-6 h-6 bg-white rounded-full top-1 transition-transform ${
                                            typingSettings.soundEnabled ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>

                                {/* TTS */}
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div className="font-medium text-gray-800">üó£Ô∏è Text-to-Speech</div>
                                        <div className="text-sm text-gray-500">Read definitions aloud before typing</div>
                                    </div>
                                    <button
                                        onClick={() => onTypingSettingsChange({ ...typingSettings, ttsEnabled: !typingSettings.ttsEnabled })}
                                        className={`w-14 h-8 rounded-full transition-colors relative ${
                                            typingSettings.ttsEnabled ? 'bg-green-500' : 'bg-gray-300'
                                        }`}
                                    >
                                        <div className={`absolute w-6 h-6 bg-white rounded-full top-1 transition-transform ${
                                            typingSettings.ttsEnabled ? 'translate-x-7' : 'translate-x-1'
                                        }`} />
                                    </button>
                                </div>
                            </div>

                            <div className="mt-6 p-4 bg-green-50 rounded-lg">
                                <h4 className="font-semibold text-green-800 mb-2">üí° How Typing Practice Works:</h4>
                                <ul className="text-sm text-green-700 space-y-1">
                                    <li>1. <b>Show</b> - Read and memorize the definition</li>
                                    <li>2. <b>Dim</b> - Text fades after the timer (or first keystroke)</li>
                                    <li>3. <b>Type</b> - Reproduce from memory</li>
                                    <li>4. <b>Hint</b> - If stuck, the next word appears</li>
                                    <li>5. <b>Celebrate</b> - Confetti when you nail it! üéâ</li>
                                </ul>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================
        // NEW FEATURE COMPONENTS
        // ============================================

        // Exam Practice View - Practice with real exam questions
        function ExamPracticeView() {
            const [questions, setQuestions] = useState([]);
            const [topics, setTopics] = useState([]);
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api.get('/topics').then(data => {
                    const allTopics = [];
                    (data || []).forEach(theme => {
                        theme.topics.forEach(t => allTopics.push({...t, theme_name: theme.theme_name}));
                    });
                    setTopics(allTopics);
                    setLoading(false);
                });
            }, []);

            const loadQuestions = async (topicId) => {
                setLoading(true);
                const data = await api.get(`/exam-questions/${topicId}`);
                setQuestions(data || []);
                setCurrentQuestion(0);
                setShowAnswer(false);
                setSelectedTopic(topicId);
                setLoading(false);
            };

            if (loading) return <div className="text-center py-8">Loading...</div>;

            if (!selectedTopic) {
                return (
                    <div className="max-w-6xl mx-auto p-6">
                        <h2 className="text-3xl font-bold text-gray-800 mb-2">üìù Exam Practice</h2>
                        <p className="text-gray-600 mb-6">Practice with real IGCSE exam-style questions and model answers</p>

                        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            {topics.map(topic => (
                                <button
                                    key={topic.id}
                                    onClick={() => loadQuestions(topic.id)}
                                    className="p-4 bg-white rounded-lg shadow hover:shadow-lg transition border-l-4 border-blue-500 text-left"
                                >
                                    <span className="font-bold text-blue-600">{topic.topic_number}</span>
                                    <span className="text-gray-700 ml-2">{topic.topic_name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            if (questions.length === 0) {
                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <button onClick={() => setSelectedTopic(null)} className="mb-4 text-blue-600 hover:text-blue-800">
                            ‚Üê Back to topics
                        </button>
                        <div className="text-center py-12 bg-white rounded-lg">
                            <p className="text-gray-500">No exam questions available for this topic yet.</p>
                        </div>
                    </div>
                );
            }

            const q = questions[currentQuestion];

            return (
                <div className="max-w-4xl mx-auto p-6">
                    <button onClick={() => setSelectedTopic(null)} className="mb-4 text-blue-600 hover:text-blue-800">
                        ‚Üê Back to topics
                    </button>

                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-blue-500 to-indigo-500 p-4 flex justify-between items-center">
                            <h3 className="text-white font-bold">Question {currentQuestion + 1} of {questions.length}</h3>
                            <span className="bg-white/20 text-white px-3 py-1 rounded-full text-sm">
                                [{q.marks} marks]
                            </span>
                        </div>

                        <div className="p-6">
                            <p className="text-lg text-gray-800 mb-6">{q.question}</p>

                            {q.command_word && (
                                <div className="mb-4 inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm">
                                    Command word: <strong>{q.command_word}</strong>
                                </div>
                            )}

                            {!showAnswer ? (
                                <button
                                    onClick={() => setShowAnswer(true)}
                                    className="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                                >
                                    Show Model Answer
                                </button>
                            ) : (
                                <div className="mt-4">
                                    <h4 className="font-bold text-green-700 mb-2">‚úì Model Answer:</h4>
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <p className="text-gray-800 whitespace-pre-line">{q.model_answer}</p>
                                    </div>
                                </div>
                            )}

                            <div className="flex justify-between mt-6">
                                <button
                                    onClick={() => { setCurrentQuestion(Math.max(0, currentQuestion - 1)); setShowAnswer(false); }}
                                    disabled={currentQuestion === 0}
                                    className="px-4 py-2 bg-gray-200 rounded disabled:opacity-50"
                                >
                                    ‚Üê Previous
                                </button>
                                <button
                                    onClick={() => { setCurrentQuestion(Math.min(questions.length - 1, currentQuestion + 1)); setShowAnswer(false); }}
                                    disabled={currentQuestion === questions.length - 1}
                                    className="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
                                >
                                    Next ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Case Studies View - Browse all case studies
        function CaseStudiesView() {
            const [caseStudies, setCaseStudies] = useState([]);
            const [topics, setTopics] = useState({});
            const [selectedCase, setSelectedCase] = useState(null);
            const [filter, setFilter] = useState('all');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api.get('/case-studies'),
                    api.get('/topics')
                ]).then(([cases, topicsData]) => {
                    setCaseStudies(cases || []);
                    const topicMap = {};
                    (topicsData || []).forEach(theme => {
                        theme.topics.forEach(t => topicMap[t.id] = t);
                    });
                    setTopics(topicMap);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading case studies...</div>;

            const categories = [...new Set(caseStudies.map(c => c.category).filter(Boolean))];
            const filtered = filter === 'all' ? caseStudies : caseStudies.filter(c => c.category === filter);

            if (selectedCase) {
                const c = selectedCase;
                const keyFacts = c.key_facts ? (typeof c.key_facts === 'string' ? JSON.parse(c.key_facts) : c.key_facts) : [];

                return (
                    <div className="max-w-4xl mx-auto p-6">
                        <button onClick={() => setSelectedCase(null)} className="mb-4 text-green-600 hover:text-green-800">
                            ‚Üê Back to case studies
                        </button>

                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="bg-gradient-to-r from-green-500 to-teal-500 p-6">
                                <h2 className="text-2xl font-bold text-white">{c.name}</h2>
                                <p className="text-white/80 mt-1">üìç {c.location}</p>
                            </div>

                            <div className="p-6 space-y-6">
                                {c.overview && (
                                    <div>
                                        <h3 className="font-bold text-gray-800 mb-2">üìã Overview</h3>
                                        <p className="text-gray-700">{c.overview}</p>
                                    </div>
                                )}

                                {c.causes && (
                                    <div>
                                        <h3 className="font-bold text-red-600 mb-2">‚ö†Ô∏è Causes</h3>
                                        <p className="text-gray-700 bg-red-50 p-3 rounded">{c.causes}</p>
                                    </div>
                                )}

                                {c.effects && (
                                    <div>
                                        <h3 className="font-bold text-orange-600 mb-2">üí• Effects</h3>
                                        <p className="text-gray-700 bg-orange-50 p-3 rounded">{c.effects}</p>
                                    </div>
                                )}

                                {c.solutions && (
                                    <div>
                                        <h3 className="font-bold text-green-600 mb-2">‚úÖ Solutions/Responses</h3>
                                        <p className="text-gray-700 bg-green-50 p-3 rounded">{c.solutions}</p>
                                    </div>
                                )}

                                {keyFacts.length > 0 && (
                                    <div>
                                        <h3 className="font-bold text-blue-600 mb-2">üìä Key Facts (Exam Ready)</h3>
                                        <ul className="bg-blue-50 p-4 rounded space-y-2">
                                            {keyFacts.map((fact, i) => (
                                                <li key={i} className="flex items-start">
                                                    <span className="text-blue-500 mr-2">‚Ä¢</span>
                                                    <span className="text-gray-800">{fact}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {c.exam_relevance && (
                                    <div className="bg-purple-50 border border-purple-200 p-4 rounded">
                                        <h3 className="font-bold text-purple-700 mb-1">üéØ Exam Relevance</h3>
                                        <p className="text-gray-700">{c.exam_relevance}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">üåç Case Studies</h2>
                    <p className="text-gray-600 mb-6">Essential case studies for your IGCSE Geography exam</p>

                    <div className="mb-6 flex flex-wrap gap-2">
                        <button
                            onClick={() => setFilter('all')}
                            className={`px-4 py-2 rounded-full transition ${filter === 'all' ? 'bg-green-500 text-white' : 'bg-gray-200'}`}
                        >
                            All ({caseStudies.length})
                        </button>
                        {categories.map(cat => (
                            <button
                                key={cat}
                                onClick={() => setFilter(cat)}
                                className={`px-4 py-2 rounded-full transition capitalize ${filter === cat ? 'bg-green-500 text-white' : 'bg-gray-200'}`}
                            >
                                {cat}
                            </button>
                        ))}
                    </div>

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {filtered.map(c => (
                            <button
                                key={c.id}
                                onClick={() => setSelectedCase(c)}
                                className="bg-white p-4 rounded-lg shadow hover:shadow-lg transition text-left border-l-4 border-green-500"
                            >
                                <h3 className="font-bold text-gray-800">{c.name}</h3>
                                <p className="text-sm text-gray-500">üìç {c.location}</p>
                                {c.category && (
                                    <span className="inline-block mt-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded capitalize">
                                        {c.category}
                                    </span>
                                )}
                                {topics[c.topic_id] && (
                                    <p className="text-xs text-gray-400 mt-1">
                                        Topic {topics[c.topic_id].topic_number}
                                    </p>
                                )}
                            </button>
                        ))}
                    </div>

                    {filtered.length === 0 && (
                        <div className="text-center py-12 text-gray-500">
                            No case studies found for this category.
                        </div>
                    )}
                </div>
            );
        }

        // Study Guide View - Tips and Common Errors
        function StudyGuideView() {
            const [tips, setTips] = useState([]);
            const [errors, setErrors] = useState([]);
            const [topics, setTopics] = useState({});
            const [activeTab, setActiveTab] = useState('tips');
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api.get('/tips'),
                    api.get('/common-errors'),
                    api.get('/topics')
                ]).then(([tipsData, errorsData, topicsData]) => {
                    setTips(tipsData || []);
                    setErrors(errorsData || []);
                    const topicMap = {};
                    (topicsData || []).forEach(theme => {
                        theme.topics.forEach(t => topicMap[t.id] = t);
                    });
                    setTopics(topicMap);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading study guide...</div>;

            // Group tips by type
            const examTips = tips.filter(t => t.tip_type === 'exam');
            const studyTips = tips.filter(t => t.tip_type === 'study');

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">üí° Study Guide</h2>
                    <p className="text-gray-600 mb-6">Expert tips and common mistakes to avoid</p>

                    <div className="flex gap-4 mb-6">
                        <button
                            onClick={() => setActiveTab('tips')}
                            className={`px-6 py-3 rounded-lg font-semibold transition ${activeTab === 'tips' ? 'bg-yellow-500 text-white' : 'bg-gray-200'}`}
                        >
                            üí° Tips ({tips.length})
                        </button>
                        <button
                            onClick={() => setActiveTab('errors')}
                            className={`px-6 py-3 rounded-lg font-semibold transition ${activeTab === 'errors' ? 'bg-red-500 text-white' : 'bg-gray-200'}`}
                        >
                            ‚ö†Ô∏è Common Errors ({errors.length})
                        </button>
                    </div>

                    {activeTab === 'tips' && (
                        <div className="space-y-6">
                            {examTips.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-blue-600 mb-4">üìù Exam Tips</h3>
                                    <div className="grid gap-4 md:grid-cols-2">
                                        {examTips.map(tip => (
                                            <div key={tip.id} className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                                <p className="text-gray-800">{tip.tip_text}</p>
                                                {topics[tip.topic_id] && (
                                                    <p className="text-xs text-blue-600 mt-2">
                                                        Topic {topics[tip.topic_id].topic_number}: {topics[tip.topic_id].topic_name}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {studyTips.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-yellow-600 mb-4">üìö Study Tips</h3>
                                    <div className="grid gap-4 md:grid-cols-2">
                                        {studyTips.map(tip => (
                                            <div key={tip.id} className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                                <p className="text-gray-800">{tip.tip_text}</p>
                                                {topics[tip.topic_id] && (
                                                    <p className="text-xs text-yellow-600 mt-2">
                                                        Topic {topics[tip.topic_id].topic_number}: {topics[tip.topic_id].topic_name}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'errors' && (
                        <div className="space-y-4">
                            {errors.map(error => (
                                <div key={error.id} className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="bg-red-100 p-4 border-l-4 border-red-500">
                                        <h4 className="font-bold text-red-800">‚ùå Common Error:</h4>
                                        <p className="text-red-700 italic">"{error.error_statement}"</p>
                                    </div>
                                    <div className="p-4 bg-green-50 border-l-4 border-green-500">
                                        <h4 className="font-bold text-green-800">‚úÖ Why it's wrong:</h4>
                                        <p className="text-gray-700">{error.explanation}</p>
                                    </div>
                                    {topics[error.topic_id] && (
                                        <div className="px-4 py-2 bg-gray-50 text-xs text-gray-500">
                                            Topic {topics[error.topic_id].topic_number}: {topics[error.topic_id].topic_name}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Sample Answers View - Learn from example answers
        function SampleAnswersView() {
            const [answers, setAnswers] = useState([]);
            const [topics, setTopics] = useState({});
            const [currentIndex, setCurrentIndex] = useState(0);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api.get('/sample-answers'),
                    api.get('/topics')
                ]).then(([answersData, topicsData]) => {
                    setAnswers(answersData || []);
                    const topicMap = {};
                    (topicsData || []).forEach(theme => {
                        theme.topics.forEach(t => topicMap[t.id] = t);
                    });
                    setTopics(topicMap);
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="text-center py-8">Loading sample answers...</div>;

            if (answers.length === 0) {
                return (
                    <div className="max-w-4xl mx-auto p-6 text-center">
                        <h2 className="text-3xl font-bold text-gray-800 mb-4">üìä Sample Answers</h2>
                        <p className="text-gray-500">No sample answers available yet.</p>
                    </div>
                );
            }

            const a = answers[currentIndex];

            return (
                <div className="max-w-4xl mx-auto p-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">üìä Sample Answers Analysis</h2>
                    <p className="text-gray-600 mb-6">Learn from real student answers and teacher feedback</p>

                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-4 flex justify-between items-center">
                            <span className="text-white font-bold">Example {currentIndex + 1} of {answers.length}</span>
                            {a.marks_awarded && a.marks_available && (
                                <span className="bg-white/20 text-white px-3 py-1 rounded-full">
                                    Score: {a.marks_awarded}/{a.marks_available}
                                </span>
                            )}
                        </div>

                        <div className="p-6 space-y-4">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-bold text-gray-700 mb-2">üìù Question:</h4>
                                <p className="text-gray-800">{a.question_context}</p>
                            </div>

                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h4 className="font-bold text-blue-700 mb-2">‚úçÔ∏è Student's Answer:</h4>
                                <p className="text-gray-800 whitespace-pre-line">{a.student_answer}</p>
                            </div>

                            <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <h4 className="font-bold text-purple-700 mb-2">üë®‚Äçüè´ Teacher's Comments:</h4>
                                <p className="text-gray-800">{a.teacher_comments}</p>
                            </div>

                            {a.strengths && (
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h4 className="font-bold text-green-700 mb-2">‚úÖ Strengths:</h4>
                                    <p className="text-gray-700">{a.strengths}</p>
                                </div>
                            )}

                            {a.improvements && (
                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <h4 className="font-bold text-orange-700 mb-2">üìà To Improve:</h4>
                                    <p className="text-gray-700">{a.improvements}</p>
                                </div>
                            )}
                        </div>

                        <div className="flex justify-between p-4 bg-gray-50">
                            <button
                                onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))}
                                disabled={currentIndex === 0}
                                className="px-4 py-2 bg-gray-200 rounded disabled:opacity-50"
                            >
                                ‚Üê Previous
                            </button>
                            <button
                                onClick={() => setCurrentIndex(Math.min(answers.length - 1, currentIndex + 1))}
                                disabled={currentIndex === answers.length - 1}
                                className="px-4 py-2 bg-purple-500 text-white rounded disabled:opacity-50"
                            >
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [currentView, setCurrentView] = useState('topics');
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [loading, setLoading] = useState(true);
            // Pre-filled data for Document Chat (from RAG modal)
            const [docChatPrefill, setDocChatPrefill] = useState(null);

            // Typing settings state
            const [typingSettings, setTypingSettings] = useState(() => {
                const saved = localStorage.getItem('typingSettings');
                return saved ? JSON.parse(saved) : {
                    enabled: true,
                    memoryDuration: 5,
                    stuckTimeout: 2,
                    soundEnabled: true,
                    ttsEnabled: true
                };
            });

            // Save typing settings to localStorage
            useEffect(() => {
                localStorage.setItem('typingSettings', JSON.stringify(typingSettings));
            }, [typingSettings]);

            useEffect(() => {
                // Check for existing session
                const token = localStorage.getItem('token');
                if (token) {
                    api.token = token;
                    api.get('/auth/me').then(userData => {
                        if (userData && !userData.error) {
                            setUser(userData);
                        }
                        setLoading(false);
                    });
                } else {
                    setLoading(false);
                }
            }, []);

            const handleLogout = async () => {
                await api.post('/auth/logout');
                api.token = null;
                localStorage.removeItem('token');
                setUser(null);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="text-center">
                            <div className="text-6xl animate-bounce">üåç</div>
                            <p className="text-gray-600 mt-4">Loading Geography Guru...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <Login onLogin={setUser} />;
            }

            const handleViewChange = (view) => {
                setSelectedTopic(null);
                setCurrentView(view);
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <Navigation
                        user={user}
                        currentView={currentView}
                        setCurrentView={handleViewChange}
                        onLogout={handleLogout}
                    />

                    <main>
                        {currentView === 'topics' && !selectedTopic && (
                            <TopicsList onSelectTopic={setSelectedTopic} />
                        )}

                        {currentView === 'topics' && selectedTopic && (
                            <TopicDetail
                                topic={selectedTopic}
                                onBack={() => setSelectedTopic(null)}
                                typingSettings={typingSettings}
                                onNavigateToDocChat={(prefillData) => {
                                    setDocChatPrefill(prefillData);
                                    setCurrentView('pdf-chat');
                                }}
                            />
                        )}

                        {currentView === 'pdf-chat' && <PDFChatView prefill={docChatPrefill} onPrefillUsed={() => setDocChatPrefill(null)} />}
                        {currentView === 'progress' && <ProgressView />}
                        {currentView === 'weak-points' && <WeakPointsView />}
                        {currentView === 'settings' && (
                            <SettingsView
                                typingSettings={typingSettings}
                                onTypingSettingsChange={setTypingSettings}
                            />
                        )}
                    </main>

                    <footer className="text-center py-6 text-gray-500 text-sm">
                        <p>IGCSE Geography Guru ‚Ä¢ Built for exam success üéì</p>
                    </footer>
                </div>
            );
        }

        // Document Chat View Component - RAG-powered chat with study guide documents
        function PDFChatView({ prefill, onPrefillUsed }) {
            const [documents, setDocuments] = useState([]);
            const [selectedDocs, setSelectedDocs] = useState([]); // Multi-doc selection (array of IDs)
            const [prefillProcessed, setPrefillProcessed] = useState(false); // Track if prefill was processed
            const [pendingAutoSubmit, setPendingAutoSubmit] = useState(false); // Track pending auto-submit
            const [viewingDoc, setViewingDoc] = useState(null); // For PDF viewer
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(true);
            const [uploading, setUploading] = useState(false);
            const [processing, setProcessing] = useState(false);
            const [chatLoading, setChatLoading] = useState(false);
            const [settings, setSettings] = useState(null);
            const [apiKey, setApiKey] = useState(''); // Holds '__USE_STORED_KEY__' or actual key
            const [uploadStatus, setUploadStatus] = useState(''); // Detailed upload status
            const [pdfViewerPage, setPdfViewerPage] = useState(1);
            const [showPdfViewer, setShowPdfViewer] = useState(false);
            const [pdfViewerZoom, setPdfViewerZoom] = useState(100);
            const [pdfViewerFullscreen, setPdfViewerFullscreen] = useState(false);
            const [pdfTotalPages, setPdfTotalPages] = useState(0);
            const [pdfSearchTerm, setPdfSearchTerm] = useState('');
            const [pdfSearchResults, setPdfSearchResults] = useState([]);
            const [pdfSearching, setPdfSearching] = useState(false);
            const [showPdfSearch, setShowPdfSearch] = useState(false);
            const messagesEndRef = useRef(null);
            const pdfDocRef = useRef(null); // Cache loaded PDF

            // Load documents and settings (use ai_settings for API keys - same as main Settings)
            useEffect(() => {
                Promise.all([
                    api.get('/pdf/documents'),
                    api.get('/ai/settings')
                ]).then(([docs, aiSettingsData]) => {
                    setDocuments(docs || []);
                    const settingsObj = aiSettingsData?.settings || {};
                    setSettings(settingsObj);
                    // Check if OpenAI key is validated (has masked format with dots)
                    if (settingsObj?.openai_api_key && settingsObj.openai_validated) {
                        // Key is validated in main Settings - we'll use it via server-side
                        setApiKey('__USE_STORED_KEY__');
                    }
                    setLoading(false);
                });
            }, []);

            // Auto-scroll to bottom of messages
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Clear chat when document selection changes (but not when prefill sets docs)
            useEffect(() => {
                // Only clear messages if not during prefill processing
                if (!prefillProcessed) return;
                setMessages([]);
            }, [selectedDocs]);

            // Handle prefill data from RAG modal navigation
            useEffect(() => {
                if (!prefill || !documents.length || !apiKey || prefillProcessed) return;

                // Set the selected documents from prefill
                let hasValidDocs = false;
                if (prefill.documentIds && prefill.documentIds.length > 0) {
                    // Filter to only include documents that exist and are ready
                    const validDocIds = prefill.documentIds.filter(id =>
                        documents.some(d => d.id === id && d.status === 'ready')
                    );
                    if (validDocIds.length > 0) {
                        setSelectedDocs(validDocIds);
                        hasValidDocs = true;
                    }
                }

                // Set the question in the input and flag for auto-submit
                if (prefill.question) {
                    setInput(prefill.question);
                    if (hasValidDocs) {
                        setPendingAutoSubmit(true);
                    }
                }

                // Mark prefill as processed
                setPrefillProcessed(true);

                // Clear prefill data in parent
                if (onPrefillUsed) {
                    onPrefillUsed();
                }
            }, [prefill, documents, apiKey, prefillProcessed, onPrefillUsed]);

            // Helper functions for document selection
            const toggleDocSelection = (docId) => {
                setSelectedDocs(prev =>
                    prev.includes(docId)
                        ? prev.filter(id => id !== docId)
                        : [...prev, docId]
                );
            };

            const selectAllDocs = () => {
                const readyDocs = documents.filter(d => d.status === 'ready').map(d => d.id);
                setSelectedDocs(readyDocs);
            };

            const deselectAllDocs = () => {
                setSelectedDocs([]);
            };

            const getSelectedDocsInfo = () => {
                return documents.filter(d => selectedDocs.includes(d.id));
            };

            // Supported file extensions
            const SUPPORTED_FORMATS = {
                // Documents
                'pdf': 'application/pdf',
                'txt': 'text/plain',
                'md': 'text/markdown',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'doc': 'application/msword',
                'rtf': 'application/rtf',
                'odt': 'application/vnd.oasis.opendocument.text',
                // Spreadsheets
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'xls': 'application/vnd.ms-excel',
                'csv': 'text/csv',
                'ods': 'application/vnd.oasis.opendocument.spreadsheet',
                // Presentations
                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'ppt': 'application/vnd.ms-powerpoint',
                'odp': 'application/vnd.oasis.opendocument.presentation',
                // Other
                'epub': 'application/epub+zip',
                'html': 'text/html',
                'htm': 'text/html',
                'json': 'application/json',
                'xml': 'application/xml'
            };

            const getFileExtension = (filename) => {
                return filename.split('.').pop().toLowerCase();
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const ext = getFileExtension(file.name);
                const supportedExts = Object.keys(SUPPORTED_FORMATS);

                if (!supportedExts.includes(ext)) {
                    alert(`Unsupported file format. Supported: ${supportedExts.join(', ')}`);
                    return;
                }

                if (!apiKey) {
                    alert('Please configure your OpenAI API key in the main Settings page first (go to Settings > AI Providers > OpenAI)');
                    return;
                }

                setUploading(true);
                setUploadStatus('Preparing upload...');

                try {
                    // Generate unique document ID and storage path
                    const docId = crypto.randomUUID();
                    const safeFilename = file.name.replace(/[^\w\-_.]/g, '_');
                    const storagePath = `${docId}/${safeFilename}`;

                    // Upload directly to Supabase Storage (bypasses Vercel payload limits)
                    setUploadStatus('Uploading to storage...');
                    console.log('Starting direct Supabase upload, size:', Math.round(file.size / 1024), 'KB');

                    let storageSuccess = false;
                    let storageError = null;

                    try {
                        const { data: uploadData, error: uploadError } = await supabaseClient.storage
                            .from('documents')
                            .upload(storagePath, file, {
                                cacheControl: '3600',
                                upsert: true
                            });

                        if (uploadError) {
                            console.log('Storage upload failed (non-blocking):', uploadError.message);
                            storageError = uploadError.message;
                        } else {
                            storageSuccess = true;
                            console.log('Storage upload success:', uploadData);
                        }
                    } catch (storageErr) {
                        console.log('Storage upload exception (non-blocking):', storageErr);
                        storageError = storageErr.message;
                    }

                    // Create document record via API (just metadata, no file data)
                    setUploadStatus('Creating document record...');
                    let uploadResult;
                    try {
                        uploadResult = await api.post('/pdf/create-record', {
                            id: docId,
                            filename: safeFilename,
                            original_filename: file.name,
                            storage_path: storageSuccess ? storagePath : '',
                            file_size: file.size
                        });
                        console.log('Document record created:', uploadResult);
                    } catch (recordErr) {
                        console.error('Failed to create document record:', recordErr);
                        alert('Failed to create document record: ' + (recordErr.message || 'Unknown error'));
                        setUploading(false);
                        setUploadStatus('');
                        return;
                    }

                    // Note if there was a storage warning (file storage optional)
                    if (storageError) {
                        console.log('Storage warning (non-blocking):', storageError);
                    }

                    // Extract text based on file type
                    setProcessing(true);
                    setUploadStatus('Extracting text...');
                    let pagesText = [];

                    try {
                        switch (ext) {
                            case 'pdf':
                                pagesText = await extractPdfText(file);
                                break;
                            case 'txt':
                            case 'md':
                                pagesText = await extractTxtText(file);
                                break;
                            case 'docx':
                                pagesText = await extractDocxText(file);
                                break;
                            case 'doc':
                                alert('Old .doc format may not extract perfectly. Consider converting to .docx for best results.');
                                pagesText = await extractTxtText(file);
                                break;
                            case 'rtf':
                                pagesText = await extractRtfText(file);
                                break;
                            case 'odt':
                                pagesText = await extractOdtText(file);
                                break;
                            case 'xlsx':
                            case 'xls':
                            case 'ods':
                                pagesText = await extractXlsxText(file);
                                break;
                            case 'csv':
                                pagesText = await extractCsvText(file);
                                break;
                            case 'pptx':
                                pagesText = await extractPptxText(file);
                                break;
                            case 'ppt':
                                alert('Old .ppt format may not extract perfectly. Consider converting to .pptx for best results.');
                                pagesText = await extractTxtText(file);
                                break;
                            case 'odp':
                                pagesText = await extractOdpText(file);
                                break;
                            case 'epub':
                                pagesText = await extractEpubText(file);
                                break;
                            case 'html':
                            case 'htm':
                                pagesText = await extractHtmlText(file);
                                break;
                            case 'json':
                                pagesText = await extractJsonText(file);
                                break;
                            case 'xml':
                                pagesText = await extractXmlText(file);
                                break;
                            default:
                                throw new Error('Unsupported format');
                        }
                    } catch (extractErr) {
                        alert('Error extracting text: ' + extractErr.message);
                        setUploading(false);
                        setProcessing(false);
                        setUploadStatus('');
                        return;
                    }

                    // Send to server for embedding
                    setUploadStatus(`Creating embeddings (${pagesText.length} sections)...`);
                    const processResult = await api.post('/pdf/process', {
                        document_id: docId,
                        openai_api_key: apiKey === '__USE_STORED_KEY__' ? null : apiKey,
                        use_stored_key: apiKey === '__USE_STORED_KEY__',
                        pages_text: pagesText
                    });

                    if (processResult?.success) {
                        // Refresh documents list
                        const docs = await api.get('/pdf/documents');
                        setDocuments(docs || []);
                        // Auto-select the new document
                        setSelectedDocs(prev => [...prev, docId]);
                        let successMsg = `Document processed successfully! ${processResult.chunks_created} chunks created from ${processResult.pages_processed} sections.`;
                        if (storageError) {
                            successMsg += `\n\nNote: File storage failed (${storageError}). PDF preview disabled, but RAG chat works normally.`;
                        }
                        alert(successMsg);
                    } else {
                        alert('Failed to process document: ' + (processResult?.error || 'Unknown error'));
                    }

                } catch (err) {
                    console.error('Upload error:', err);
                    alert('Error: ' + err.message);
                } finally {
                    setUploading(false);
                    setProcessing(false);
                    setUploadStatus('');
                }
            };

            // Extract text from PDF using PDF.js
            const extractPdfText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const pagesText = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const text = textContent.items.map(item => item.str).join(' ');
                    pagesText.push({ page_number: i, text });
                }

                return pagesText;
            };

            // Extract text from TXT file
            const extractTxtText = async (file) => {
                const text = await file.text();
                // Split into chunks of ~2000 chars to simulate pages
                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from DOCX using Mammoth.js
            const extractDocxText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                const text = result.value;
                // Split into chunks to simulate pages
                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from XLSX using SheetJS
            const extractXlsxText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const pagesText = [];

                workbook.SheetNames.forEach((sheetName, index) => {
                    const sheet = workbook.Sheets[sheetName];
                    const text = XLSX.utils.sheet_to_txt(sheet);
                    pagesText.push({
                        page_number: index + 1,
                        text: `Sheet: ${sheetName}\n${text}`
                    });
                });

                return pagesText;
            };

            // Extract text from PPTX using JSZip
            const extractPptxText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                // PPTX stores slides in ppt/slides/slide{n}.xml
                const slideFiles = Object.keys(zip.files)
                    .filter(name => name.match(/ppt\/slides\/slide\d+\.xml/))
                    .sort((a, b) => {
                        const numA = parseInt(a.match(/slide(\d+)/)[1]);
                        const numB = parseInt(b.match(/slide(\d+)/)[1]);
                        return numA - numB;
                    });

                for (let i = 0; i < slideFiles.length; i++) {
                    const slideXml = await zip.files[slideFiles[i]].async('text');
                    // Extract text from XML (simple regex approach)
                    const textMatches = slideXml.match(/<a:t>([^<]*)<\/a:t>/g) || [];
                    const text = textMatches
                        .map(match => match.replace(/<\/?a:t>/g, ''))
                        .join(' ');
                    pagesText.push({
                        page_number: i + 1,
                        text: `Slide ${i + 1}: ${text}`
                    });
                }

                return pagesText;
            };

            // Extract text from EPUB using JSZip
            const extractEpubText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                // Find content files (HTML/XHTML)
                const contentFiles = Object.keys(zip.files)
                    .filter(name => name.match(/\.(html|xhtml|htm)$/i))
                    .sort();

                for (let i = 0; i < contentFiles.length; i++) {
                    const html = await zip.files[contentFiles[i]].async('text');
                    // Strip HTML tags to get plain text
                    const text = html
                        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                        .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                        .replace(/<[^>]+>/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();

                    if (text.length > 50) { // Only include substantial content
                        pagesText.push({
                            page_number: pagesText.length + 1,
                            text: text
                        });
                    }
                }

                return pagesText;
            };

            // Extract text from RTF file
            const extractRtfText = async (file) => {
                const text = await file.text();
                // Basic RTF to text conversion - strip RTF control words
                const plainText = text
                    .replace(/\{\\[^{}]+\}/g, '') // Remove groups with control words
                    .replace(/\\[a-z]+\d*\s?/gi, '') // Remove control words
                    .replace(/[{}]/g, '') // Remove remaining braces
                    .replace(/\s+/g, ' ')
                    .trim();

                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < plainText.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: plainText.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from ODT (OpenDocument Text) using JSZip
            const extractOdtText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                // ODT stores content in content.xml
                if (zip.files['content.xml']) {
                    const xml = await zip.files['content.xml'].async('text');
                    // Extract text from XML
                    const text = xml
                        .replace(/<text:p[^>]*>/gi, '\n')
                        .replace(/<[^>]+>/g, '')
                        .replace(/\s+/g, ' ')
                        .trim();

                    const chunkSize = 2000;
                    for (let i = 0; i < text.length; i += chunkSize) {
                        pagesText.push({
                            page_number: Math.floor(i / chunkSize) + 1,
                            text: text.slice(i, i + chunkSize)
                        });
                    }
                }

                return pagesText;
            };

            // Extract text from CSV file
            const extractCsvText = async (file) => {
                const text = await file.text();
                // Convert CSV to readable format
                const lines = text.split('\n');
                const pagesText = [];

                // Group lines into chunks for "pages"
                const linesPerPage = 50;
                for (let i = 0; i < lines.length; i += linesPerPage) {
                    const pageLines = lines.slice(i, i + linesPerPage);
                    pagesText.push({
                        page_number: Math.floor(i / linesPerPage) + 1,
                        text: pageLines.join('\n')
                    });
                }

                return pagesText;
            };

            // Extract text from ODP (OpenDocument Presentation) using JSZip
            const extractOdpText = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const pagesText = [];

                if (zip.files['content.xml']) {
                    const xml = await zip.files['content.xml'].async('text');
                    // Extract text from draw:frame elements
                    const textMatches = xml.match(/<text:p[^>]*>([^<]*)<\/text:p>/g) || [];
                    const allText = textMatches
                        .map(match => match.replace(/<[^>]+>/g, ''))
                        .join(' ');

                    const chunkSize = 2000;
                    for (let i = 0; i < allText.length; i += chunkSize) {
                        pagesText.push({
                            page_number: Math.floor(i / chunkSize) + 1,
                            text: allText.slice(i, i + chunkSize)
                        });
                    }
                }

                return pagesText;
            };

            // Extract text from HTML file
            const extractHtmlText = async (file) => {
                const html = await file.text();
                const text = html
                    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                    .replace(/<[^>]+>/g, ' ')
                    .replace(/&nbsp;/g, ' ')
                    .replace(/&amp;/g, '&')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/\s+/g, ' ')
                    .trim();

                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            // Extract text from JSON file
            const extractJsonText = async (file) => {
                const text = await file.text();
                try {
                    const json = JSON.parse(text);
                    // Convert JSON to readable string
                    const readable = JSON.stringify(json, null, 2);

                    const chunkSize = 2000;
                    const pagesText = [];
                    for (let i = 0; i < readable.length; i += chunkSize) {
                        pagesText.push({
                            page_number: Math.floor(i / chunkSize) + 1,
                            text: readable.slice(i, i + chunkSize)
                        });
                    }
                    return pagesText;
                } catch {
                    // If not valid JSON, treat as plain text
                    return extractTxtText(file);
                }
            };

            // Extract text from XML file
            const extractXmlText = async (file) => {
                const xml = await file.text();
                // Strip XML tags to get content
                const text = xml
                    .replace(/<[^>]+>/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                const chunkSize = 2000;
                const pagesText = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    pagesText.push({
                        page_number: Math.floor(i / chunkSize) + 1,
                        text: text.slice(i, i + chunkSize)
                    });
                }
                return pagesText;
            };

            const handleSendMessage = async () => {
                if (!input.trim() || chatLoading) return;

                if (!apiKey) {
                    alert('Please configure your OpenAI API key in the main Settings page first (go to Settings > AI Providers > OpenAI)');
                    return;
                }

                if (selectedDocs.length === 0) {
                    alert('Please select at least one document to chat with');
                    return;
                }

                const question = input.trim();
                setInput('');
                setChatLoading(true);

                // Add user message immediately
                setMessages(prev => [...prev, { role: 'user', content: question }]);

                try {
                    // Use stored key from main Settings if available
                    const useStoredKey = apiKey === '__USE_STORED_KEY__';
                    const defaultProvider = settings?.default_provider || 'openai';

                    const result = await api.post('/rag/chat', {
                        question,
                        document_ids: selectedDocs, // Multi-doc support
                        openai_api_key: useStoredKey ? null : apiKey,
                        use_stored_key: useStoredKey,
                        llm_provider: defaultProvider,
                        llm_model: settings?.[`${defaultProvider}_model`] || 'gpt-4o-mini'
                    });

                    if (result?.answer) {
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: result.answer,
                            sources: result.sources
                        }]);
                    } else {
                        setMessages(prev => [...prev, {
                            role: 'assistant',
                            content: 'Sorry, I encountered an error: ' + (result?.error || 'Unknown error')
                        }]);
                    }
                } catch (err) {
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Error: ' + err.message
                    }]);
                }
                setChatLoading(false);
            };

            // Auto-submit when pendingAutoSubmit flag is set (after prefill)
            useEffect(() => {
                if (pendingAutoSubmit && input.trim() && selectedDocs.length > 0 && apiKey && !chatLoading) {
                    setPendingAutoSubmit(false);
                    handleSendMessage();
                }
            }, [pendingAutoSubmit, input, selectedDocs, apiKey, chatLoading]);

            // API settings are now managed in main Settings page
            // No local settings panel needed

            const handleDeleteDoc = async (docId) => {
                if (!confirm('Delete this document and all its embeddings?')) return;
                await api.post('/pdf/delete', { document_id: docId });
                setDocuments(prev => prev.filter(d => d.id !== docId));
                setSelectedDocs(prev => prev.filter(id => id !== docId));
                if (viewingDoc?.id === docId) {
                    setViewingDoc(null);
                }
            };

            const handleBatchDelete = async () => {
                if (selectedDocs.length === 0) {
                    alert('No documents selected');
                    return;
                }
                if (!confirm(`Delete ${selectedDocs.length} selected document(s) and all their embeddings?`)) return;

                for (const docId of selectedDocs) {
                    await api.post('/pdf/delete', { document_id: docId });
                }

                setDocuments(prev => prev.filter(d => !selectedDocs.includes(d.id)));
                setSelectedDocs([]);
                setMessages([]);
            };

            const handlePageClick = (pageNumber, doc = null) => {
                const docToView = doc || documents.find(d => selectedDocs.includes(d.id));
                if (docToView?.public_url) {
                    setViewingDoc(docToView);
                    setPdfViewerPage(pageNumber);
                    setShowPdfViewer(true);
                }
            };

            // Load PDF and get total pages when viewer opens
            useEffect(() => {
                if (!showPdfViewer || !viewingDoc?.public_url) {
                    pdfDocRef.current = null;
                    setPdfTotalPages(0);
                    setPdfSearchResults([]);
                    setPdfSearchTerm('');
                    setShowPdfSearch(false);
                    return;
                }

                const loadPdf = async () => {
                    try {
                        const pdf = await pdfjsLib.getDocument(viewingDoc.public_url).promise;
                        pdfDocRef.current = pdf;
                        setPdfTotalPages(pdf.numPages);
                    } catch (err) {
                        console.error('Failed to load PDF:', err);
                    }
                };
                loadPdf();
            }, [showPdfViewer, viewingDoc?.public_url]);

            // Search through PDF text
            const handlePdfSearch = async () => {
                if (!pdfSearchTerm.trim() || !pdfDocRef.current) return;

                setPdfSearching(true);
                setPdfSearchResults([]);

                try {
                    const pdf = pdfDocRef.current;
                    const results = [];
                    const searchLower = pdfSearchTerm.toLowerCase();

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');

                        if (pageText.toLowerCase().includes(searchLower)) {
                            // Find snippet around the match
                            const lowerText = pageText.toLowerCase();
                            const matchIdx = lowerText.indexOf(searchLower);
                            const snippetStart = Math.max(0, matchIdx - 40);
                            const snippetEnd = Math.min(pageText.length, matchIdx + pdfSearchTerm.length + 60);
                            const snippet = (snippetStart > 0 ? '...' : '') +
                                pageText.slice(snippetStart, snippetEnd) +
                                (snippetEnd < pageText.length ? '...' : '');

                            results.push({
                                page: i,
                                snippet: snippet,
                                matchCount: (pageText.toLowerCase().match(new RegExp(searchLower, 'g')) || []).length
                            });
                        }
                    }

                    setPdfSearchResults(results);
                } catch (err) {
                    console.error('Search error:', err);
                }

                setPdfSearching(false);
            };

            // Parse message content and replace page references with clickable links
            const renderMessageWithPageLinks = (content, sources = []) => {
                if (!content) return null;

                // Match patterns like "Page 133", "page 7", "Pages 15-16", "Pages 5, 10", "(Page 133)", etc.
                const pagePattern = /\(?[Pp]ages?\s*([\d]+(?:\s*[-‚Äì,]\s*\d+)*)\)?\.?/g;

                const parts = [];
                let lastIndex = 0;
                let match;

                while ((match = pagePattern.exec(content)) !== null) {
                    // Add text before the match
                    if (match.index > lastIndex) {
                        parts.push(content.slice(lastIndex, match.index));
                    }

                    // Parse page numbers from the match
                    const pageStr = match[1];
                    const pageNums = pageStr.split(/[-‚Äì,]/).map(s => parseInt(s.trim())).filter(n => !isNaN(n));

                    // Create clickable link(s)
                    pageNums.forEach((pageNum, idx) => {
                        if (idx > 0) parts.push(', ');
                        parts.push(
                            React.createElement('button', {
                                key: `page-${match.index}-${pageNum}`,
                                onClick: () => handlePageClick(pageNum),
                                className: 'text-blue-600 hover:text-blue-800 underline font-medium',
                                title: `View Page ${pageNum}`
                            }, `(P${pageNum})`)
                        );
                    });

                    lastIndex = match.index + match[0].length;
                }

                // Add remaining text
                if (lastIndex < content.length) {
                    parts.push(content.slice(lastIndex));
                }

                return parts.length > 0 ? parts : content;
            };

            if (loading) return <div className="text-center py-8">Loading Document Chat...</div>;

            // Check API key status
            const hasValidOpenAIKey = settings?.openai_api_key && settings?.openai_validated;
            const currentProvider = settings?.default_provider || 'openai';

            return (
                <div className="max-w-7xl mx-auto p-6">
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">üìÑ Document Chat</h2>
                            {hasValidOpenAIKey ? (
                                <p className="text-sm text-green-600 mt-1">
                                    ‚úì OpenAI API connected ‚Ä¢ Using {currentProvider} for responses
                                </p>
                            ) : (
                                <p className="text-sm text-red-600 mt-1">
                                    ‚ö†Ô∏è OpenAI API key not configured
                                </p>
                            )}
                        </div>
                    </div>

                    {/* API Key Status Banner */}
                    {!hasValidOpenAIKey && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                            <h3 className="font-semibold text-yellow-800 mb-2">üîë API Key Required</h3>
                            <p className="text-sm text-yellow-700 mb-3">
                                Document Chat requires an OpenAI API key for embeddings. Please configure it in the main Settings page.
                            </p>
                            <p className="text-xs text-yellow-600">
                                Go to <strong>Settings ‚Üí AI Providers ‚Üí OpenAI</strong> to add your API key.
                            </p>
                        </div>
                    )}

                    <div className="grid grid-cols-4 gap-6">
                        {/* Documents Sidebar */}
                        <div className="col-span-1 bg-white rounded-xl shadow p-4">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-semibold text-gray-700">üìÑ Documents</h3>
                                {documents.length > 0 && (
                                    <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                                        {selectedDocs.length}/{documents.length} selected
                                    </span>
                                )}
                            </div>

                            {/* Upload Button */}
                            <label className="block w-full mb-3">
                                <div className={`border-2 border-dashed rounded-lg p-3 text-center cursor-pointer transition
                                    ${uploading || processing ? 'bg-gray-100 border-gray-300' : 'border-green-300 hover:border-green-500 hover:bg-green-50'}`}>
                                    {(uploading || processing) ? (
                                        <div className="flex flex-col items-center">
                                            <div className="animate-spin text-xl mb-1">‚è≥</div>
                                            <span className="text-sm text-gray-600 font-medium">
                                                {uploadStatus || (processing ? 'Processing...' : 'Uploading...')}
                                            </span>
                                        </div>
                                    ) : (
                                        <>
                                            <span className="text-xl">üì§</span>
                                            <p className="text-sm text-gray-600">Upload Document</p>
                                            <p className="text-xs text-gray-400">20+ formats</p>
                                        </>
                                    )}
                                </div>
                                <input
                                    type="file"
                                    accept=".pdf,.txt,.md,.docx,.doc,.rtf,.odt,.xlsx,.xls,.csv,.ods,.pptx,.ppt,.odp,.epub,.html,.htm,.json,.xml"
                                    onChange={handleFileUpload}
                                    className="hidden"
                                    disabled={uploading || processing}
                                />
                            </label>

                            {/* Selection Controls */}
                            {documents.length > 0 && (
                                <div className="flex gap-1 mb-3">
                                    <button
                                        onClick={selectAllDocs}
                                        className="flex-1 text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded transition"
                                    >
                                        Select All
                                    </button>
                                    <button
                                        onClick={deselectAllDocs}
                                        className="flex-1 text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded transition"
                                    >
                                        Deselect
                                    </button>
                                    {selectedDocs.length > 0 && (
                                        <button
                                            onClick={handleBatchDelete}
                                            className="text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded transition"
                                            title="Delete selected"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    )}
                                </div>
                            )}

                            {/* Document List */}
                            <div className="space-y-2 max-h-80 overflow-y-auto">
                                {documents.length === 0 ? (
                                    <p className="text-sm text-gray-400 text-center py-4">No documents yet</p>
                                ) : (
                                    documents.map(doc => (
                                        <div
                                            key={doc.id}
                                            className={`p-2 rounded-lg transition ${
                                                selectedDocs.includes(doc.id)
                                                    ? 'bg-green-100 border-2 border-green-500'
                                                    : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                                            }`}
                                        >
                                            <div className="flex items-start gap-2">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedDocs.includes(doc.id)}
                                                    onChange={() => toggleDocSelection(doc.id)}
                                                    disabled={doc.status !== 'ready'}
                                                    className="mt-1 h-4 w-4 text-green-600 rounded focus:ring-green-500"
                                                />
                                                <div className="flex-1 min-w-0 cursor-pointer" onClick={() => {
                                                    if (doc.status === 'ready') toggleDocSelection(doc.id);
                                                }}>
                                                    <p className="font-medium text-sm truncate">{doc.original_filename}</p>
                                                    <p className="text-xs text-gray-500">
                                                        {doc.page_count || '?'} pages ‚Ä¢{' '}
                                                        <span className={doc.status === 'ready' ? 'text-green-600' : doc.status === 'error' ? 'text-red-600' : 'text-yellow-600'}>
                                                            {doc.status}
                                                        </span>
                                                    </p>
                                                </div>
                                                <div className="flex flex-col gap-1">
                                                    {doc.public_url && (
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); setViewingDoc(doc); setPdfViewerPage(1); setShowPdfViewer(true); }}
                                                            className="text-blue-400 hover:text-blue-600 text-sm"
                                                            title="View document"
                                                        >
                                                            üìñ
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); handleDeleteDoc(doc.id); }}
                                                        className="text-red-400 hover:text-red-600 text-sm"
                                                        title="Delete"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Chat Area */}
                        <div className="col-span-3 bg-white rounded-xl shadow flex flex-col" style={{ height: '600px' }}>
                            {/* Chat Header */}
                            <div className="p-4 border-b flex items-center justify-between">
                                <div>
                                    <h3 className="font-semibold text-gray-700">
                                        {selectedDocs.length === 0
                                            ? 'Select document(s) to chat'
                                            : selectedDocs.length === 1
                                                ? `Chatting with: ${documents.find(d => d.id === selectedDocs[0])?.original_filename || 'document'}`
                                                : `Chatting with ${selectedDocs.length} documents`}
                                    </h3>
                                    {selectedDocs.length > 0 && (
                                        <p className="text-xs text-gray-500">
                                            {selectedDocs.length === 1
                                                ? 'Ask questions about your study guide'
                                                : 'Ask questions across all selected documents'}
                                        </p>
                                    )}
                                </div>
                                {selectedDocs.length === 1 && documents.find(d => d.id === selectedDocs[0])?.public_url && (
                                    <button
                                        onClick={() => {
                                            const doc = documents.find(d => d.id === selectedDocs[0]);
                                            setViewingDoc(doc);
                                            setPdfViewerPage(1);
                                            setShowPdfViewer(true);
                                        }}
                                        className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200"
                                    >
                                        üìñ View Document
                                    </button>
                                )}
                            </div>

                            {/* Messages */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                {messages.length === 0 ? (
                                    <div className="text-center text-gray-400 py-12">
                                        <span className="text-4xl">üí¨</span>
                                        <p className="mt-2">
                                            {selectedDocs.length > 0
                                                ? 'Ask a question about your document(s)'
                                                : 'Upload and select document(s) to start chatting'}
                                        </p>
                                    </div>
                                ) : (
                                    messages.map((msg, i) => (
                                        <div
                                            key={i}
                                            className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                        >
                                            <div className={`max-w-3xl rounded-xl p-4 ${
                                                msg.role === 'user'
                                                    ? 'bg-green-500 text-white'
                                                    : 'bg-gray-100 text-gray-800'
                                            }`}>
                                                <p className="whitespace-pre-wrap">
                                                    {msg.role === 'assistant'
                                                        ? renderMessageWithPageLinks(msg.content, msg.sources)
                                                        : msg.content}
                                                </p>

                                                {/* Source citations */}
                                                {msg.sources?.length > 0 && (
                                                    <div className="mt-3 pt-2 border-t border-gray-200">
                                                        <p className="text-xs font-medium text-gray-500 mb-1">Sources:</p>
                                                        <div className="flex flex-wrap gap-1">
                                                            {/* Group by document for multi-doc, or just show pages for single doc */}
                                                            {selectedDocs.length > 1 ? (
                                                                // Multi-doc: show document name + page
                                                                msg.sources.map((s, idx) => {
                                                                    const doc = documents.find(d => d.id === s.document_id);
                                                                    return (
                                                                        <button
                                                                            key={idx}
                                                                            onClick={() => {
                                                                                if (doc) {
                                                                                    setViewingDoc(doc);
                                                                                    setPdfViewerPage(s.page_number);
                                                                                    setShowPdfViewer(true);
                                                                                }
                                                                            }}
                                                                            className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200"
                                                                            title={s.document_name || 'Document'}
                                                                        >
                                                                            {(s.document_name || 'Doc').substring(0, 15)}... p.{s.page_number}
                                                                        </button>
                                                                    );
                                                                })
                                                            ) : (
                                                                // Single doc: just show page numbers
                                                                [...new Set(msg.sources.map(s => s.page_number))].map(page => (
                                                                    <button
                                                                        key={page}
                                                                        onClick={() => handlePageClick(page)}
                                                                        className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200"
                                                                    >
                                                                        Page {page}
                                                                    </button>
                                                                ))
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                                {chatLoading && (
                                    <div className="flex justify-start">
                                        <div className="bg-gray-100 rounded-xl p-4">
                                            <span className="animate-pulse">Thinking...</span>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Input Area */}
                            <div className="p-4 border-t">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        placeholder={selectedDocs.length > 0 ? "Ask about your study guide..." : "Select document(s) first"}
                                        disabled={selectedDocs.length === 0 || chatLoading}
                                        className="flex-1 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                                    />
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={selectedDocs.length === 0 || !input.trim() || chatLoading}
                                        className="px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Document Viewer Modal */}
                    {showPdfViewer && viewingDoc?.public_url && (
                        <div className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 ${pdfViewerFullscreen ? 'p-0' : 'p-4'}`}>
                            <div className={`bg-white flex flex-col ${pdfViewerFullscreen ? 'w-full h-full' : 'rounded-xl w-11/12 h-5/6 max-w-6xl'}`}>
                                <div className="p-3 border-b flex items-center justify-between gap-2 flex-wrap">
                                    <h3 className="font-semibold text-sm truncate max-w-xs">{viewingDoc.original_filename}</h3>
                                    <div className="flex items-center gap-2 flex-wrap">
                                        {/* Page Navigation */}
                                        <div className="flex items-center gap-1 bg-gray-100 rounded px-2 py-1">
                                            <button
                                                onClick={() => setPdfViewerPage(Math.max(1, pdfViewerPage - 1))}
                                                className="px-2 hover:bg-gray-200 rounded"
                                                disabled={pdfViewerPage <= 1}
                                            >‚Üê</button>
                                            <span className="text-sm min-w-[80px] text-center">
                                                Page {pdfViewerPage}{pdfTotalPages > 0 ? ` / ${pdfTotalPages}` : ''}
                                            </span>
                                            <button
                                                onClick={() => setPdfViewerPage(Math.min(pdfTotalPages || 999, pdfViewerPage + 1))}
                                                className="px-2 hover:bg-gray-200 rounded"
                                                disabled={pdfTotalPages > 0 && pdfViewerPage >= pdfTotalPages}
                                            >‚Üí</button>
                                        </div>
                                        {/* Zoom Controls */}
                                        <div className="flex items-center gap-1 bg-gray-100 rounded px-2 py-1">
                                            <button
                                                onClick={() => setPdfViewerZoom(Math.max(50, pdfViewerZoom - 25))}
                                                className="px-2 hover:bg-gray-200 rounded"
                                                title="Zoom Out"
                                            >‚àí</button>
                                            <span className="text-sm min-w-[50px] text-center">{pdfViewerZoom}%</span>
                                            <button
                                                onClick={() => setPdfViewerZoom(Math.min(200, pdfViewerZoom + 25))}
                                                className="px-2 hover:bg-gray-200 rounded"
                                                title="Zoom In"
                                            >+</button>
                                        </div>
                                        {/* Search Toggle */}
                                        <button
                                            onClick={() => setShowPdfSearch(!showPdfSearch)}
                                            className={`px-3 py-1 rounded text-sm ${showPdfSearch ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`}
                                            title="Search in document"
                                        >üîç Search</button>
                                        {/* Fullscreen Toggle */}
                                        <button
                                            onClick={() => setPdfViewerFullscreen(!pdfViewerFullscreen)}
                                            className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 text-sm"
                                            title={pdfViewerFullscreen ? "Exit Fullscreen" : "Fullscreen"}
                                        >{pdfViewerFullscreen ? '‚äô' : '‚õ∂'}</button>
                                        {/* Close */}
                                        <button
                                            onClick={() => { setShowPdfViewer(false); setPdfViewerFullscreen(false); }}
                                            className="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm"
                                        >‚úï</button>
                                    </div>
                                </div>

                                {/* Search Panel */}
                                {showPdfSearch && (
                                    <div className="p-3 border-b bg-blue-50">
                                        <div className="flex gap-2 mb-2">
                                            <input
                                                type="text"
                                                value={pdfSearchTerm}
                                                onChange={(e) => setPdfSearchTerm(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && handlePdfSearch()}
                                                placeholder="Type text to search..."
                                                className="flex-1 px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                autoFocus
                                            />
                                            <button
                                                onClick={handlePdfSearch}
                                                disabled={pdfSearching || !pdfSearchTerm.trim()}
                                                className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 text-sm"
                                            >
                                                {pdfSearching ? 'Searching...' : 'Find'}
                                            </button>
                                        </div>
                                        {/* Search Results */}
                                        {pdfSearchResults.length > 0 && (
                                            <div className="max-h-40 overflow-y-auto bg-white rounded border">
                                                <div className="p-2 text-xs text-gray-500 border-b bg-gray-50">
                                                    Found on {pdfSearchResults.length} page(s)
                                                </div>
                                                {pdfSearchResults.map((result, idx) => (
                                                    <div
                                                        key={idx}
                                                        onClick={() => { setPdfViewerPage(result.page); }}
                                                        className={`p-2 cursor-pointer hover:bg-blue-50 border-b text-sm ${pdfViewerPage === result.page ? 'bg-blue-100' : ''}`}
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span className="font-medium text-blue-600">Page {result.page}</span>
                                                            <span className="text-xs text-gray-400">{result.matchCount} match(es)</span>
                                                        </div>
                                                        <div className="text-xs text-gray-600 mt-1 truncate">{result.snippet}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        {pdfSearchResults.length === 0 && pdfSearchTerm && !pdfSearching && (
                                            <div className="text-sm text-gray-500 text-center py-2">
                                                No results found for "{pdfSearchTerm}"
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="flex-1 overflow-auto p-2 bg-gray-100">
                                    <div style={{ transform: `scale(${pdfViewerZoom / 100})`, transformOrigin: 'top center', transition: 'transform 0.2s' }}>
                                        <iframe
                                            src={`${viewingDoc.public_url}#page=${pdfViewerPage}`}
                                            className="w-full border rounded bg-white"
                                            style={{ height: '100vh', minHeight: '600px' }}
                                            title="Document Viewer"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
